<!DOCTYPE html>
<html xml:lang="ca-ES" lang="ca-ES" xmlns="http://www.w3.org/1999/xhtml">
<head>

	<title>Contenidors Kubernetes</title>
		<meta charset="UTF-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<link rel="shortcut icon" type="image/x-icon" href="/img/favicon.ico" />
	<link href="/css/master.min.css" rel="stylesheet" type="text/css" />
	<link href="/css/canigo.css" rel="stylesheet" type="text/css" />
	<script src="/js/jquery.min.js" type="text/javascript"></script>

	<script>
		document.write("<meta name=\"titol\" content=\"Contenidors Kubernetes\" />");
		document.write("<meta name=\"description\" content=\"Consideracions i exemples respecte els contenidors a Kubernetes\" />");
	</script>

	

</head>
<body class="single">
	<div class="contenidor unfixed">

				

		<header class="fons_header navbar navbar-default z-index-menu">
			<div class="container" role="menu">
				<div class="row clearfix menuNav">
					<div class="col-md-3 col-xs-3 column visible-xs coloca ">
						<button type="button" onclick="amunt();" title="Menu"
							class="navbar-toggle pull-left" data-toggle="collapse"
							data-target=".navbar-collapse">
							<span class="sr-only">Toggle navigation</span> <span
								class="icon-bar"></span> <span class="icon-bar"></span> <span
								class="icon-bar"></span>
						</button>
					</div>

					<div class="col-md-3 col-xs-6 col-offset-2 column visible-xs titol-mobil">
						
						<span class="white titol-mobil-destacat">canigo.ctti</span><span class="white">.gencat.cat</span>
					</div>

					<div class="col-md-3 col-xs-3 column visible-xs coloca1">
						<button onclick="amunt();" type="button" title="Cerca"
							class="ico_cerca " data-toggle="collapse" data-target=".dos">
						</button>
					</div>

				</div>

				<div class="collapse dos">
					<div class="shadowBox">
						<form class="navbar-form navbar-left primer" action="/cercador/" method="get"
 						onsubmit="location.href=this.action+'?q='+this.cerca_cap.value; return false;">
							<div class="form-group">
								<input type="search" class="form-control" name="q" id="cerca_cap"
									title="Cerca"
									placeholder="Cerca" />
								<button type="button" title="Neteja" class="btn btn-default"></button>
								<input type="submit" class="ocult" name="Cerca" value="Cerca" />
							</div>
						</form>
					</div>
				</div>	

				<nav class="collapse navbar-collapse navbar-ex1-collapse ">
				
					<div class="row">
						<div class="col-md-6 col-sm-4 column">
							<a class="img-responsive logo" title="Generalitat de Catalunya"
								href="https://ctti.gencat.cat/">gencat.cat</a>
							<button class="menu_tancar visible-xs collapsed"
								data-target=".navbar-collapse" data-toggle="collapse"
								title="Tancar"></button>
						</div>

						<div class="col-md-6 col-sm-8 column hidden-xs hidden-mg">
							<form class="navbar-form cercador_vermell hidden-xs pull-right" action="/cercador/"  method="get" onsubmit="location.href=this.action+'?q='+this.cerca2.value; return false;">
								<div class="form-group">
									<label class="hidden" for="cerca2">Cerca</label>
									<input id="cerca2" class="form-control" type="search" 
									placeholder="Cerca" name="q" title="Cerca">
									<input class="btn btn-default" type="submit" title="Cerca" value="">
								</div>
							</form>

							

						</div>

					</div>
					<div class="col-xs-12 hidden-xs" id="nomPortal">
                    	<span class="titol-cap-nou">Centre de Telecomunicacions i Tecnologies de la Informació</span>
                    </div>					
					<ul class="nav navbar-nav">

			        	

						<li>
							<a class="dropdown-toggle" href='/' data-toggle='_dropdown'>Inici</a>
						</li>

						

						<li>
							<a class="dropdown-toggle" href='/arqctti' data-toggle='_dropdown'>Arquitectura CTTI</a>
						</li>

						

						<li>
							<a class="dropdown-toggle" href='/blog' data-toggle='_dropdown'>Blog</a>
						</li>

						

						<li>
							<a class="dropdown-toggle" href='/cloud' data-toggle='_dropdown'>Cloud</a>
						</li>

						

						<li>
							<a class="dropdown-toggle" href='/canigo' data-toggle='_dropdown'>Canigó</a>
						</li>

						

						<li>
							<a class="dropdown-toggle" href='/sic' data-toggle='_dropdown'>SIC</a>
						</li>

						

						<li>
							<a class="dropdown-toggle" href='/sgde' data-toggle='_dropdown'>SGDE</a>
						</li>

						

						<li>
							<a class="dropdown-toggle" href='/gicar' data-toggle='_dropdown'>GICAR</a>
						</li>

						

						<li>
							<a class="dropdown-toggle" href='/cs' data-toggle='_dropdown'>Centres de Suport</a>
						</li>

						

						<li>
							<a class="dropdown-toggle" href='/dadesref' data-toggle='_dropdown'>Gestió Tècnica de Dades</a>
						</li>

						

						<li>
							<a class="dropdown-toggle" href='/eventhub' data-toggle='_dropdown'>EventHub</a>
						</li>

						

					</ul>

				</nav>
			</div>
		</header>



	</div>

	<section class="border-start">

						
			

			<article class="bgGrey">
				<div class="container">
					<div class="row">
						<div class="capcelera_basica col-sm-12">
							<div class="capcelera_basica_cont">
								<ol class="breadcrumb filariana hidden-xs">
									<li>
										<a href="/">Inici</a>
									</li>
									<li class="breadcrumbs2">
									
										<a href="/cloud-caas">
											




























										</a>
										




























































































									
									</li>

								</ol>

								<h1 class="capcelera_flotant pull-left" data-txt=".title">
									

										
											




	Contenidors Kubernetes


										

									
								</h1>

								

								
								

								

								

							</div>
						</div>

					</div>
				</div>
			</article>

			


		   <div class="padding-xs container">
	    	
	    	   <i><b>Darrera actualització:</b></i> 16-12-2021
	        
           </div>
           
			<article class="padding-xs padding-sm padding-md contingut">				
				<div class="container">
 		
					
				

	


					

						

<h2 id="introducció">Introducció</h2>

<p>Kubernetes és un orquestrador desenvolupat inicialment per Google. Sembla que actualment és l&rsquo;orquestrador que presenta més futur. Recentment ha rebut el suport oficial de Docker.</p>

<p>En aquest article es defineix l&rsquo;arquitectura tipus d&rsquo;una aplicació a Kubernetes i es proporcionen diversos exemples.</p>

<p>A la Generalitat de Catalunya, actualment, Kubernetes està disponible a les següents plataformes:</p>

<ul>
<li>IBMCloud al cloud públic. <strong>Versió Kubernetes 1.19.8. Versió containerd 1.4.3</strong></li>
<li>IBM CaaS al cloud privat. <strong>Versió Kubernetes 1.18.10. Versió docker 19.3.13</strong></li>
<li>CPD1 KuberMe al entorn consolidables. <strong>Versió Kubernetes 1.18.4. Versió docker 19.3.13</strong></li>
</ul>

<h2 id="imatges">Imatges</h2>

<p>A l&rsquo;hora de construir les imatges docker, cal tenir present els criteris definits per la Generalitat de Catalunya i que Openshift, tot i que està basat en docker, té les seves particularitats.</p>

<p>A la plana <a href="https://canigo.ctti.gencat.cat/cloud-caas/dockerImages/">Criteris creació contenidors docker</a> podeu trobar més informació al respecte.</p>

<h2 id="arquitectura">Arquitectura</h2>

<h3 id="conceptes-bàsics">Conceptes bàsics</h3>

<p>L&rsquo;arquitectura bàsica d&rsquo;una aplicació a Openshift és bàsicament la mateixa que la de Kubernetes, però amb algunes petites particularitats.
A grans trets es poden distingir els següents components:</p>

<ul>
<li><strong>Enrutador:</strong> És el punt d&rsquo;entrada i sortida del tràfic http/https de la plataforma i l&rsquo;exterior. És responsable d&rsquo;enrutar el tràfic a cada contenidor concret.</li>
<li><strong>Ruta:</strong> És l&rsquo;element de configuració on és defineix quin domini correspondrà a un Servei. Permet també la configuració del SSL. Informa a l&rsquo;enrutador per a que aquest pugui redirigir el tràfic correctament.</li>
<li><strong>Servei:</strong> És l&rsquo;element de configuració que permet exposar un servei basat en contenidors dins de la plataforma Openshift. Permet mapping de ports</li>

<li><p><strong>Desplegament:</strong> És l&rsquo;element de configuració que defineix com es desplegaran els contenidors:</p>

<ul>
<li>Nombre de rèpliques</li>
<li>Imatge a desplegar</li>
<li>Polítiques de recàrrega</li>
<li>Quotes</li>
<li>Variables d&rsquo;entorn</li>
<li>Ports</li>
<li>Emmagatzematge lògic</li>
<li>Health checks</li>
<li>&hellip;</li>
</ul></li>

<li><p><strong>Controlador:</strong> És el component responsable de mantenir els contenidors sempre disponibles seguint els paràmetres configurats al Desplegament.</p></li>

<li><p><strong>Pod:</strong> És el conjunt de contenidors que tenen el mateix cicle de vida i és necessari desplegar sempre conjuntament.</p></li>

<li><p><strong>Contenidor:</strong> És el component mínim de la plataforma. És el contenidor docker.</p></li>

<li><p><strong>Petició d&rsquo;emmagatzematge:</strong> S&rsquo;utilitza quan és necessari emmagatzematge persistent. És l&rsquo;element de configuració que actua de pont entre l&rsquo;emmagatzematge físic i l&rsquo;emmagatzematge lògic.</p></li>

<li><p><strong>Emmagatzematge:</strong> És l&rsquo;element de configuració responsable de definir l&rsquo;emmagatzematge físic.</p></li>

<li><p><strong>Secret:</strong> És l&rsquo;element de configuració responsable de gestionar els elements de configuració amb informació sensible, com poden ser contrasenyes.</p></li>

<li><p><strong>Mapa de configuració:</strong> Permet agrupar múltiples variables de configuració. Seria equivalent a un fitxer de propietats en una aplicació.</p></li>
</ul>

<h3 id="arquitectura-kubernetes">Arquitectura Kubernetes</h3>

<p>A continuació es realitza la correlació entre els diferents components arquitectònics i els elements concrets a Kubernetes.</p>

<table>
<thead>
<tr>
<th align="left">Component genèric</th>
<th align="left">Component Kubernetes</th>
<th align="left">Observacions</th>
</tr>
</thead>

<tbody>
<tr>
<td align="left">Enrutador</td>
<td align="left">Router</td>
<td align="left">És gestionat per l&rsquo;administrador de la plataforma. A nivell d&rsquo;aplicació no és necessari configurar res.</td>
</tr>

<tr>
<td align="left">Ruta</td>
<td align="left">Ingress</td>
<td align="left">A nivell d&rsquo;aplicació cal definir un fitxer yaml de configuració.</td>
</tr>

<tr>
<td align="left">Servei</td>
<td align="left">Service</td>
<td align="left">A nivell d&rsquo;aplicació cal definir un fitxer yaml de configuració.</td>
</tr>

<tr>
<td align="left">Desplegament</td>
<td align="left">Deployment</td>
<td align="left">A nivell d&rsquo;aplicació cal definir un fitxer yaml de configuració.</td>
</tr>

<tr>
<td align="left">Controlador</td>
<td align="left">ReplicaSet</td>
<td align="left">És generat directament pel Deployment. No és necessari configurar res.</td>
</tr>

<tr>
<td align="left">Pod</td>
<td align="left">Pod</td>
<td align="left">És generat directament pel ReplicationController. No és necessari configurar res.</td>
</tr>

<tr>
<td align="left">Contenidor</td>
<td align="left">Container</td>
<td align="left">És generat directament pel Pod. No és necessari configurar res.</td>
</tr>

<tr>
<td align="left">Petició d&rsquo;emmagatzematge</td>
<td align="left">PersistentVolumeClaim</td>
<td align="left">A nivell d&rsquo;aplicació cal definir un fitxer yaml de configuració.</td>
</tr>

<tr>
<td align="left">Emmagatzematge</td>
<td align="left">PersistentVolume</td>
<td align="left">És gestionat per l&rsquo;administrador de la plataforma. A nivell d&rsquo;aplicació no és necessari configurar res. Cal fer una petició al fer la sol·licitut inicial de recursos.</td>
</tr>

<tr>
<td align="left">Secret</td>
<td align="left">Secret</td>
<td align="left">A nivell d&rsquo;aplicació cal definir un fitxer yaml de configuració.</td>
</tr>

<tr>
<td align="left">Mapa de configuració</td>
<td align="left">ConfigMap</td>
<td align="left">A nivell d&rsquo;aplicació cal definir un fitxer yaml de configuració.</td>
</tr>
</tbody>
</table>

<p><img src="/related/cloud/ArquitecturaKubernetes.png" alt="Components Kubernetes" /></p>

<h2 id="informació-necessària-al-crear-l-aplicació">Informació necessària al crear l&rsquo;aplicació</h2>

<p>Quan és sol·licita la creació d&rsquo;una aplicació a Kubernetes és necessària la següent informació:</p>

<ul>
<li><strong>Unitats i mida de discos persistents</strong> necessaris. Amb aquesta informació l&rsquo;administrador de la plataforma crearà els PersistentVolume necessaris i farà arribar als responsables de l&rsquo;aplicació el nom d&rsquo;aquests Volums.</li>
<li><strong>Memòria RAM</strong> total necessària per tots els contenidors de l&rsquo;aplicació. Amb aquesta informació s&rsquo;assignarà una CPU proporcional i es definiran les quotes globals de l&rsquo;aplicació.</li>
</ul>

<h2 id="exemples">Exemples</h2>

<h3 id="persistentvolumeclaim">PersistentVolumeClaim</h3>

<p>En una aplicació el primer element que cal configurar és el PersistentVolumeClaim. Mapejarà PersistentVolume amb el volumes lògics que s&rsquo;utilitzaran als pods.</p>

<p>Configuració de l&rsquo;exemple:</p>

<ul>
<li>Namespace del projecte: <strong>XXXX-app1-data01-pre</strong></li>
<li>Nom del volum lògic: <strong>XXXX-app1-data01-claim</strong></li>
<li>Mida del disc: <strong>20Gb</strong></li>
</ul>

<pre><code>apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: XXXX-app1-data01-claim
  namespace: XXXX-app1-pre
spec:
  accessModes:
  - ReadWriteMany
  resources:
    requests:
      storage: 20Gi
</code></pre>

<h3 id="deployment">Deployment</h3>

<p>El Deployment és el principal element de configuració de l&rsquo;aplicació.</p>

<p>Configuració de l&rsquo;exemple:</p>

<ul>
<li>Namespace del projecte: <strong>XXXX-app1-data01-pre</strong></li>
<li>Nom de l&rsquo;aplicació: <strong>XXXX-app1-server</strong></li>
<li>Nom del deployment: <strong>XXXX-app1-server-deployment</strong></li>
<li>Nombre de rèpliques: <strong>2</strong></li>
<li><strong>El pod conté un únic contenidor</strong>.</li>
<li>Estratègia de desplegament: <strong>RollingUpdate</strong>. No es recomana modificar, ni variar els seus paràmetres.</li>
<li>Quotes: <strong>100 milicores de CPU</strong> i <strong>1024Mb de RAM</strong></li>
<li>Nom de la imatge dels contenidors: <strong>XXXX-app1-pre/XXXX-app1-server:1.0.0</strong></li>
<li>Variables d&rsquo;entorn dels contenidors:

<ul>
<li><strong>ENV1_NAME</strong> amb valor <strong>env1_value</strong></li>
<li><strong>ENV2_NAME</strong> amb valor <strong>env2_value</strong></li>
</ul></li>
<li>Port del contenidor: <strong>8080</strong></li>
<li><strong>readinessProbe</strong> per identificar quan es pot començar a enviar peticions al contenidor.</li>
<li><strong>livenessProbe</strong> per identificar quan cal reiniciar el contenidor.</li>
<li>Volum persistit: dins del contenidor es monta a <strong>/data</strong>. Fà referència al PersistentVolumeClaim anomenat <strong>XXXX-app1-data01-claim</strong> (creat a l&rsquo;exemple anterior)</li>
<li>Nom del defaultToken: <strong>default-token-rwj8z</strong></li>
</ul>

<pre><code>apiVersion: apps/v1
kind: Deployment
metadata:
  name: XXXX-app1-server-deployment
  namespace: XXXX-app1-data01-pre
  labels:
    app: XXXX-app1-server
spec:
  replicas: 2
  selector:
    matchLabels:
      app: XXXX-app1-server
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 25%
      maxUnavailable: 25%
  minReadySeconds: 0
  revisionHistoryLimit: 3
  template:
    metadata:
      labels:
        app: XXXX-app1-server
    spec:
      containers:
      - name: XXXX-app1-server
        image: XXXX-app1-pre/XXXX-app1-server:1.0.0
        resources:
          limits:
            cpu: 100m
            memory: 1024Mi
          requests:
            cpu: 100m
            memory: 1024Mi
        imagePullPolicy: Always
        env:
        - name: ENV1_NAME
          value: env1_value
        - name: ENV2_NAME
          value: env2_value
        ports:
        - containerPort: 8080
        readinessProbe:
          tcpSocket:
            port: 8080
          initialDelaySeconds: 5
          periodSeconds: 10
        livenessProbe:
          httpGet:
            path: /healthz
            port: 8080
            httpHeaders:
            - name: X-Custom-Header
              value: Awesome
          initialDelaySeconds: 3
          periodSeconds: 3
        volumeMounts:
        - mountPath: /data
          name: XXXX-app1-server
        - mountPath: /var/run/secrets/kubernetes.io/serviceaccount
          name: default-token-rwj8z
          readOnly: true
      imagePullSecrets:
        - name: uk-docker-registry-secret
      volumes:
      - name: *XXXX-app1-server
        persistentVolumeClaim:
          claimName: XXXX-app1-data01-claim
      - name: default-token-rwj8z
        secret:
          defaultMode: 420
          secretName: default-token-rwj8z
</code></pre>

<h3 id="service">Service</h3>

<p>A l&rsquo;exemple es crea un servei per el DeploymentConfig creat anteriorment.</p>

<p>Kubernetes suporta tant serveis amb protocol HTTP/HTTPS com  serveis amb altres tipus de protocols, com per exemple SSH, JDBC, &hellip;</p>

<h4 id="servei-http">Servei HTTP</h4>

<p>L&rsquo;aplicació exposa un servei HTTP a través de la IP de l&rsquo;Ingress.
Configuració de l&rsquo;exemple:</p>

<ul>
<li>Port exposat per servei: <strong>80</strong></li>
<li>Port intern dels pods: <strong>8080</strong></li>
</ul>

<pre><code>apiVersion: v1
kind: Service
metadata:
  name: XXXX-app1-server
  namespace: XXXX-app1-data01-pre
  labels:
    name: XXXX-app1-server
spec:
  ports:
  - protocol: TCP
    port: 80
    targetPort: 8080
  type: ClusterIP
  selector:
    app: XXXX-app1-server

</code></pre>

<h4 id="servei-no-http">Servei No HTTP</h4>

<p>L&rsquo;aplicació exposa un servei no HTTP a través d&rsquo;una IP pròpia.
Configuració de l&rsquo;exemple:</p>

<ul>
<li>Port exposat per servei: <strong>3030</strong></li>
<li>Port intern dels pods: <strong>3731</strong></li>
<li>IP on s&rsquo;exposa el servei: <strong>169.45.10.144</strong></li>
</ul>

<pre><code>apiVersion: v1
kind: Service
metadata:
  labels:
    name: XXXX-app1-server
  name: XXXX-app1-data01-pre
  namespace:  XXXX-app1-server
spec:
  ports:
  - protocol: TCP
    port: 3030
    targetPort: 3731
  selector:
    app: XXXX-app1-server
  type: LoadBalancer
  loadBalancerIP: 169.45.10.144
</code></pre>

<h3 id="ingress">Ingress</h3>

<p>A l&rsquo;exemple es crea una ruta pel servei creat anteriorment.</p>

<p>Configuració de l&rsquo;exemple:</p>

<ul>
<li>host: <strong>app1-server.gencat.cat</strong></li>
</ul>

<pre><code>apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: app1-route
  namespace: XXXX-app1-pre
spec:
  rules:
  - host: app1-server.gencat.cat
    http:
      paths:
      - path: /
        backend:
          serviceName: XXXX-app1-server
          servicePort: 80
</code></pre>

<h2 id="informació-relacionada">Informació relacionada</h2>

<ul>
<li><a href="https://v1-18.docs.kubernetes.io/es/docs/home/">https://v1-18.docs.kubernetes.io/es/docs/home/</a></li>
<li><a href="https://v1-19.docs.kubernetes.io/es/docs/home/">https://v1-19.docs.kubernetes.io/es/docs/home/</a></li>
</ul>


					

					
				</div>	

			</article>	


	</section>	

		<div class="fons_footer ">
		<footer class="container center-block shadowBox2">
			<div class="shadow2"></div>
			<div class="row footer_tab_ord">

				<div class="footer_tab_bot col-sm-12">
					<div class="avis_legal">

						<div id="fAvisLegal">
							<div>
								<div class="hidden-xs">
									<a href="https://www.gencat.cat"> <img
										src="/img/logo_generalitat_gris.png_679097835.png"
										width="101" height="27" alt="www.gencat.cat"
										/></a>
									<p>
										<a title="Avis legal" href="https://web.gencat.cat/ca/menu-ajuda/ajuda/avis_legal/" target="_self">Avís legal</a>: La &copy; Generalitat de Catalunya permet la reutilització dels continguts i de les dades sempre que se citi la font i la data d'actualització, que no es desnaturalitzi la informació i que no es contradigui amb una llicència específica.
									</p>
								</div>
								<div class="visible-xs avis_legal">
									<p>
										<a title="Avis legal" href="https://web.gencat.cat/ca/menu-ajuda/ajuda/avis_legal/" target="_self">Avís legal</a>: La &copy; Generalitat de Catalunya permet la reutilització dels continguts i de les dades sempre que se citi la font i la data d'actualització, que no es desnaturalitzi la informació i que no es contradigui amb una llicència específica.
									</p>
								</div>
								
								<div class="fi_peu visible-xs">
									<a title="www.gencat.cat" href="https://www.gencat.cat"> <img
										src="/img/logo_generalitat_gris.png_679097835.png"
										width="101" height="27" 
										alt="www.gencat.cat" /></a> <a class="torna_amunt pull-right"
										href=" javascript:tornarAmunt();" title="Torna amunt">
										<p>Torna amunt</p>
									</a>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</footer>
	</div>

<script src="/js/master.min.js" type="text/javascript"></script>
<script src="https://cdn.jsdelivr.net/algoliasearch/3/algoliasearch.min.js"></script>
<script src="https://cdn.jsdelivr.net/autocomplete.js/0/autocomplete.min.js"></script>
<script src="/js/custom.js" type="text/javascript"></script>



<script type="text/javascript">

if(location.hostname!=="localhost"){

	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

	ga('create', "UA-59408075-1", 'auto');
	ga('send', 'pageview', {
	  	'page': location.pathname + location.search  + location.hash
	  }
	);

}

</script>




</body>
</html>
