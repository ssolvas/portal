<!DOCTYPE html>
<html xml:lang="ca-ES" lang="ca-ES" xmlns="http://www.w3.org/1999/xhtml">
<head>

	<title>Criteris creació contenidors docker</title>
		<meta charset="UTF-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<link rel="shortcut icon" type="image/x-icon" href="/img/favicon.ico" />
	<link href="/css/master.min.css" rel="stylesheet" type="text/css" />
	<link href="/css/canigo.css" rel="stylesheet" type="text/css" />
	<script src="/js/jquery.min.js" type="text/javascript"></script>

	<script>
		document.write("<meta name=\"titol\" content=\"Criteris creació contenidors docker\" />");
		document.write("<meta name=\"description\" content=\"Criteris per crear les imatges dels contenidors docker que es desplegaran als diferents clouds públics i privats\" />");
	</script>

	

</head>
<body class="single">
	<div class="contenidor unfixed">

				

		<header class="fons_header navbar navbar-default z-index-menu">
			<div class="container" role="menu">
				<div class="row clearfix menuNav">
					<div class="col-md-3 col-xs-3 column visible-xs coloca ">
						<button type="button" onclick="amunt();" title="Menu"
							class="navbar-toggle pull-left" data-toggle="collapse"
							data-target=".navbar-collapse">
							<span class="sr-only">Toggle navigation</span> <span
								class="icon-bar"></span> <span class="icon-bar"></span> <span
								class="icon-bar"></span>
						</button>
					</div>

					<div class="col-md-3 col-xs-6 col-offset-2 column visible-xs titol-mobil">
						
						<span class="white titol-mobil-destacat">canigo.ctti</span><span class="white">.gencat.cat</span>
					</div>

					<div class="col-md-3 col-xs-3 column visible-xs coloca1">
						<button onclick="amunt();" type="button" title="Cerca"
							class="ico_cerca " data-toggle="collapse" data-target=".dos">
						</button>
					</div>

				</div>

				<div class="collapse dos">
					<div class="shadowBox">
						<form class="navbar-form navbar-left primer" action="/cercador/" method="get"
 						onsubmit="location.href=this.action+'?q='+this.cerca_cap.value; return false;">
							<div class="form-group">
								<input type="search" class="form-control" name="q" id="cerca_cap"
									title="Cerca"
									placeholder="Cerca" />
								<button type="button" title="Neteja" class="btn btn-default"></button>
								<input type="submit" class="ocult" name="Cerca" value="Cerca" />
							</div>
						</form>
					</div>
				</div>	

				<nav class="collapse navbar-collapse navbar-ex1-collapse ">
				
					<div class="row">
						<div class="col-md-6 col-sm-4 column">
							<a class="img-responsive logo" title="Generalitat de Catalunya"
								href="https://ctti.gencat.cat/">gencat.cat</a>
							<button class="menu_tancar visible-xs collapsed"
								data-target=".navbar-collapse" data-toggle="collapse"
								title="Tancar"></button>
						</div>

						<div class="col-md-6 col-sm-8 column hidden-xs hidden-mg">
							<form class="navbar-form cercador_vermell hidden-xs pull-right" action="/cercador/"  method="get" onsubmit="location.href=this.action+'?q='+this.cerca2.value; return false;">
								<div class="form-group">
									<label class="hidden" for="cerca2">Cerca</label>
									<input id="cerca2" class="form-control" type="search" 
									placeholder="Cerca" name="q" title="Cerca">
									<input class="btn btn-default" type="submit" title="Cerca" value="">
								</div>
							</form>

							

						</div>

					</div>
					<div class="col-xs-12 hidden-xs" id="nomPortal">
                    	<span class="titol-cap-nou">Centre de Telecomunicacions i Tecnologies de la Informació</span>
                    </div>					
					<ul class="nav navbar-nav">

			        	

						<li>
							<a class="dropdown-toggle" href='/' data-toggle='_dropdown'>Inici</a>
						</li>

						

						<li>
							<a class="dropdown-toggle" href='/arqctti' data-toggle='_dropdown'>Arquitectura CTTI</a>
						</li>

						

						<li>
							<a class="dropdown-toggle" href='/blog' data-toggle='_dropdown'>Blog</a>
						</li>

						

						<li>
							<a class="dropdown-toggle" href='/cloud' data-toggle='_dropdown'>Cloud</a>
						</li>

						

						<li>
							<a class="dropdown-toggle" href='/canigo' data-toggle='_dropdown'>Canigó</a>
						</li>

						

						<li>
							<a class="dropdown-toggle" href='/sic' data-toggle='_dropdown'>SIC</a>
						</li>

						

						<li>
							<a class="dropdown-toggle" href='/sgde' data-toggle='_dropdown'>SGDE</a>
						</li>

						

						<li>
							<a class="dropdown-toggle" href='/gicar' data-toggle='_dropdown'>GICAR</a>
						</li>

						

						<li>
							<a class="dropdown-toggle" href='/cs' data-toggle='_dropdown'>Centres de Suport</a>
						</li>

						

						<li>
							<a class="dropdown-toggle" href='/dadesref' data-toggle='_dropdown'>Gestió Tècnica de Dades</a>
						</li>

						

						<li>
							<a class="dropdown-toggle" href='/eventhub' data-toggle='_dropdown'>EventHub</a>
						</li>

						

					</ul>

				</nav>
			</div>
		</header>



	</div>

	<section class="border-start">

						
			

			<article class="bgGrey">
				<div class="container">
					<div class="row">
						<div class="capcelera_basica col-sm-12">
							<div class="capcelera_basica_cont">
								<ol class="breadcrumb filariana hidden-xs">
									<li>
										<a href="/">Inici</a>
									</li>
									<li class="breadcrumbs2">
									
										<a href="/cloud-caas">
											




























										</a>
										




























































































									
									</li>

								</ol>

								<h1 class="capcelera_flotant pull-left" data-txt=".title">
									

										
											




	Criteris creació contenidors docker


										

									
								</h1>

								

								
								

								

								

							</div>
						</div>

					</div>
				</div>
			</article>

			


		   <div class="padding-xs container">
	    	
	    	   <i><b>Darrera actualització:</b></i> 11-06-2020
	        
           </div>
           
			<article class="padding-xs padding-sm padding-md contingut">				
				<div class="container">
 		
					
				

	


					

						

<h2 id="introducció">Introducció</h2>

<p>A l&rsquo;hora de crear les imatges dels diferents contenidors docker per les aplicacions gencat cal establir un conjunt de criteris que garanteixin la seva estabilitat i seguretat.</p>

<h2 id="imatges-homologades-pel-ctti">Imatges homologades pel CTTI</h2>

<p>L&rsquo;equip de Suport Cloud del CTTI manté un conjunt d&rsquo;imatges docker de les tecnologies més utilitzades a la Generalitat de Catalunya. Aquestes imatges són compatibles amb totes les plataformes basades en contenidors disponibles a la Generalitat (Openshift i Kubernetes).</p>

<p>Aquestes imatges docker es poden trobar al <strong>registre docker privat</strong>, al projecte <strong>gencatcloud</strong>.</p>

<p>Podeu trobar més informació respecte al registre privat a <a href="http://canigo.ctti.gencat.cat/cloud-caas/dockerRegistry/">Registre docker privat</a>.</p>

<h2 id="criteris-per-escollir-la-imatge-base">Criteris per escollir la imatge base</h2>

<ul>
<li>Les imatges de docker es crearan sempre a partir del fitxer Dockerfile, en cap cas es crearan imatges a partir de contenidors.</li>
<li>En cas que existeixin imatges homologades pel CTTI de la tecnologia requerida, el Dockerfile particular de cada aplicació haurà de tenir com a base la imatge homologada, utilitzant la directiva <strong>FROM</strong>.</li>
<li>En cas que no existeixin imatges homologades pel CTTI de la tecnologia requerida, a l&rsquo;hora d&rsquo;escollir les imatges de base es faran servir els següents criteris:

<ul>
<li><strong>Sempre es crearan les imatges utilitzant Dockerfile, en cap cas s&rsquo;utilitzaran imatges preconstruides.</strong></li>
<li>S&rsquo;utilitzarà preferentment el Dockerfile d&rsquo;Imatges oficials dels fabricants, normalment disponibles al <a href="https://hub.docker.com/">docker hub</a>.</li>
<li>En cas que existeixi una imatge oficial basada en <strong><a href="https://hub.docker.com/_/alpine/">Alpine</a></strong>, s&rsquo;escollirà aquesta.</li>
<li>En cas que no existeixi una imatge oficial basada en Alpine, s&rsquo;escollirà la imatge basada en Centos, substituint Centos per la versió d&rsquo;Oracle Linux Slim corresponent. Aquesta substitució és necessària pel support de pegats de seguretat que ofereix Oracle Linux i no ofereix Centos.</li>
<li>En cas que no existeixi una imatge oficial basada en Alpine ni Centos, s&rsquo;escollirà la que recomani el fabricant. Sol ser la que al tag només s&rsquo;indica la versió.</li>
</ul></li>
<li><strong>Mai s&rsquo;escollirà el tag latest</strong>. És una versió que va canviant en el temps i genera inestabilitat a les aplicacions. Escollir sempre la versió més tancada possible.</li>
</ul>

<h2 id="criteris-generals-per-la-creació-de-les-imatges">Criteris generals per la creació de les imatges</h2>

<p>Alguns d&rsquo;aquests criteris no apliquen en cas d&rsquo;utilitzar les imatges homologades pel CTTI.</p>

<ul>
<li>Deixar instal·lat el nombre mínim de paquets al docker, si és necessari instal·lar paquets per realitzar compilacions, desinstal·lar-los un cop realitzada aquesta.</li>
<li>Actualitzar els packets del sistema operatiu a l&rsquo;última versió disponible amb tots els pegats de seguretat aplicats.</li>
<li>No deixar el codi font al docker, un cop compilat, eliminar-lo.</li>
<li>Incloure a la imatge el script <strong>wait-for-it.sh</strong>, adjuntat a baix, per poder testejar les comunicacions. Notar que requereix tenir el bash instal·lat.</li>
<li>No executar mai el procés final de les aplicacions amb l&rsquo;usuari <strong>root</strong>. La majoria de tecnologies inclouen scripts que utilitzen usuaris específics per arrencar-les.</li>
<li>Fixar els uid i gid dels usuaris i grups utilitzats per executar els processos, amb l&rsquo;objectiu d&rsquo;evitar escalat de privilegis.</li>
<li>Assegurar la seguretat dels directoris definint el propietari i els permisos explícitament. S&rsquo;adjunta a baix l&rsquo;script <strong>docker-setup.sh</strong> d&rsquo;exemple.</li>
<li>Executar el procés principal des d&rsquo;un script, mai directament al Dockerfile.</li>
<li>Utilitzar el volum <strong>/data</strong> per desar la informació que cal persistir.</li>
<li>No executar múltiples processos a dins de la imatge docker. Docker està pensat per executar un únic procés.</li>
<li><strong>No escriure els logs de l&rsquo;aplicació a fitxers. Enviar els logs sempre a la sortida estàndard</strong>. D&rsquo;aquesta manera la plataforma capturarà els logs i no caldrà entrar als contenidors per veure&rsquo;ls.</li>
</ul>

<h2 id="criteris-de-seguretat">Criteris de seguretat</h2>

<ul>
<li>Intentar utilitzar l&rsquo;última versió del producte, sol ser la que té menys vulnerabilitats de seguretat.</li>
<li>Per validar la seguretat de les imatges creades, utilitzar l&rsquo;eina <a href="https://github.com/coreos/clair">Clair</a>. En cas que es detectin vulnerabilitats, intentar eliminar-les instal·lant els patches necessaris.</li>
<li>Aplicar totes les configuracions de seguretat recomanades pel fabricant o la comunitat per cada producte en particular.</li>
<li>Es recomanable seguir les directrius de seguretat definides per CIS. <a href="https://www.cisecurity.org/benchmark/docker/">CIS Docker Benchmark</a>.</li>
</ul>

<p>Abans de desplegar un contenidor a producció, es realitzarà una validació de seguretat utilitzant l&rsquo;eina Clair. En cas de detectar vulnerabilitats de caràcter greu la imatge no serà desplegada.</p>

<h2 id="criteris-específics-de-openshift">Criteris específics de Openshift</h2>

<p><a href="https://www.openshift.com/">Openshift</a>, tot i que suporta desplegar imatges de docker, presenta uns criteris més restrictius de seguretat que cal tenir present a l&rsquo;hora de construir el Dockerfile.</p>

<ul>
<li>No utilitzar l&rsquo;usuari <strong>root</strong> ni per executar l&rsquo;script principal del docker (normalment s&rsquo;utilitza l&rsquo;usuari root). Utilitzar la directiva <strong>USER uid</strong> per definir amb quin usuari s&rsquo;executarà el procés.</li>

<li><p>Cal tenir present que openshift executa el procés amb un id d&rsquo;usuari aleatori que pertany al grup <strong>root</strong>.</p>

<ul>
<li>Aquest usuari es crea a l&rsquo;executar el docker. No existeix, ni es coneix, en etapa de construcció de la imatge de docker.</li>
<li>A causa de la característica anterior, és possible que algunes accions que habitualment es fan en etapa de construcció calgui fer-les en etapa d&rsquo;execució amb alguna shell.</li>
<li>Cal que les carpetes on el procés escriu dades, pertanyin al grup root. Es pot veure a l&rsquo;script <strong>docker-setup.sh</strong> inclòs abaix.</li>

<li><p>Algunes aplicacions necessiten que l&rsquo;usuari estigui definit al fitxer <strong>/etc/passwd</strong>. En aquest cas existeixen dues opcions:</p>

<ul>
<li>Utilitzar el paquet <strong><a href="https://cwrap.org/nss_wrapper.html">nss_wrapper</a></strong> per emular els canvis en aquest fitxer.
Es necessari heretar de la imatge <a href="https://git.intranet.gencat.cat/3048-intern/imatges-docker/alpine-nss">alpine-nss</a>. Important llegir el README.md amb les instruccions de com utilitzar-la.</li>
</ul>

<p>Es pot veure un exemple d&rsquo;ús a la imatge docker <a href="https://git.intranet.gencat.cat/3048-intern/imatges-docker/postgres">postgres</a>. Fixeu-vos sobretot en l&rsquo;ús del ENTRYPOINT.</p>

<ul>
<li>Utilitar la funcionalitat que ofereix <a href="https://cri-o.io/">cri.o</a>, motor de contenidors d&rsquo;Openshift 4, que afegeix automàticament l&rsquo;usuari amb que arrenca el contenidor al fitxer de <strong>/etc/password</strong></li>
</ul>

<p>Veure la plana web <a href="https://docs.openshift.com/container-platform/4.3/openshift_images/create-images.html">Openshift. Creating Images. Guidelines. OpenShift Origin-Specific Guidelines. Support Arbitrary User IDs</a> per més detalls.</p></li>
</ul></li>

<li><p>Utilitzar variables d&rsquo;entorn per la configuració.</p></li>

<li><p>Més informació de com construir les imatges de docker està disponible a :</p>

<ul>
<li><a href="https://docs.openshift.com/container-platform/4.3/openshift_images/create-images.html#images-create-guide-openshift_create-images">Openshift 4.3. Creating Images. Guidelines</a></li>
<li><a href="https://docs.openshift.com/container-platform/3.11/creating_images/guidelines.html">Openshift 3.11. Creating Images. Guidelines</a></li>
<li><a href="https://access.redhat.com/articles/4859371">OpenShift Containers - Modification of /etc/passwd</a></li>
</ul></li>
</ul>

<h2 id="exemples">Exemples</h2>

<p>Podeu trobar exemples de diferents imatges de docker seguint aquests criteris al <a href="https://docker-registry.ctti.extranet.gencat.cat">registre docker privat</a> projecte <strong>gencatcloud</strong>. Podeu trobar els Dockerfiles de les imatges a <a href="https://git.intranet.gencat.cat/3048-intern/imatges-docker/">git imatges docker</a>.</p>

<p>Quan trobeu que per una tecnologia existeix la versió normal i la versió amb
amb sufix <strong>-openshift</strong>, les imatges amb versió normal son compatibles amb docker(local) i Swarme i les imatges amb amb sufix <strong>-openshift</strong> són compatibles amb Kubernetes i Openshift.</p>

<h2 id="annexos">Annexos</h2>

<p><em>wait-for-it.sh</em></p>

<pre><code>#!/usr/bin/env bash
#   Use this script to test if a given TCP host/port are available

cmdname=$(basename $0)

echoerr() { if [[ $QUIET -ne 1 ]]; then echo &quot;$@&quot; 1&gt;&amp;2; fi }

usage()
{
    cat &lt;&lt; USAGE &gt;&amp;2
Usage:
    $cmdname host:port [-s] [-t timeout] [-- command args]
    -h HOST | --host=HOST       Host or IP under test
    -p PORT | --port=PORT       TCP port under test
                                Alternatively, you specify the host and port as host:port
    -s | --strict               Only execute subcommand if the test succeeds
    -q | --quiet                Don't output any status messages
    -t TIMEOUT | --timeout=TIMEOUT
                                Timeout in seconds, zero for no timeout
    -- COMMAND ARGS             Execute command with args after the test finishes
USAGE
    exit 1
}
wait_for()
{
    if [[ $TIMEOUT -gt 0 ]]; then
        echoerr &quot;$cmdname: waiting $TIMEOUT seconds for $HOST:$PORT&quot;
    else
        echoerr &quot;$cmdname: waiting for $HOST:$PORT without a timeout&quot;
    fi
    start_ts=$(date +%s)
    while :
    do
        (echo &gt; /dev/tcp/$HOST/$PORT) &gt;/dev/null 2&gt;&amp;1
        result=$?
        if [[ $result -eq 0 ]]; then
            end_ts=$(date +%s)
            echoerr &quot;$cmdname: $HOST:$PORT is available after $((end_ts - start_ts)) seconds&quot;
            break
        fi
        sleep 1
    done
    return $result
}
wait_for_wrapper()
{
    # In order to support SIGINT during timeout: http://unix.stackexchange.com/a/57692
    if [[ $QUIET -eq 1 ]]; then
        timeout -t $TIMEOUT $0 --quiet --child --host=$HOST --port=$PORT --timeout=$TIMEOUT &amp;
    else
        timeout -t $TIMEOUT $0 --child --host=$HOST --port=$PORT --timeout=$TIMEOUT &amp;
    fi
    PID=$!
    trap &quot;kill -INT -$PID&quot; INT
    wait $PID
    RESULT=$?
    if [[ $RESULT -ne 0 ]]; then
        echoerr &quot;$cmdname: timeout occurred after waiting $TIMEOUT seconds for $HOST:$PORT&quot;
    fi
    return $RESULT
}
# process arguments
while [[ $# -gt 0 ]]
do
    case &quot;$1&quot; in
        *:* )
        hostport=(${1//:/ })
        HOST=${hostport[0]}
        PORT=${hostport[1]}
        shift 1
        ;;
        --child)
        CHILD=1
        shift 1
        ;;
        -q | --quiet)
        QUIET=1
        shift 1
        ;;
        -s | --strict)
        STRICT=1
        shift 1
        ;;
        -h)
        HOST=&quot;$2&quot;
        if [[ $HOST == &quot;&quot; ]]; then break; fi
        shift 2
        ;;
        --host=*)
        HOST=&quot;${1#*=}&quot;
        shift 1
        ;;
        -p)
        PORT=&quot;$2&quot;
        if [[ $PORT == &quot;&quot; ]]; then break; fi
        shift 2
        ;;
        --port=*)
        PORT=&quot;${1#*=}&quot;
        shift 1
        ;;
        -t)
        TIMEOUT=&quot;$2&quot;
        if [[ $TIMEOUT == &quot;&quot; ]]; then break; fi
        shift 2
        ;;
        --timeout=*)
        TIMEOUT=&quot;${1#*=}&quot;
        shift 1
        ;;
        --)
        shift
        CLI=&quot;$@&quot;
        break
        ;;
        --help)
        usage
        ;;
        *)
        echoerr &quot;Unknown argument: $1&quot;
        usage
        ;;
    esac
done
if [[ &quot;$HOST&quot; == &quot;&quot; || &quot;$PORT&quot; == &quot;&quot; ]]; then
    echoerr &quot;Error: you need to provide a host and port to test.&quot;
    usage
fi
TIMEOUT=${TIMEOUT:-15}
STRICT=${STRICT:-0}
CHILD=${CHILD:-0}
QUIET=${QUIET:-0}
if [[ $CHILD -gt 0 ]]; then
    wait_for
    RESULT=$?
    exit $RESULT
else
    if [[ $TIMEOUT -gt 0 ]]; then
        wait_for_wrapper
        RESULT=$?
    else
        wait_for
        RESULT=$?
    fi
fi
if [[ $CLI != &quot;&quot; ]]; then
    if [[ $RESULT -ne 0 &amp;&amp; $STRICT -eq 1 ]]; then
        echoerr &quot;$cmdname: strict mode, refusing to execute subprocess&quot;
        exit $RESULT
    fi
    exec $CLI
else
    exit $RESULT
fi
</code></pre>

<p><em>docker-setup.sh</em></p>

<pre><code>#!/bin/sh

# setup directory for data
mkdir -p /data
chown -R nginx:0 /data
chmod g+w -R /data
chown -R nginx:0 /usr
chown -R nginx:0 /var

chgrp -R 0 /usr
chmod -R g+rw /usr
find /usr -type d -exec chmod g+x {} +

chgrp -R 0 /var
chmod -R g+rw /var
find /var -type d -exec chmod g+x {} +
</code></pre>


					

					
				</div>	

			</article>	


	</section>	

		<div class="fons_footer ">
		<footer class="container center-block shadowBox2">
			<div class="shadow2"></div>
			<div class="row footer_tab_ord">

				<div class="footer_tab_bot col-sm-12">
					<div class="avis_legal">

						<div id="fAvisLegal">
							<div>
								<div class="hidden-xs">
									<a href="https://www.gencat.cat"> <img
										src="/img/logo_generalitat_gris.png_679097835.png"
										width="101" height="27" alt="www.gencat.cat"
										/></a>
									<p>
										<a title="Avis legal" href="https://web.gencat.cat/ca/menu-ajuda/ajuda/avis_legal/" target="_self">Avís legal</a>: La &copy; Generalitat de Catalunya permet la reutilització dels continguts i de les dades sempre que se citi la font i la data d'actualització, que no es desnaturalitzi la informació i que no es contradigui amb una llicència específica.
									</p>
								</div>
								<div class="visible-xs avis_legal">
									<p>
										<a title="Avis legal" href="https://web.gencat.cat/ca/menu-ajuda/ajuda/avis_legal/" target="_self">Avís legal</a>: La &copy; Generalitat de Catalunya permet la reutilització dels continguts i de les dades sempre que se citi la font i la data d'actualització, que no es desnaturalitzi la informació i que no es contradigui amb una llicència específica.
									</p>
								</div>
								
								<div class="fi_peu visible-xs">
									<a title="www.gencat.cat" href="https://www.gencat.cat"> <img
										src="/img/logo_generalitat_gris.png_679097835.png"
										width="101" height="27" 
										alt="www.gencat.cat" /></a> <a class="torna_amunt pull-right"
										href=" javascript:tornarAmunt();" title="Torna amunt">
										<p>Torna amunt</p>
									</a>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</footer>
	</div>

<script src="/js/master.min.js" type="text/javascript"></script>
<script src="https://cdn.jsdelivr.net/algoliasearch/3/algoliasearch.min.js"></script>
<script src="https://cdn.jsdelivr.net/autocomplete.js/0/autocomplete.min.js"></script>
<script src="/js/custom.js" type="text/javascript"></script>



<script type="text/javascript">

if(location.hostname!=="localhost"){

	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

	ga('create', "UA-59408075-1", 'auto');
	ga('send', 'pageview', {
	  	'page': location.pathname + location.search  + location.hash
	  }
	);

}

</script>




</body>
</html>
