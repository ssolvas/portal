<!DOCTYPE html>
<html xml:lang="ca-ES" lang="ca-ES" xmlns="http://www.w3.org/1999/xhtml">
<head>

	<title>Tomcat amb sessió distribuïda</title>
		<meta charset="UTF-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<link rel="shortcut icon" type="image/x-icon" href="/img/favicon.ico" />
	<link href="/css/master.min.css" rel="stylesheet" type="text/css" />
	<link href="/css/canigo.css" rel="stylesheet" type="text/css" />
	<script src="/js/jquery.min.js" type="text/javascript"></script>

	<script>
		document.write("<meta name=\"titol\" content=\"Tomcat amb sessió distribuïda\" />");
		document.write("<meta name=\"description\" content=\"En aquest article es descriu com utilitzar Tomcat amb sessió distribuïda a Kubernetes i openshift.\" />");
	</script>

	

</head>
<body class="single">
	<div class="contenidor unfixed">

				

		<header class="fons_header navbar navbar-default z-index-menu">
			<div class="container" role="menu">
				<div class="row clearfix menuNav">
					<div class="col-md-3 col-xs-3 column visible-xs coloca ">
						<button type="button" onclick="amunt();" title="Menu"
							class="navbar-toggle pull-left" data-toggle="collapse"
							data-target=".navbar-collapse">
							<span class="sr-only">Toggle navigation</span> <span
								class="icon-bar"></span> <span class="icon-bar"></span> <span
								class="icon-bar"></span>
						</button>
					</div>

					<div class="col-md-3 col-xs-6 col-offset-2 column visible-xs titol-mobil">
						
						<span class="white titol-mobil-destacat">canigo.ctti</span><span class="white">.gencat.cat</span>
					</div>

					<div class="col-md-3 col-xs-3 column visible-xs coloca1">
						<button onclick="amunt();" type="button" title="Cerca"
							class="ico_cerca " data-toggle="collapse" data-target=".dos">
						</button>
					</div>

				</div>

				<div class="collapse dos">
					<div class="shadowBox">
						<form class="navbar-form navbar-left primer" action="/cercador/" method="get"
 						onsubmit="location.href=this.action+'?q='+this.cerca_cap.value; return false;">
							<div class="form-group">
								<input type="search" class="form-control" name="q" id="cerca_cap"
									title="Cerca"
									placeholder="Cerca" />
								<button type="button" title="Neteja" class="btn btn-default"></button>
								<input type="submit" class="ocult" name="Cerca" value="Cerca" />
							</div>
						</form>
					</div>
				</div>	

				<nav class="collapse navbar-collapse navbar-ex1-collapse ">
				
					<div class="row">
						<div class="col-md-6 col-sm-4 column">
							<a class="img-responsive logo" title="Generalitat de Catalunya"
								href="https://ctti.gencat.cat/">gencat.cat</a>
							<button class="menu_tancar visible-xs collapsed"
								data-target=".navbar-collapse" data-toggle="collapse"
								title="Tancar"></button>
						</div>

						<div class="col-md-6 col-sm-8 column hidden-xs hidden-mg">
							<form class="navbar-form cercador_vermell hidden-xs pull-right" action="/cercador/"  method="get" onsubmit="location.href=this.action+'?q='+this.cerca2.value; return false;">
								<div class="form-group">
									<label class="hidden" for="cerca2">Cerca</label>
									<input id="cerca2" class="form-control" type="search" 
									placeholder="Cerca" name="q" title="Cerca">
									<input class="btn btn-default" type="submit" title="Cerca" value="">
								</div>
							</form>

							

						</div>

					</div>
					<div class="col-xs-12 hidden-xs" id="nomPortal">
                    	<span class="titol-cap-nou">Centre de Telecomunicacions i Tecnologies de la Informació</span>
                    </div>					
					<ul class="nav navbar-nav">

			        	

						<li>
							<a class="dropdown-toggle" href='/' data-toggle='_dropdown'>Inici</a>
						</li>

						

						<li>
							<a class="dropdown-toggle" href='/arqctti' data-toggle='_dropdown'>Arquitectura CTTI</a>
						</li>

						

						<li>
							<a class="dropdown-toggle" href='/blog' data-toggle='_dropdown'>Blog</a>
						</li>

						

						<li>
							<a class="dropdown-toggle" href='/cloud' data-toggle='_dropdown'>Cloud</a>
						</li>

						

						<li>
							<a class="dropdown-toggle" href='/canigo' data-toggle='_dropdown'>Canigó</a>
						</li>

						

						<li>
							<a class="dropdown-toggle" href='/sic' data-toggle='_dropdown'>SIC</a>
						</li>

						

						<li>
							<a class="dropdown-toggle" href='/sgde' data-toggle='_dropdown'>SGDE</a>
						</li>

						

						<li>
							<a class="dropdown-toggle" href='/gicar' data-toggle='_dropdown'>GICAR</a>
						</li>

						

						<li>
							<a class="dropdown-toggle" href='/cs' data-toggle='_dropdown'>Centres de Suport</a>
						</li>

						

						<li>
							<a class="dropdown-toggle" href='/dadesref' data-toggle='_dropdown'>Gestió Tècnica de Dades</a>
						</li>

						

						<li>
							<a class="dropdown-toggle" href='/eventhub' data-toggle='_dropdown'>EventHub</a>
						</li>

						

					</ul>

				</nav>
			</div>
		</header>



	</div>

	<section class="border-start">

						
			

			<article class="bgGrey">
				<div class="container">
					<div class="row">
						<div class="capcelera_basica col-sm-12">
							<div class="capcelera_basica_cont">
								<ol class="breadcrumb filariana hidden-xs">
									<li>
										<a href="/">Inici</a>
									</li>
									<li class="breadcrumbs2">
									
										<a href="/cloud-caas">
											




























										</a>
										




























































































									
									</li>

								</ol>

								<h1 class="capcelera_flotant pull-left" data-txt=".title">
									

										
											




	Tomcat amb sessió distribuïda


										

									
								</h1>

								

								
								

								

								

							</div>
						</div>

					</div>
				</div>
			</article>

			


		   <div class="padding-xs container">
	    	
	    	   <i><b>Darrera actualització:</b></i> 19-08-2019
	        
           </div>
           
			<article class="padding-xs padding-sm padding-md contingut">				
				<div class="container">
 		
					
				

	

	<div class="row" id="TOC">
		<div class="col-md-12 col-xs-12"> 
			<nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#introducció">Introducció</a></li>
<li><a href="#selecció-de-la-solució">Selecció de la solució</a></li>
<li><a href="#descripció-de-la-solució">Descripció de la solució</a>
<ul>
<li><a href="#gestió-de-la-sessió">Gestió de la sessió</a></li>
</ul></li>
<li><a href="#configuració">Configuració</a>
<ul>
<li><a href="#configuració-a-kubernetes-openshift">Configuració a Kubernetes/Openshift</a></li>
<li><a href="#configuració-de-hazelcast">Configuració de Hazelcast</a>
<ul>
<li><a href="#configuració-de-hazelcast-3-12-x-java-8-o-superior">Configuració de Hazelcast 3.12.x (java 8 o superior)</a></li>
<li><a href="#configuració-de-hazelcast-3-11-x-java-6-o-7">Configuració de Hazelcast 3.11.x (java 6 o 7)</a></li>
</ul></li>
</ul></li>
<li><a href="#exemple">Exemple</a></li>
</ul></li>
</ul>
</nav>
    	</div>
	</div>

	


					

						

<p>Tomcat, a diferència d&rsquo;altres servidors d&rsquo;aplicacions com poden ser Weblogic o JBoss, no presenta de manera nativa una gestió eficient de sessions http entre diferents instàncies.</p>

<p>En aquest article es descriu la solució proposada per gestionar la sessió distribuïda  a Tomcat en contenidors desplegats a Kubernetes o Openshift.</p>

<h2 id="introducció">Introducció</h2>

<p>Les configuracions més eficients en servidors Tomcat, es basen en què cada instància de Tomcat gestioni les seves pròpies sessions i aquestes no es comparteixin entre els diferents Tomcats que ofereixen un servei.</p>

<p>Quan existeixen múltiples instàncies de Tomcat amb un balancejador davant per repartir la càrrega, es garanteix, que per cada usuari que utilitza l&rsquo;aplicació, les seves peticions sempre són servides per la mateixa instància de Tomcat. Per aconseguir aquest comportament es configura el que s&rsquo;anomena <strong>Sticky Session</strong>.</p>

<p>La <strong>Sticky Session</strong> presenta l&rsquo;avantatge de simplicitat i millor rendiment, però presenta el següent inconvenient principal:</p>

<ul>
<li>En cas de caiguda del node que serveix les peticions d&rsquo;un usuari, tot i que l&rsquo;aplicació continua estant activa (hi ha altres instàncies de Tomcat que serveixen l&rsquo;aplicació), les seves sessions es perden i per tant la informació de navegació que contenen, per exemple si està autenticat.</li>
</ul>

<p>Aquest inconvenient és especialment important en el cas dels contenidors i cloud, on pot no estar garantit que no hi hagi reinicis i poden haver-hi canvis dinàmics d&rsquo;instàncies, que pot provocar que es perdin sessions.</p>

<p>Com a alternativa a aquesta configuració, existeix la <strong>Shared Session</strong> que replica la sessió entre tots els nodes de Tomcat. Aquesta configuració augmenta molt la càrrega del sistema i no és recomanable.</p>

<p>Addicionalment, hi ha altres alternatives per gestionar les sessions. Bàsicament es basen en persistir la sessió en elements externs al servidor d&rsquo;aplicacions i anar a buscar la sessió a aquests elements. Bàsicament existeixen les següents opcions:</p>

<ul>
<li>Utilitzar una <strong>base de dades externa per emmagatzemar sessions</strong>. Normalment NoSQL. És molt habitual utilitzar Redis, per exemple.</li>
<li>Utilitzar i configurar un <strong>servidor d&rsquo;aplicacions en cluster</strong>. Per exemple JBoss o Weblogic. Són servidors pesats i requereixen molts recursos</li>
<li>Utilitzar un <strong>In-Memory Data Grid (IMDG)</strong> per emmagatzemar les sessions. Per exemple Hazelcast.</li>
</ul>

<h2 id="selecció-de-la-solució">Selecció de la solució</h2>

<p>A l&rsquo;hora d&rsquo;escollir la solució s&rsquo;han valorat les següents característiques:</p>

<ul>
<li>Rendiment</li>
<li>Simplicitat</li>
<li>Facilitat d&rsquo;ús</li>
<li>Facilitat d&rsquo;adaptació a les plataformes de contenidors</li>
<li>Cost</li>
</ul>

<p>S&rsquo;ha decidit utilitzar el <strong>IMDG Hazelcast</strong> pels següents motius:</p>

<ul>
<li>El rendiment de la solució és molt bo. Bàsicament les peticions són servides directament per Tomcat amb Sticky session, com si no hi hagués el IMDG. Aquest només és utilitzat el cas que hi hagui alguna caiguda de node de Tomcat. S&rsquo;afegeix al sistema la càrrega addicional de mantenir en memòria les sessions distribuïdes.</li>
<li>Simplicitat. La solució és molt simple, només cal afegir algunes llibreries al Tomcat i canviar alguns petits elements de configuració. No cal afegir elements externs, ni requereix cap canvi a l&rsquo;aplicació.</li>
<li>Facilitat d&rsquo;ús. Per utilitzar-lo només cal realitzar una mínima configuració. És totalment transparent a l&rsquo;aplicació.</li>
<li>Facilitat d&rsquo;adaptació a Kubernetes (i Openshift). Nativament el producte s&rsquo;integra amb Kubernetes, de manera que el descobriment de nodes i pods es fà de manera automàtica sense necessitat d&rsquo;afegir elements addicionals.</li>
<li>Cost. La solució es Open Source. Disposa d&rsquo;una versió comercial que afegeix eines de Gestió, Seguretat i Suport, però no afecta a IMDG en si.</li>
</ul>

<p>S&rsquo;ha escollit la solució de Hazelcast davant de Redis, pels següents motius:</p>

<ul>
<li>Simplicitat. Construir un cluster de Redis en HA, requereix sis pods com a mínim a Kubernetes amb diferents funcions i configuracions.</li>
<li>Facilitat d&rsquo;ús. Tot i que teòricament és transparent a l&rsquo;aplicació, diverses proves han presentat comportaments de sessió estranys, que probablement requereixen canvis a les aplicacions.</li>
<li>La Integració amb Contenidors no és directa, cal crear un cluster HA tal com si estigués en on premise i comfigurar-lo per a què s&rsquo;autodescobreixin.</li>
</ul>

<h2 id="descripció-de-la-solució">Descripció de la solució</h2>

<p>A l&rsquo;afegir les llibreries de Hazelcast a Tomcat es crea un cluster de Hazelcast amb un node a cadascun dels pods de Tomcat.
Els nodes del cluster s&rsquo;autodescobreixen de manera automàtica gràcies a un Service de Kubernetes dedicat només per aquesta tasca.
Addicionalment els Tomcats es configuren per a què gestionin les sessions a través d&rsquo;un Session Mànager proporcionat per Hazelcast.</p>

<p><img src="/related/cloud/tomcat-hc-1.png" alt="Descripció de la solució" /></p>

<h3 id="gestió-de-la-sessió">Gestió de la sessió</h3>

<p><strong>És important que tot el sistema estigui configurat en Sticky Session</strong>, si nó podrien haver-hi diferents Tomcats amb la mateixa sessió (però amb diferent contingut) i podrien generar-se incongruències.</p>

<p>La gestió de la sessió és la següent:</p>

<ul>
<li>Un usuari fa una petició al Tomcat a través d&rsquo;un balancejador. Aquest Tomcat crea una sessió i li torna una cookie amb l&rsquo;identificador a l&rsquo;usuari. ës el comportament normal de Tomcat.</li>
</ul>

<p><img src="/related/cloud/tomcat-hc-2.png" alt="Petició" /></p>

<ul>
<li>En paral·lel el Tomcat, asincronament fa arribar la sessió al seu node de Hazelcast.</li>
</ul>

<p><img src="/related/cloud/tomcat-hc-3.png" alt="Sessió" /></p>

<ul>
<li>Els nodes dels Hazelcast estan sincronitzats i propaguen la sessió a la resta de nodes del cluster.</li>
</ul>

<p><img src="/related/cloud/tomcat-hc-4.png" alt="Sincronització" /></p>

<ul>
<li><p>Per les crides posteriors que l&rsquo;usuari faci a l&rsquo;aplicació, el procés serà el mateix. Notar que de cara a l&rsquo;usuari, el comportament del Tomcat és el mateix que si no tingués el Hazelcast configurat. Totes les tasques addicionals es fan de manera asincrona.</p></li>

<li><p>Suposem que el node de Tomcat que serveix la sessió de l&rsquo;usuari cau. En condicions normals es perdria la sessió i l&rsquo;usuari perdria total la informació, havent de tornar a començar des de zero.</p></li>
</ul>

<p><img src="/related/cloud/tomcat-hc-5.png" alt="Node Caigut" /></p>

<ul>
<li>Amb la solució proposada:

<ul>
<li>El cluster de Hazelcast es redimensiona automàticament.</li>
<li>El balancejador envia la petició de l&rsquo;usuari cap a un altre dels Tomcats disponibles (que no te la sessió)</li>
<li>Com que no té la sessió, el Tomcat la sol·licita al cluster de Hazelcast</li>
<li>El cluster de Hazelcast li torna la sessió a Tomcat i a partir de llavors el comportament ja es tal com era normalment.</li>
</ul></li>
</ul>

<p><img src="/related/cloud/tomcat-hc-6.png" alt="Solicitud sessió" /></p>

<p><img src="/related/cloud/tomcat-hc-7.png" alt="Recuparació sessió" /></p>

<ul>
<li>Quan el nou pod de Tomcat, es torna a aixecar, el Cluster de Hazelcast descubriex el nou membre i li proporciona total la informació que té, quedant el nou node tal com estan la resta de nodes.</li>
</ul>

<p><img src="/related/cloud/tomcat-hc-8.png" alt="Recuparació node" /></p>

<h2 id="configuració">Configuració</h2>

<p>Les imatges docker repositades al registre privat <a href="https://docker-registry.ctti.extranet.gencat.cat">https://docker-registry.ctti.extranet.gencat.cat</a> del tipus <strong>gencatcloud/tomcat-hc:XX</strong>, tenen configurades les llibreries i el Session Manager de Tomcat amb Hazelcast. Inclouen una configuració bàsica de Hazelcast que fa que es crei un cluster d&rsquo;un únic node.</p>

<p>D&rsquo;aquesta manera es poden utilitzar i provar les imatges a docker fent un <em>docker run</em> sense necessitat de disposar d&rsquo;un Kubernetes.</p>

<h3 id="configuració-a-kubernetes-openshift">Configuració a Kubernetes/Openshift</h3>

<p>Per una banda cal configurar els elements bàsics de Kubernetes pel Tomcat:</p>

<ul>
<li><strong>Deployment/DeploymentConfig</strong> amb la imatge de l&rsquo;aplicació</li>
<li><strong>Service</strong> per exposar l&rsquo;aplicació a Kubernetes</li>
<li><strong>Ingress/Route</strong> per exposar l&rsquo;aplicació cal a Internet/Intranet. És molt important que l&rsquo;Ingress estigui configurat per a què utilitzi Sticky Session.</li>
</ul>

<p>Exemple de Ingress amb <strong>Sticky Session</strong> a Kubernetes.</p>

<pre><code>apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: tomcat-hc-85
  annotations:
    ingress.bluemix.net/sticky-cookie-services: &quot;serviceName=tomcat-hc-85 name=tomcat-hc-85&quot;
spec:
  rules:
  - host: www.tomcat85-hc.k8s.gencat.cat
    http:
      paths:
      - path: /
        backend:
          serviceName: tomcat-hc-85
          servicePort: 80
</code></pre>

<p>Addicionalment a la configuració estàndard de qualsevol Tomcat, cal afegir la següent configuració:</p>

<ul>
<li><strong>ConfigMap</strong> amb el fitxer de configuració de Hazelcast</li>
<li><strong>Service addicional</strong> que utilitza Hazelcast per descobrir automàticament els pods com a elements dins del cluster de Hazelcast</li>
</ul>

<p>ConfigMap</p>

<pre><code>kind: ConfigMap
metadata:
  name: tomcat-hc-85-config
data:
  hazelcast.xml: |
    &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
    ...
    ...

</code></pre>

<p>Hazelcast Service</p>

<pre><code>apiVersion: v1
kind: Service
metadata:
  annotations:
  labels:
    app: tomcat-hc-85
  name: tomcat-hc2-85
spec:
  type: ClusterIP
  clusterIP: None
  ports:
  - name: &quot;5701-tcp&quot;
    port: 5701
    targetPort: 5701
  selector:
    app: tomcat-hc-85
</code></pre>

<p><strong>Important:</strong></p>

<ul>
<li>El Servei de Hazelcast ha d&rsquo;apuntar cap al port <strong>5701</strong>, que és el port que exposen els nodes de Hazelcast.</li>
<li>El Servei de Hazelcast ha de ser del tipus <strong>ClusterIP: None</strong>, no volem que s&rsquo;exposi fora del pod.</li>
<li>El Servei ha d&rsquo;apuntar cap els pods de Tomcat.</li>
<li>Tota la resta de configuració és igual que qualsevol altre Service de Kubernetes.</li>
</ul>

<h3 id="configuració-de-hazelcast">Configuració de Hazelcast</h3>

<p>La configuració de Hazelcast es realitza a un <strong>ConfigMap</strong></p>

<p>Aquesta configuració presenta algunes diferències en funció de la versió de Hazelcast que alhora és depenent de la versió de java.</p>

<p>La versió de <strong>Hazelcast 3.12.x és compatible amb java 8 o superior.</strong></p>

<p>La versió de <strong>Hazelcast 3.11.x és compatible amb java 6 i 7.</strong></p>

<p><br/></p>

<h4 id="configuració-de-hazelcast-3-12-x-java-8-o-superior">Configuració de Hazelcast 3.12.x (java 8 o superior)</h4>

<p>Per configurar Hazelcast a Kubernetes/Openshift cal definir al fitxer xml les següents propietats:</p>

<ul>
<li><strong>group/name</strong> : Defineix el nom del cluster de Hazelcast</li>
<li><strong>hazelcast/network/join</strong> : En aquest apartat es defineixen els diferents protocols i serveis que defineixen els nodes del cluster. Pel cas de Kubernetes i Openshift, cal desactivar tots els protocols (<strong>enabled=&ldquo;false&rdquo;</strong>) i deixar activat només el de <strong>kubernetes (enabled=&ldquo;true&rdquo;)</strong>. Addicionalment, a l&rsquo;element kubernetes cal afegir el <strong>&lt;service-dns&gt;</strong> amb el nom de dsn del servei de kubernetes descrit anteriorment.</li>
</ul>

<p>El dns de servei de kubernetes es construeix seguint el patró <strong>&lt;nom_servei&gt;.&lt;nom_namespace&gt;.svc.cluster.local</strong></p>

<pre><code>...
    &lt;hazelcast xmlns=&quot;http://www.hazelcast.com/schema/config&quot;
               xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
               xsi:schemaLocation=&quot;http://www.hazelcast.com/schema/config
               http://www.hazelcast.com/schema/config/hazelcast-config-3.12.xsd&quot;&gt;

        &lt;group&gt;
            &lt;name&gt;test&lt;/name&gt;
        &lt;/group&gt;
        &lt;management-center enabled=&quot;false&quot;&gt;http://hazelcast-mc/hazelcast-mancenter&lt;/management-center&gt;
        &lt;network&gt;
            &lt;port auto-increment=&quot;true&quot; port-count=&quot;100&quot;&gt;5701&lt;/port&gt;
            &lt;outbound-ports&gt;
                &lt;!--
                Allowed port range when connecting to other nodes.
                0 or * means use system provided port.
                --&gt;
                &lt;ports&gt;0&lt;/ports&gt;
            &lt;/outbound-ports&gt;
            &lt;join&gt;
                &lt;multicast enabled=&quot;false&quot;/&gt;
                &lt;kubernetes enabled=&quot;true&quot;&gt;
                    &lt;service-dns&gt;tomcat-hc2-85.proves-ctti.svc.cluster.local&lt;/service-dns&gt;
                &lt;/kubernetes&gt;
                &lt;discovery-strategies&gt;
                &lt;/discovery-strategies&gt;
            &lt;/join&gt;
...
</code></pre>

<p>Podeu trobar més informació respecte la configuració de Hazelcast a:</p>

<ul>
<li><a href="https://github.com/hazelcast/hazelcast/blob/v3.12.2/hazelcast/src/main/resources/hazelcast-full-example.xml">https://github.com/hazelcast/hazelcast/blob/v3.12.2/hazelcast/src/main/resources/hazelcast-full-example.xml</a></li>
<li><a href="https://github.com/hazelcast/hazelcast-kubernetes/tree/v1.5.1">https://github.com/hazelcast/hazelcast-kubernetes/tree/v1.5.1</a></li>
</ul>

<h4 id="configuració-de-hazelcast-3-11-x-java-6-o-7">Configuració de Hazelcast 3.11.x (java 6 o 7)</h4>

<p>Per configurar Hazelcast a Kubernetes/Openshift cal definir al fitxer xml les següents propietats:</p>

<ul>
<li><strong>group/name</strong> : Defineix el nom del cluster de Hazelcast</li>
<li><strong>properties</strong> : Cal habilitar les estrategies de descobriment afegint la propietat <strong>&lt;property name=&ldquo;hazelcast.discovery.enabled&rdquo;&gt;true&lt;/property&gt;</strong></li>
<li><strong>hazelcast/network/join</strong> : En aquest apartat es defineixen els diferents protocols i serveis que defineixen els nodes del cluster. Pel cas de Kubernetes i Openshift, cal desactivar tots els protocols (<strong>enabled=&ldquo;false&rdquo;</strong>). Addicionalment cal afegir una nova estratègia de descobriment per Kubernetes.</li>
</ul>

<pre><code>&lt;discovery-strategies&gt;
    &lt;discovery-strategy enabled=&quot;true&quot;
        class=&quot;com.hazelcast.kubernetes.HazelcastKubernetesDiscoveryStrategy&quot;&gt;
        &lt;properties&gt;
        &lt;!-- configure discovery service API lookup --&gt;
            &lt;property name=&quot;service-dns&quot;&gt;tomcat-hc2-80java7.proves-ctti.svc.cluster.local&lt;/property&gt;
        &lt;/properties&gt;
    &lt;/discovery-strategy&gt;
</code></pre>

<p>El dns de servei de kubernetes es construeix seguint el patró <strong>&lt;nom_servei&gt;.&lt;nom_namespace&gt;.svc.cluster.local</strong></p>

<pre><code>...
    &lt;hazelcast xmlns=&quot;http://www.hazelcast.com/schema/config&quot;
               xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
               xsi:schemaLocation=&quot;http://www.hazelcast.com/schema/config
               http://www.hazelcast.com/schema/config/hazelcast-config-3.11.xsd&quot;&gt;

        &lt;group&gt;
            &lt;name&gt;test&lt;/name&gt;
        &lt;/group&gt;
        &lt;properties&gt;
            &lt;!-- only necessary prior Hazelcast 3.12 --&gt;
            &lt;property name=&quot;hazelcast.discovery.enabled&quot;&gt;true&lt;/property&gt;
        &lt;/properties&gt;
        &lt;management-center enabled=&quot;false&quot;&gt;http://hazelcast-mc/hazelcast-mancenter&lt;/management-center&gt;
        &lt;network&gt;
            &lt;port auto-increment=&quot;true&quot; port-count=&quot;100&quot;&gt;5701&lt;/port&gt;
            &lt;outbound-ports&gt;
                &lt;!--
                Allowed port range when connecting to other nodes.
                0 or * means use system provided port.
                --&gt;
                &lt;ports&gt;0&lt;/ports&gt;
            &lt;/outbound-ports&gt;
            &lt;join&gt;
                &lt;multicast enabled=&quot;false&quot;/&gt;
                &lt;tcp-ip enabled=&quot;false&quot; /&gt;

                &lt;!-- activate the Kubernetes plugin --&gt;
                &lt;discovery-strategies&gt;
                    &lt;discovery-strategy enabled=&quot;true&quot;
                        class=&quot;com.hazelcast.kubernetes.HazelcastKubernetesDiscoveryStrategy&quot;&gt;

                        &lt;properties&gt;
                        &lt;!-- configure discovery service API lookup --&gt;
                            &lt;property name=&quot;service-dns&quot;&gt;tomcat-hc2-80java7.proves-ctti.svc.cluster.local&lt;/property&gt;
                        &lt;/properties&gt;
                    &lt;/discovery-strategy&gt;
                &lt;/discovery-strategies&gt;
            &lt;/join&gt;
...
</code></pre>

<p>Podeu trobar més informació respecte a la configuració de Hazelcast a:</p>

<ul>
<li><a href="https://github.com/hazelcast/hazelcast/blob/v3.11.4/hazelcast/src/main/resources/hazelcast-full-example.xml">https://github.com/hazelcast/hazelcast/blob/v3.11.4/hazelcast/src/main/resources/hazelcast-full-example.xml</a></li>
<li><a href="https://github.com/hazelcast/hazelcast-kubernetes/tree/v1.3.1">https://github.com/hazelcast/hazelcast-kubernetes/tree/v1.3.1</a></li>
</ul>

<h2 id="exemple">Exemple</h2>

<p>Podeu trobar un exemple de la solució proposada a <a href="https://git.intranet.gencat.cat/3048-intern/imatges-docker/tomcat-hc-test">https://git.intranet.gencat.cat/3048-intern/imatges-docker/tomcat-hc-test</a></p>


					

					
				</div>	

			</article>	


	</section>	

		<div class="fons_footer ">
		<footer class="container center-block shadowBox2">
			<div class="shadow2"></div>
			<div class="row footer_tab_ord">

				<div class="footer_tab_bot col-sm-12">
					<div class="avis_legal">

						<div id="fAvisLegal">
							<div>
								<div class="hidden-xs">
									<a href="https://www.gencat.cat"> <img
										src="/img/logo_generalitat_gris.png_679097835.png"
										width="101" height="27" alt="www.gencat.cat"
										/></a>
									<p>
										<a title="Avis legal" href="https://web.gencat.cat/ca/menu-ajuda/ajuda/avis_legal/" target="_self">Avís legal</a>: La &copy; Generalitat de Catalunya permet la reutilització dels continguts i de les dades sempre que se citi la font i la data d'actualització, que no es desnaturalitzi la informació i que no es contradigui amb una llicència específica.
									</p>
								</div>
								<div class="visible-xs avis_legal">
									<p>
										<a title="Avis legal" href="https://web.gencat.cat/ca/menu-ajuda/ajuda/avis_legal/" target="_self">Avís legal</a>: La &copy; Generalitat de Catalunya permet la reutilització dels continguts i de les dades sempre que se citi la font i la data d'actualització, que no es desnaturalitzi la informació i que no es contradigui amb una llicència específica.
									</p>
								</div>
								
								<div class="fi_peu visible-xs">
									<a title="www.gencat.cat" href="https://www.gencat.cat"> <img
										src="/img/logo_generalitat_gris.png_679097835.png"
										width="101" height="27" 
										alt="www.gencat.cat" /></a> <a class="torna_amunt pull-right"
										href=" javascript:tornarAmunt();" title="Torna amunt">
										<p>Torna amunt</p>
									</a>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</footer>
	</div>

<script src="/js/master.min.js" type="text/javascript"></script>
<script src="https://cdn.jsdelivr.net/algoliasearch/3/algoliasearch.min.js"></script>
<script src="https://cdn.jsdelivr.net/autocomplete.js/0/autocomplete.min.js"></script>
<script src="/js/custom.js" type="text/javascript"></script>



<script type="text/javascript">

if(location.hostname!=="localhost"){

	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

	ga('create', "UA-59408075-1", 'auto');
	ga('send', 'pageview', {
	  	'page': location.pathname + location.search  + location.hash
	  }
	);

}

</script>




</body>
</html>
