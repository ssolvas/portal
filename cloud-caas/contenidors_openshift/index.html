<!DOCTYPE html>
<html xml:lang="ca-ES" lang="ca-ES" xmlns="http://www.w3.org/1999/xhtml">
<head>

	<title>Contenidors Openshift</title>
		<meta charset="UTF-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<link rel="shortcut icon" type="image/x-icon" href="/img/favicon.ico" />
	<link href="/css/master.min.css" rel="stylesheet" type="text/css" />
	<link href="/css/canigo.css" rel="stylesheet" type="text/css" />
	<script src="/js/jquery.min.js" type="text/javascript"></script>

	<script>
		document.write("<meta name=\"titol\" content=\"Contenidors Openshift\" />");
		document.write("<meta name=\"description\" content=\"Consideracions i exemples respecte els contenidors a Openshift\" />");
	</script>

	

</head>
<body class="single">
	<div class="contenidor unfixed">

				

		<header class="fons_header navbar navbar-default z-index-menu">
			<div class="container" role="menu">
				<div class="row clearfix menuNav">
					<div class="col-md-3 col-xs-3 column visible-xs coloca ">
						<button type="button" onclick="amunt();" title="Menu"
							class="navbar-toggle pull-left" data-toggle="collapse"
							data-target=".navbar-collapse">
							<span class="sr-only">Toggle navigation</span> <span
								class="icon-bar"></span> <span class="icon-bar"></span> <span
								class="icon-bar"></span>
						</button>
					</div>

					<div class="col-md-3 col-xs-6 col-offset-2 column visible-xs titol-mobil">
						
						<span class="white titol-mobil-destacat">canigo.ctti</span><span class="white">.gencat.cat</span>
					</div>

					<div class="col-md-3 col-xs-3 column visible-xs coloca1">
						<button onclick="amunt();" type="button" title="Cerca"
							class="ico_cerca " data-toggle="collapse" data-target=".dos">
						</button>
					</div>

				</div>

				<div class="collapse dos">
					<div class="shadowBox">
						<form class="navbar-form navbar-left primer" action="/cercador/" method="get"
 						onsubmit="location.href=this.action+'?q='+this.cerca_cap.value; return false;">
							<div class="form-group">
								<input type="search" class="form-control" name="q" id="cerca_cap"
									title="Cerca"
									placeholder="Cerca" />
								<button type="button" title="Neteja" class="btn btn-default"></button>
								<input type="submit" class="ocult" name="Cerca" value="Cerca" />
							</div>
						</form>
					</div>
				</div>	

				<nav class="collapse navbar-collapse navbar-ex1-collapse ">
				
					<div class="row">
						<div class="col-md-6 col-sm-4 column">
							<a class="img-responsive logo" title="Generalitat de Catalunya"
								href="https://ctti.gencat.cat/">gencat.cat</a>
							<button class="menu_tancar visible-xs collapsed"
								data-target=".navbar-collapse" data-toggle="collapse"
								title="Tancar"></button>
						</div>

						<div class="col-md-6 col-sm-8 column hidden-xs hidden-mg">
							<form class="navbar-form cercador_vermell hidden-xs pull-right" action="/cercador/"  method="get" onsubmit="location.href=this.action+'?q='+this.cerca2.value; return false;">
								<div class="form-group">
									<label class="hidden" for="cerca2">Cerca</label>
									<input id="cerca2" class="form-control" type="search" 
									placeholder="Cerca" name="q" title="Cerca">
									<input class="btn btn-default" type="submit" title="Cerca" value="">
								</div>
							</form>

							

						</div>

					</div>
					<div class="col-xs-12 hidden-xs" id="nomPortal">
                    	<span class="titol-cap-nou">Centre de Telecomunicacions i Tecnologies de la Informació</span>
                    </div>					
					<ul class="nav navbar-nav">

			        	

						<li>
							<a class="dropdown-toggle" href='/' data-toggle='_dropdown'>Inici</a>
						</li>

						

						<li>
							<a class="dropdown-toggle" href='/arqctti' data-toggle='_dropdown'>Arquitectura CTTI</a>
						</li>

						

						<li>
							<a class="dropdown-toggle" href='/blog' data-toggle='_dropdown'>Blog</a>
						</li>

						

						<li>
							<a class="dropdown-toggle" href='/cloud' data-toggle='_dropdown'>Cloud</a>
						</li>

						

						<li>
							<a class="dropdown-toggle" href='/canigo' data-toggle='_dropdown'>Canigó</a>
						</li>

						

						<li>
							<a class="dropdown-toggle" href='/sic' data-toggle='_dropdown'>SIC</a>
						</li>

						

						<li>
							<a class="dropdown-toggle" href='/sgde' data-toggle='_dropdown'>SGDE</a>
						</li>

						

						<li>
							<a class="dropdown-toggle" href='/gicar' data-toggle='_dropdown'>GICAR</a>
						</li>

						

						<li>
							<a class="dropdown-toggle" href='/cs' data-toggle='_dropdown'>Centres de Suport</a>
						</li>

						

						<li>
							<a class="dropdown-toggle" href='/dadesref' data-toggle='_dropdown'>Gestió Tècnica de Dades</a>
						</li>

						

					</ul>

				</nav>
			</div>
		</header>



	</div>

	<section class="border-start">

						
			

			<article class="bgGrey">
				<div class="container">
					<div class="row">
						<div class="capcelera_basica col-sm-12">
							<div class="capcelera_basica_cont">
								<ol class="breadcrumb filariana hidden-xs">
									<li>
										<a href="/">Inici</a>
									</li>
									<li class="breadcrumbs2">
									
										<a href="/cloud-caas">
											




























										</a>
										




























































































									
									</li>

								</ol>

								<h1 class="capcelera_flotant pull-left" data-txt=".title">
									

										
											




	Contenidors Openshift


										

									
								</h1>

								

								
								

								

								

							</div>
						</div>

					</div>
				</div>
			</article>

			


		   <div class="padding-xs container">
	    	
	    	   <i><b>Darrera actualització:</b></i> 10-09-2021
	        
           </div>
           
			<article class="padding-xs padding-sm padding-md contingut">				
				<div class="container">
 		
					
				

	


					

						

<h2 id="introducció">Introducció</h2>

<p>Openshift és un orquestrador d&rsquo;imatges docker basat en Kubernetes.
Actualment a la Generalitat de Catalunya existeixen diverses plataformes Opneshift:</p>

<ul>
<li><strong>Openshift 4</strong>. OpenShift Container Platform 4.6 i Kubernetes 1.19. Disponible a CPD2, CPD3 i CPD4.</li>
</ul>

<p>Les plataformes <strong>Openshift 4</strong> permeten l&rsquo;ús de <strong>Service Mesh</strong> sent aptes per desplegar aplicacions basades en Microserveis. Podeu trobar més informació a <a href="https://canigo.ctti.gencat.cat/cloud-caas/service_mesh/">Openshift Service Mesh</a>.</p>

<p>En aquest article es defineix l&rsquo;arquitectura tipus d&rsquo;una aplicació a Openshift i es proporcionen diversos exemples.</p>

<h2 id="imatges">Imatges</h2>

<p>A l&rsquo;hora de construir les imatges docker, cal tenir present els criteris definits per la Generalitat de Catalunya i que Openshift, tot i que està basat en docker, té les seves particularitats.</p>

<p>A la plana <a href="https://canigo.ctti.gencat.cat/cloud-caas/dockerImages/">Criteris creació contenidors docker</a> podeu trobar més informació al respecte.</p>

<h2 id="arquitectura">Arquitectura</h2>

<h3 id="conceptes-bàsics">Conceptes bàsics</h3>

<p>L&rsquo;arquitectura bàsica d&rsquo;una aplicació a Openshift és bàsicament la mateixa que la de Kubernetes, però amb algunes petites particularitats.
A grans trets es poden distingir els següents components:</p>

<ul>
<li><strong>Enrutador:</strong> És el punt d&rsquo;entrada i sortida del tràfic http/https de la plataforma i l&rsquo;exterior. És responsable d&rsquo;enrutar el tràfic a cada contenidor concret. Seria equivalent al Ingres Controller de Kubernetes.</li>
<li><strong>Ruta:</strong> És l&rsquo;element de configuració on és defineix quin domini correspondrà a un Servei. Permet també la configuració del SSL. Informa al Enrutador per a que aquest pugui redirigir el tràfic correctament. Seria equivament al Ingress de Kubernetes</li>
<li><strong>Servei:</strong> És l&rsquo;element de configuració que permet exposar un servei basat en contenidors dins de la plataforma Openshift. Permet mapping de ports</li>

<li><p><strong>Desplegament:</strong> És l&rsquo;element de configuració que defineix com es desplegaran els contenidors:</p>

<ul>
<li>Nombre de rèpliques</li>
<li>Imatge a desplegar</li>
<li>Polítiques de recàrrega</li>
<li>Quotes</li>
<li>Variables d&rsquo;entorn</li>
<li>Ports</li>
<li>Emmagatzematge lògic</li>
<li>Health checks</li>
<li>&hellip;</li>
</ul></li>

<li><p><strong>Controlador:</strong> És el component responsable de mantenir els contenidors sempre disponibles seguint els paràmetres configurats al Desplegament.</p></li>

<li><p><strong>Pod:</strong> És el conjunt de contenidors que tenen el mateix cicle de vida i és necessari desplegar sempre conjuntament.</p></li>

<li><p><strong>Contenidor:</strong> És el component mínim de la plataforma. És el contenidor docker.</p></li>

<li><p><strong>Petició d&rsquo;emmagatzematge:</strong> S&rsquo;utilitza quan és necessari emmagatzematge persistent. És l&rsquo;element de configuració que actua de pont entre l&rsquo;emmagatzematge físic i l&rsquo;emmagatzematge lògic.</p></li>

<li><p><strong>Emmagatzematge:</strong> És l&rsquo;element de configuració responsable de definir l&rsquo;emmagatzematge físic.</p></li>

<li><p><strong>Secret:</strong> És l&rsquo;element de configuració responsable de gestionar els elements de configuració amb informació sensible, com poden ser contrasenyes.</p></li>

<li><p><strong>Mapa de configuració:</strong> Permet agrupar múltiples variables de configuració. Seria equivalent a un fitxer de propietats en una aplicació.</p></li>
</ul>

<h3 id="arquitectura-openshift">Arquitectura Openshift</h3>

<p>A continuació es realitza la correlació entre els diferents components arquitectònics i els elements concrets a Openshift.</p>

<table>
<thead>
<tr>
<th align="left">Component genèric</th>
<th align="left">Component Openshift</th>
<th align="left">Observacions</th>
</tr>
</thead>

<tbody>
<tr>
<td align="left">Enrutador</td>
<td align="left">Router</td>
<td align="left">És gestionat per l&rsquo;administrador de la plataforma. A nivell d&rsquo;aplicació no és necessari configurar res.</td>
</tr>

<tr>
<td align="left">Ruta</td>
<td align="left">Route</td>
<td align="left">A nivell d&rsquo;aplicació cal definir un fitxer yaml de configuració.</td>
</tr>

<tr>
<td align="left">Servei</td>
<td align="left">Service</td>
<td align="left">A nivell d&rsquo;aplicació cal definir un fitxer yaml de configuració.</td>
</tr>

<tr>
<td align="left">Desplegament</td>
<td align="left">DeploymentConfig</td>
<td align="left">A nivell d&rsquo;aplicació cal definir un fitxer yaml de configuració.</td>
</tr>

<tr>
<td align="left">Controlador</td>
<td align="left">ReplicationController</td>
<td align="left">És generat directament pel DeploymentConfig. No és necessari configurar res.</td>
</tr>

<tr>
<td align="left">Pod</td>
<td align="left">Pod</td>
<td align="left">És generat directament pel ReplicationController. No és necessari configurar res.</td>
</tr>

<tr>
<td align="left">Contenidor</td>
<td align="left">Container</td>
<td align="left">És generat directament pel Pod. No és necessari configurar res.</td>
</tr>

<tr>
<td align="left">Petició d&rsquo;emmagatzematge</td>
<td align="left">PersistentVolumeClaim</td>
<td align="left">A nivell d&rsquo;aplicació cal definir un fitxer yaml de configuració.</td>
</tr>

<tr>
<td align="left">Emmagatzematge</td>
<td align="left">PersistentVolume</td>
<td align="left">És gestionat per l&rsquo;administrador de la plataforma. A nivell d&rsquo;aplicació no és necessari configurar res. Cal fer una petició al fer la sol·licitut inicial de recursos.</td>
</tr>

<tr>
<td align="left">Secret</td>
<td align="left">Secret</td>
<td align="left">A nivell d&rsquo;aplicació cal definir un fitxer yaml de configuració.</td>
</tr>

<tr>
<td align="left">Mapa de configuració</td>
<td align="left">ConfigMap</td>
<td align="left">A nivell d&rsquo;aplicació cal definir un fitxer yaml de configuració.</td>
</tr>
</tbody>
</table>

<p><img src="/related/cloud/ArquitecturaOpenshift.png" alt="Components Openshift" /></p>

<h2 id="informació-necessària-al-crear-l-aplicació">Informació necessària al crear l&rsquo;aplicació</h2>

<p>Quan és sol·licita la creació d&rsquo;una aplicació a Openshift és necessària la següent informació:</p>

<ul>
<li><strong>Unitats i mida de discos persistents</strong> necessaris. Amb aquesta informació l&rsquo;administrador de la plataforma crearà els PersistentVolume necessaris i farà arribar als responsables de l&rsquo;aplicació el nom d&rsquo;aquests Volums.</li>
<li><strong>Memòria RAM</strong> total necessària per tots els contenidors de l&rsquo;aplicació. Amb aquesta informació s&rsquo;assignarà una CPU proporcional i es definiran les quotes globals de l&rsquo;aplicació.</li>
</ul>

<h2 id="exemples">Exemples</h2>

<h3 id="persistentvolumeclaim">PersistentVolumeClaim</h3>

<p>En una aplicació el primer element que cal configurar és el PersistentVolumeClaim. Mapejarà PersistentVolume amb el volumes lògics que s&rsquo;utilitzaran als pods.</p>

<p>Tenint present que el PersistentVolume s&rsquo;anomena per exemple <strong>XXXX-app1-data01-pre</strong> el fitxer yaml seria:</p>

<pre><code>apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: XXXX-app1-data01-claim
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 1Gi
  volumeName: XXXX-app1-data01-pre
</code></pre>

<h3 id="deploymentconfig">DeploymentConfig</h3>

<p>El DeploymentConfig és el principal element de configuració de l&rsquo;aplicació.</p>

<p>Configuració de l&rsquo;exemple:</p>

<ul>
<li>Nom del projecte: <strong>XXXX-app1-pre</strong></li>
<li>Nom de l&rsquo;aplicació: <strong>XXXX-app1-server</strong></li>
<li>Nom del deploymentConfig: <strong>XXXX-app1-server-deployment</strong></li>
<li>Nombre de rèpliques: <strong>2</strong></li>
<li><strong>El pod conté un únic contenidor</strong>.</li>
<li>Estratègia de desplegament: <strong>Rolling</strong>. No es recomana modificar, ni variar els seus paràmetres.</li>
<li>Quotes: <strong>100 milicores de CPU</strong> i <strong>1024Mb de RAM</strong></li>
<li>Nom de la imatge dels contenidors: <strong>XXXX-app1-pre/XXXX-app1-server:1.0.0</strong></li>

<li><p>Variables d&rsquo;entorn dels contenidors:</p>

<ul>
<li><strong>ENV1_NAME</strong> amb valor <strong>env1_value</strong></li>
<li><strong>ENV2_NAME</strong> amb valor <strong>env2_value</strong></li>
</ul></li>

<li><p>Port del contenidor: <strong>8080</strong></p></li>

<li><p><strong>readinessProbe</strong> per identificar quan es pot començar a enviar peticions al contenidor.</p></li>

<li><p><strong>livenessProbe</strong> per identificar quan cal reiniciar el contenidor.</p></li>

<li><p>Volum persistit: dins del contenidor es monta a <strong>/data</strong>. Fà referència al PersistentVolumeClaim anomenat <strong>XXXX-app1-data01-claim</strong> (creat a l&rsquo;exemple anterior)</p></li>
</ul>

<pre><code>apiVersion: apps.openshift.io/v1
kind: DeploymentConfig
metadata:
  labels:
    app: XXXX-app1-server
  name: XXXX-app1-server-deployment
spec:
  replicas: 2
  selector:
    app: XXXX-app1-server
    deploymentconfig: XXXX-app1-server-deployment
  strategy:
    type: Rolling
    rollingParams:
      updatePeriodSeconds: 1
      intervalSeconds: 1
      timeoutSeconds: 600
      maxUnavailable: 25%
      maxSurge: 25%
    resources:
      limits:
          cpu: 0
          memory: 0
      requests:
          cpu: 0
          memory: 0
  template:
    metadata:
      labels:
        app: XXXX-app1-server
        deploymentconfig: XXXX-app1-server-deployment
    spec:
      containers:
      - image: image-registry.openshift-image-registry.svc:5000/XXXX-app1-pre/XXXX-app1-server:1.0.0
        name: XXXX-app1-server
        env:
        - name: ENV1_NAME
          value: env1_value
        - name: ENV2_NAME
          value: env2_value
        ports:
        - containerPort: 8080
          protocol: TCP
        resources:
          limits:
              cpu: 100m
              memory: 1024Mi
          requests:
              cpu: 100m
              memory: 1024Mi
        readinessProbe:
          httpGet:
              path: /healthz
              port: 8080
          initialDelaySeconds: 15
          timeoutSeconds: 1
        livenessProbe:
          tcpSocket:
              port: 8080
          initialDelaySeconds: 15
          timeoutSeconds: 1
        volumeMounts:
            - name: XXXX-app1-server-volume
              mountPath: /data
      terminationGracePeriodSeconds: 60
      volumes:
        - name: XXXX-app1-server-volume
          persistentVolumeClaim:
            claimName: XXXX-app1-data01-claim
  test: false
  triggers:
  - type: ConfigChange
  - imageChangeParams:
      automatic: true
      containerNames:
      - XXXX-app1-server
      from:
        kind: ImageStreamTag
        name: XXXX-app1-server:1.0.0
        namespace: XXXX-app1-pre
    type: ImageChange
</code></pre>

<h3 id="service">Service</h3>

<p>A l&rsquo;exemple es crea un servei per el DeploymentConfig creat anteriorment.</p>

<p>Openshift només suporta serveis amb protocol HTTP/HTTPS, no suporta altres protocols, com per exemple SSH, JDBC, &hellip;</p>

<p>Configuració de l&rsquo;exemple:</p>

<ul>
<li>Port exposat per servei: <strong>80</strong></li>
<li>Port intern dels pods: <strong>8080</strong></li>
</ul>

<pre><code>apiVersion: v1
kind: Service
metadata:
  labels:
    app: XXXX-app1-server
  name: XXXX-app1-server
spec:
  ports:
  - name: 80-tcp
    port: 80
    protocol: TCP
    targetPort: 8080
  selector:
    app: XXXX-app1-server
    deploymentconfig:  XXXX-app1-server-deployment
</code></pre>

<h3 id="route">Route</h3>

<p>A l&rsquo;exemple es crea una ruta pel servei creat anteriorment.</p>

<p>Configuració de l&rsquo;exemple:</p>

<ul>
<li>host: <strong>app1-server.gencat.cat</strong></li>
</ul>

<pre><code>apiVersion: v1
kind: Route
metadata:
  name: app1-route
  namespace: XXXX-app1-pre
  labels:
    app: app1-server
spec:
  host: app1-server.gencat.cat
  to:
    kind: Service
    name:  XXXX-app1-server
    weight: 100
  port:
    targetPort: 80-tcp
  wildcardPolicy: None
</code></pre>

<h2 id="informació-relacionada">Informació relacionada</h2>

<ul>
<li><a href="https://docs.openshift.com/container-platform/4.6/welcome/index.html">https://docs.openshift.com/container-platform/4.6/welcome/index.html</a></li>
</ul>


					

					
				</div>	

			</article>	


	</section>	

		<div class="fons_footer ">
		<footer class="container center-block shadowBox2">
			<div class="shadow2"></div>
			<div class="row footer_tab_ord">

				<div class="footer_tab_bot col-sm-12">
					<div class="avis_legal">

						<div id="fAvisLegal">
							<div>
								<div class="hidden-xs">
									<a href="https://www.gencat.cat"> <img
										src="/img/logo_generalitat_gris.png_679097835.png"
										width="101" height="27" alt="www.gencat.cat"
										/></a>
									<p>
										<a title="Avis legal" href="https://web.gencat.cat/ca/menu-ajuda/ajuda/avis_legal/" target="_self">Avís legal</a>: La &copy; Generalitat de Catalunya permet la reutilització dels continguts i de les dades sempre que se citi la font i la data d'actualització, que no es desnaturalitzi la informació i que no es contradigui amb una llicència específica.
									</p>
								</div>
								<div class="visible-xs avis_legal">
									<p>
										<a title="Avis legal" href="https://web.gencat.cat/ca/menu-ajuda/ajuda/avis_legal/" target="_self">Avís legal</a>: La &copy; Generalitat de Catalunya permet la reutilització dels continguts i de les dades sempre que se citi la font i la data d'actualització, que no es desnaturalitzi la informació i que no es contradigui amb una llicència específica.
									</p>
								</div>
								
								<div class="fi_peu visible-xs">
									<a title="www.gencat.cat" href="https://www.gencat.cat"> <img
										src="/img/logo_generalitat_gris.png_679097835.png"
										width="101" height="27" 
										alt="www.gencat.cat" /></a> <a class="torna_amunt pull-right"
										href=" javascript:tornarAmunt();" title="Torna amunt">
										<p>Torna amunt</p>
									</a>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</footer>
	</div>

<script src="/js/master.min.js" type="text/javascript"></script>
<script src="https://cdn.jsdelivr.net/algoliasearch/3/algoliasearch.min.js"></script>
<script src="https://cdn.jsdelivr.net/autocomplete.js/0/autocomplete.min.js"></script>
<script src="/js/custom.js" type="text/javascript"></script>



<script type="text/javascript">

if(location.hostname!=="localhost"){

	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

	ga('create', "UA-59408075-1", 'auto');
	ga('send', 'pageview', {
	  	'page': location.pathname + location.search  + location.hash
	  }
	);

}

</script>




</body>
</html>
