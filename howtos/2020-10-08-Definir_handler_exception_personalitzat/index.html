<!DOCTYPE html>
<html xml:lang="ca-ES" lang="ca-ES" xmlns="http://www.w3.org/1999/xhtml">
<head>

	<title>Canigó. Com definir handler exception personalitzat</title>
		<meta charset="UTF-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<link rel="shortcut icon" type="image/x-icon" href="/img/favicon.ico" />
	<link href="/css/master.min.css" rel="stylesheet" type="text/css" />
	<link href="/css/canigo.css" rel="stylesheet" type="text/css" />
	<script src="/js/jquery.min.js" type="text/javascript"></script>

	<script>
		document.write("<meta name=\"titol\" content=\"Canigó. Com definir handler exception personalitzat\" />");
		document.write("<meta name=\"description\" content=\"Howto per a definir un handler d\x27excepció personalitzat\" />");
	</script>

	

</head>
<body class="single">
	<div class="contenidor unfixed">

				

		<header class="fons_header navbar navbar-default z-index-menu">
			<div class="container" role="menu">
				<div class="row clearfix menuNav">
					<div class="col-md-3 col-xs-3 column visible-xs coloca ">
						<button type="button" onclick="amunt();" title="Menu"
							class="navbar-toggle pull-left" data-toggle="collapse"
							data-target=".navbar-collapse">
							<span class="sr-only">Toggle navigation</span> <span
								class="icon-bar"></span> <span class="icon-bar"></span> <span
								class="icon-bar"></span>
						</button>
					</div>

					<div class="col-md-3 col-xs-6 col-offset-2 column visible-xs titol-mobil">
						
						<span class="white titol-mobil-destacat">canigo.ctti</span><span class="white">.gencat.cat</span>
					</div>

					<div class="col-md-3 col-xs-3 column visible-xs coloca1">
						<button onclick="amunt();" type="button" title="Cerca"
							class="ico_cerca " data-toggle="collapse" data-target=".dos">
						</button>
					</div>

				</div>

				<div class="collapse dos">
					<div class="shadowBox">
						<form class="navbar-form navbar-left primer" action="/cercador/" method="get"
 						onsubmit="location.href=this.action+'?q='+this.cerca_cap.value; return false;">
							<div class="form-group">
								<input type="search" class="form-control" name="q" id="cerca_cap"
									title="Cerca"
									placeholder="Cerca" />
								<button type="button" title="Neteja" class="btn btn-default"></button>
								<input type="submit" class="ocult" name="Cerca" value="Cerca" />
							</div>
						</form>
					</div>
				</div>	

				<nav class="collapse navbar-collapse navbar-ex1-collapse ">
				
					<div class="row">
						<div class="col-md-6 col-sm-4 column">
							<a class="img-responsive logo" title="Generalitat de Catalunya"
								href="https://ctti.gencat.cat/">gencat.cat</a>
							<button class="menu_tancar visible-xs collapsed"
								data-target=".navbar-collapse" data-toggle="collapse"
								title="Tancar"></button>
						</div>

						<div class="col-md-6 col-sm-8 column hidden-xs hidden-mg">
							<form class="navbar-form cercador_vermell hidden-xs pull-right" action="/cercador/"  method="get" onsubmit="location.href=this.action+'?q='+this.cerca2.value; return false;">
								<div class="form-group">
									<label class="hidden" for="cerca2">Cerca</label>
									<input id="cerca2" class="form-control" type="search" 
									placeholder="Cerca" name="q" title="Cerca">
									<input class="btn btn-default" type="submit" title="Cerca" value="">
								</div>
							</form>

							

						</div>

					</div>
					<div class="col-xs-12 hidden-xs" id="nomPortal">
                    	<span class="titol-cap-nou">Centre de Telecomunicacions i Tecnologies de la Informació</span>
                    </div>					
					<ul class="nav navbar-nav">

			        	

						<li>
							<a class="dropdown-toggle" href='/' data-toggle='_dropdown'>Inici</a>
						</li>

						

						<li>
							<a class="dropdown-toggle" href='/arqctti' data-toggle='_dropdown'>Arquitectura CTTI</a>
						</li>

						

						<li>
							<a class="dropdown-toggle" href='/blog' data-toggle='_dropdown'>Blog</a>
						</li>

						

						<li>
							<a class="dropdown-toggle" href='/cloud' data-toggle='_dropdown'>Cloud</a>
						</li>

						

						<li>
							<a class="dropdown-toggle" href='/canigo' data-toggle='_dropdown'>Canigó</a>
						</li>

						

						<li>
							<a class="dropdown-toggle" href='/sic' data-toggle='_dropdown'>SIC</a>
						</li>

						

						<li>
							<a class="dropdown-toggle" href='/sgde' data-toggle='_dropdown'>SGDE</a>
						</li>

						

						<li>
							<a class="dropdown-toggle" href='/gicar' data-toggle='_dropdown'>GICAR</a>
						</li>

						

						<li>
							<a class="dropdown-toggle" href='/cs' data-toggle='_dropdown'>Centres de Suport</a>
						</li>

						

						<li>
							<a class="dropdown-toggle" href='/dadesref' data-toggle='_dropdown'>Gestió Tècnica de Dades</a>
						</li>

						

						<li>
							<a class="dropdown-toggle" href='/eventhub' data-toggle='_dropdown'>EventHub</a>
						</li>

						

					</ul>

				</nav>
			</div>
		</header>



	</div>

	<section class="border-start">

						
			

			<article class="bgGrey">
				<div class="container">
					<div class="row">
						<div class="capcelera_basica col-sm-12">
							<div class="capcelera_basica_cont">
								<ol class="breadcrumb filariana hidden-xs">
									<li>
										<a href="/">Inici</a>
									</li>
									<li class="breadcrumbs2">
									
										<a href="/howtos">
											











	How to


















										</a>
										




























































































									
									</li>

								</ol>

								<h1 class="capcelera_flotant pull-left" data-txt=".title">
									

										
											




	Canigó. Com definir handler exception personalitzat


										

									
								</h1>

								

								
								

								

								

							</div>
						</div>

					</div>
				</div>
			</article>

			


		   <div class="padding-xs container">
	    	
	    	   <i><b>Darrera actualització:</b></i> 08-10-2020
	        
           </div>
           
			<article class="padding-xs padding-sm padding-md contingut">				
				<div class="container">
 		
					
				

	


					

						

<h2 id="introducció">Introducció</h2>

<p>Canigó proporciona una sèrie objectes i handlers per a la gestió d&rsquo;excepcions al <a href="/canigo-documentacio-versions-34-core/modul-excepcions/">Mòdul d&rsquo;excepcions</a>
incloent, per defecte, una gestió de les excepcions base més comunes. En aquest how-to explicarem:</p>

<ul>
<li>1. Com personalitzar la gestió de les excepcions base més comunes,</li>
<li>2. Com definir un handler per una excepció base sense gestió per defecte,</li>
<li>3. Com definir una excepció pròpia i definir-li un handler</li>
</ul>

<p>Tal i com es detalla al <a href="/canigo-documentacio-versions-34-core/modul-excepcions/">Mòdul d&rsquo;excepcions</a>, l&rsquo;objecte
<em>cat.gencat.ctti.canigo.arch.web.rs.controller.exception.handler.GlobalDefaultExceptionHandler</em> conté els diferents handlers
per a la gestió per defecte de les excepcions base més comunes. Així si, per exemple tenim una excepció a l&rsquo;aplicació de
tipus <em>java.lang.Exception</em>, el servei Rest podria retornar quelcom similar a:</p>

<pre><code>Response Body
{
  &quot;errors&quot;: [
    {
      &quot;code&quot;: 500,
      &quot;message&quot;: &quot;Error obtenint les dades!!&quot;
    }
  ]
}
Response Code
500
Response Headers
{
  &quot;cache-control&quot;: &quot;no-cache, no-store, max-age=0, must-revalidate&quot;,
  &quot;connection&quot;: &quot;close&quot;,
  &quot;content-type&quot;: &quot;application/json;charset=UTF-8&quot;,
  &quot;date&quot;: &quot;Thu, 08 Oct 2020 06:11:37 GMT&quot;,
  &quot;expires&quot;: &quot;0&quot;,
  &quot;pragma&quot;: &quot;no-cache&quot;,
  &quot;transfer-encoding&quot;: &quot;chunked&quot;,
  &quot;x-content-type-options&quot;: &quot;nosniff&quot;,
  &quot;x-xss-protection&quot;: &quot;1; mode=block&quot;
}
</code></pre>

<h2 id="personalitzar-la-gestió-de-les-excepcions-base-més-comunes">Personalitzar la gestió de les excepcions base més comunes</h2>

<p>Si per una excepció de tipus <em>java.lang.Exception</em> volguéssim retornar a la propietat codi de l&rsquo;objecte
<em>cat.gencat.ctti.canigo.arch.web.rs.response.ResponseError</em> de la response un text internacionalitzat,
hauríem de definir un handler propi a l&rsquo;aplicació que estengués de <em>cat.gencat.ctti.canigo.arch.web.rs.controller.exception.handler.GlobalDefaultExceptionHandler</em>
i reimplementar el mètode que es vol personalitzar, en aquest cas, <em>defaultErrorHandlerException</em>.</p>

<p>Per exemple:</p>

<pre><code>import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.web.bind.annotation.RestControllerAdvice;

import cat.gencat.ctti.canigo.arch.web.rs.controller.exception.handler.GlobalDefaultExceptionHandler;
import cat.gencat.ctti.canigo.arch.web.rs.response.ResponseError;

@RestControllerAdvice
public class CustomExceptionHandler extends GlobalDefaultExceptionHandler {

    /** Constant LOGGER. */
    private static final Logger LOGGER = LoggerFactory.getLogger(CustomExceptionHandler.class);

    /**
     * Custom error handler exception.
     *
     * @param request
     * @param response
     * @param e
     * @return response error
     */
    @Override
    public ResponseError defaultErrorHandlerException(final HttpServletRequest request,
            final HttpServletResponse response, final Exception e) {
        if (LOGGER.isErrorEnabled()) {
            LOGGER.error(e.getMessage(), e);
        }
        return new ResponseError(999, getMesssage(e.getLocalizedMessage(), null, e.getLocalizedMessage()));
    }

}
</code></pre>

<p>On estem retornant el codi 999 en el body de la resposta (tot i que la millor estratègia seria tenir-ho a un objecte de constants d&rsquo;error)
obtenint el següent:</p>

<pre><code>Response Body
{
  &quot;errors&quot;: [
    {
      &quot;code&quot;: 999,
      &quot;message&quot;: &quot;Error obtenint les dades!!&quot;
    }
  ]
}
Response Code
500
Response Headers
{
  &quot;cache-control&quot;: &quot;no-cache, no-store, max-age=0, must-revalidate&quot;,
  &quot;connection&quot;: &quot;close&quot;,
  &quot;content-type&quot;: &quot;application/json;charset=UTF-8&quot;,
  &quot;date&quot;: &quot;Thu, 08 Oct 2020 07:30:21 GMT&quot;,
  &quot;expires&quot;: &quot;0&quot;,
  &quot;pragma&quot;: &quot;no-cache&quot;,
  &quot;transfer-encoding&quot;: &quot;chunked&quot;,
  &quot;x-content-type-options&quot;: &quot;nosniff&quot;,
  &quot;x-xss-protection&quot;: &quot;1; mode=block&quot;
}
</code></pre>

<h2 id="definir-un-handler-per-una-excepció-base-sense-gestió-per-defecte">Definir un handler per una excepció base sense gestió per defecte</h2>

<p>Si volem, per exemple, retornar un codi d&rsquo;error en concret per les excepcions base <em>cat.gencat.ctti.canigo.arch.core.exceptions.CoreException</em>,
serà  necessari definir un nou &ldquo;@ExceptionHandler&rdquo;.</p>

<p>Per exemple:</p>

<pre><code>import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.http.HttpStatus;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.bind.annotation.ResponseStatus;
import org.springframework.web.bind.annotation.RestControllerAdvice;

import cat.gencat.ctti.canigo.arch.core.exceptions.CoreException;
import cat.gencat.ctti.canigo.arch.web.rs.controller.exception.handler.GlobalDefaultExceptionHandler;
import cat.gencat.ctti.canigo.arch.web.rs.response.ResponseError;

@RestControllerAdvice
public class CustomExceptionHandler extends GlobalDefaultExceptionHandler {

    /** Constant LOGGER. */
    private static final Logger LOGGER = LoggerFactory.getLogger(CustomExceptionHandler.class);

    /**
     * Custom error handler exception.
     *
     * @param request
     * @param response
     * @param e
     * @return response error
     */
    @Override
    public ResponseError defaultErrorHandlerException(final HttpServletRequest request,
            final HttpServletResponse response, final Exception e) {
        if (LOGGER.isErrorEnabled()) {
            LOGGER.error(e.getMessage(), e);
        }
        return new ResponseError(999, getMesssage(e.getLocalizedMessage(), null, e.getLocalizedMessage()));
    }

    /**
     * Custom error handler core exception.
     *
     * @param request request
     * @param response response
     * @param CoreException e
     * @return response error
     */
    @ExceptionHandler(CoreException.class)
    @ResponseStatus(value = HttpStatus.INTERNAL_SERVER_ERROR)
    public ResponseError defaultErrorHandlerCoreException(final HttpServletRequest request,
            final HttpServletResponse response, final CoreException e) {
        if (LOGGER.isErrorEnabled()) {
            LOGGER.error(e.getMessage(), e);
        }
        return new ResponseError(888, getMesssage(e.getExceptionDetails().getErrorCode(), null, e.getExceptionDetails().getErrorCode()));
    }

}
</code></pre>

<p>D&rsquo;aquesta forma, la resposta seria quelcom similar a:</p>

<pre><code>Response Body
{
  &quot;errors&quot;: [
    {
      &quot;code&quot;: 888,
      &quot;message&quot;: &quot;Error obtenint les dades!!&quot;
    }
  ]
}
Response Code
500
Response Headers
{
  &quot;cache-control&quot;: &quot;no-cache, no-store, max-age=0, must-revalidate&quot;,
  &quot;connection&quot;: &quot;close&quot;,
  &quot;content-type&quot;: &quot;application/json;charset=UTF-8&quot;,
  &quot;date&quot;: &quot;Thu, 08 Oct 2020 07:49:09 GMT&quot;,
  &quot;expires&quot;: &quot;0&quot;,
  &quot;pragma&quot;: &quot;no-cache&quot;,
  &quot;transfer-encoding&quot;: &quot;chunked&quot;,
  &quot;x-content-type-options&quot;: &quot;nosniff&quot;,
  &quot;x-xss-protection&quot;: &quot;1; mode=block&quot;
}
</code></pre>

<h2 id="definir-una-excepció-pròpia-i-definir-li-un-handler">Definir una excepció pròpia i definir-li un handler</h2>

<p>Si es necessita retornar un codi http i d&rsquo;error al body de la resposta que sigui propi per a una part específica del negoci de l&rsquo;aplicació,
s&rsquo;ha de definir una excepció pròpia a l&rsquo;aplicació i definir-li un handler. Així si, donat el cas volem tenir una excepció per les validacions dels serveis Rest,
podem definir una excepció amb nom <em>ValidationException</em>.</p>

<p>Per exemple:</p>

<pre><code>import cat.gencat.ctti.canigo.arch.core.exceptions.BaseException;

/**
 * The Class ValidationException.
 */
public class ValidationException extends BaseException {

    /**
     * Constructor
     *
     * @param anErrorCode
     *            Error Code of exception. It is recommended to use a class of
     *            constants where this error code is defined
     */
    private static final long serialVersionUID = -298400707932570360L;

    public ValidationException(String anErrorCode) {
        super(anErrorCode);
    }

    /**
     * Constructor for use message argument and errorCode
     *
     * @param message
     * @param anErrorCode
     */
    public ValidationException(String message, String anErrorCode) {
        super(message, anErrorCode);
    }

}
</code></pre>

<p>I definir el handler per a aquesta nova excepció:</p>

<pre><code>import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.http.HttpStatus;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.bind.annotation.ResponseStatus;
import org.springframework.web.bind.annotation.RestControllerAdvice;

import cat.gencat.ctti.canigo.arch.core.exceptions.CoreException;
import cat.gencat.ctti.canigo.arch.web.rs.controller.exception.handler.GlobalDefaultExceptionHandler;
import cat.gencat.ctti.canigo.arch.web.rs.response.ResponseError;
import cat.gencat.intcan2027.exception.ValidationException;

@RestControllerAdvice
public class CustomExceptionHandler extends GlobalDefaultExceptionHandler {

    /** Constant LOGGER. */
    private static final Logger LOGGER = LoggerFactory.getLogger(CustomExceptionHandler.class);

    /**
     * Custom error handler exception.
     *
     * @param request
     *            request
     * @param response
     *            response
     * @param e
     *            e
     * @return response error
     */
    @Override
    public ResponseError defaultErrorHandlerException(final HttpServletRequest request,
            final HttpServletResponse response, final Exception e) {
        if (LOGGER.isErrorEnabled()) {
            LOGGER.error(e.getMessage(), e);
        }
        return new ResponseError(999, getMesssage(e.getLocalizedMessage(), null, e.getLocalizedMessage()));
    }

    /**
     * Custom error handler core exception.
     *
     * @param request
     *            request
     * @param response
     *            response
     * @param CoreException
     *            e
     * @return response error
     */
    @ExceptionHandler(CoreException.class)
    @ResponseStatus(value = HttpStatus.INTERNAL_SERVER_ERROR)
    public ResponseError defaultErrorHandlerCoreException(final HttpServletRequest request,
            final HttpServletResponse response, final CoreException e) {
        if (LOGGER.isErrorEnabled()) {
            LOGGER.error(e.getMessage(), e);
        }
        return new ResponseError(888,
                getMesssage(e.getExceptionDetails().getErrorCode(), null, e.getExceptionDetails().getErrorCode()));
    }

    /**
     * Custom error handler validation exception.
     *
     * @param request
     *            request
     * @param response
     *            response
     * @param CoreException
     *            e
     * @return response error
     */
    @ExceptionHandler(ValidationException.class)
    @ResponseStatus(value = HttpStatus.BAD_REQUEST)
    public ResponseError defaultErrorHandlerCoreException(final HttpServletRequest request,
            final HttpServletResponse response, final ValidationException e) {
        if (LOGGER.isErrorEnabled()) {
            LOGGER.error(e.getMessage(), e);
        }
        return new ResponseError(Integer.valueOf(e.getExceptionDetails().getErrorCode()),
                getMesssage(e.getMessage(), null, e.getMessage()));
    }

}
</code></pre>

<p>Obtenint com a resposta quelcom similar a:</p>

<pre><code>Response Body
{
  &quot;errors&quot;: [
    {
      &quot;code&quot;: 777,
      &quot;message&quot;: &quot;És necessari informar l’identificador&quot;
    }
  ]
}
Response Code
400
Response Headers
{
  &quot;cache-control&quot;: &quot;no-cache, no-store, max-age=0, must-revalidate&quot;,
  &quot;connection&quot;: &quot;close&quot;,
  &quot;content-type&quot;: &quot;application/json;charset=UTF-8&quot;,
  &quot;date&quot;: &quot;Thu, 08 Oct 2020 09:04:04 GMT&quot;,
  &quot;expires&quot;: &quot;0&quot;,
  &quot;pragma&quot;: &quot;no-cache&quot;,
  &quot;transfer-encoding&quot;: &quot;chunked&quot;,
  &quot;x-content-type-options&quot;: &quot;nosniff&quot;,
  &quot;x-xss-protection&quot;: &quot;1; mode=block&quot;
}
</code></pre>

<p>On estem indicant que, si hi ha un error de validació, retornarem un codi http 400 (Bad request) i, en el body de la response,
hi haurà el detall de l’error de validació que, en aquest cas, està associat al codi 777 i missatge &ldquo;És necessari informar l&rsquo;identificador&rdquo;.</p>


					

					
				</div>	

			</article>	


	</section>	

		<div class="fons_footer ">
		<footer class="container center-block shadowBox2">
			<div class="shadow2"></div>
			<div class="row footer_tab_ord">

				<div class="footer_tab_bot col-sm-12">
					<div class="avis_legal">

						<div id="fAvisLegal">
							<div>
								<div class="hidden-xs">
									<a href="https://www.gencat.cat"> <img
										src="/img/logo_generalitat_gris.png_679097835.png"
										width="101" height="27" alt="www.gencat.cat"
										/></a>
									<p>
										<a title="Avis legal" href="https://web.gencat.cat/ca/menu-ajuda/ajuda/avis_legal/" target="_self">Avís legal</a>: La &copy; Generalitat de Catalunya permet la reutilització dels continguts i de les dades sempre que se citi la font i la data d'actualització, que no es desnaturalitzi la informació i que no es contradigui amb una llicència específica.
									</p>
								</div>
								<div class="visible-xs avis_legal">
									<p>
										<a title="Avis legal" href="https://web.gencat.cat/ca/menu-ajuda/ajuda/avis_legal/" target="_self">Avís legal</a>: La &copy; Generalitat de Catalunya permet la reutilització dels continguts i de les dades sempre que se citi la font i la data d'actualització, que no es desnaturalitzi la informació i que no es contradigui amb una llicència específica.
									</p>
								</div>
								
								<div class="fi_peu visible-xs">
									<a title="www.gencat.cat" href="https://www.gencat.cat"> <img
										src="/img/logo_generalitat_gris.png_679097835.png"
										width="101" height="27" 
										alt="www.gencat.cat" /></a> <a class="torna_amunt pull-right"
										href=" javascript:tornarAmunt();" title="Torna amunt">
										<p>Torna amunt</p>
									</a>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</footer>
	</div>

<script src="/js/master.min.js" type="text/javascript"></script>
<script src="https://cdn.jsdelivr.net/algoliasearch/3/algoliasearch.min.js"></script>
<script src="https://cdn.jsdelivr.net/autocomplete.js/0/autocomplete.min.js"></script>
<script src="/js/custom.js" type="text/javascript"></script>



<script type="text/javascript">

if(location.hostname!=="localhost"){

	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

	ga('create', "UA-59408075-1", 'auto');
	ga('send', 'pageview', {
	  	'page': location.pathname + location.search  + location.hash
	  }
	);

}

</script>




</body>
</html>
