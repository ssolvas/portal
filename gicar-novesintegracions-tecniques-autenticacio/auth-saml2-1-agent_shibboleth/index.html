<!DOCTYPE html>
<html xml:lang="ca-ES" lang="ca-ES" xmlns="http://www.w3.org/1999/xhtml">
<head>

	<title>1.- Integració a través d&#39;Agent de Shibboleth</title>
		<meta charset="UTF-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<link rel="shortcut icon" type="image/x-icon" href="/img/favicon.ico" />
	<link href="/css/master.min.css" rel="stylesheet" type="text/css" />
	<link href="/css/canigo.css" rel="stylesheet" type="text/css" />
	<script src="/js/jquery.min.js" type="text/javascript"></script>

	<script>
		document.write("<meta name=\"titol\" content=\"1.- Integració a través d\x27Agent de Shibboleth\" />");
		document.write("<meta name=\"description\" content=\"Descripció de la Integració a través d\x27Agent de Shibboleth\" />");
	</script>

	

</head>
<body class="single">
	<div class="contenidor unfixed">

				

		<header class="fons_header navbar navbar-default z-index-menu">
			<div class="container" role="menu">
				<div class="row clearfix menuNav">
					<div class="col-md-3 col-xs-3 column visible-xs coloca ">
						<button type="button" onclick="amunt();" title="Menu"
							class="navbar-toggle pull-left" data-toggle="collapse"
							data-target=".navbar-collapse">
							<span class="sr-only">Toggle navigation</span> <span
								class="icon-bar"></span> <span class="icon-bar"></span> <span
								class="icon-bar"></span>
						</button>
					</div>

					<div class="col-md-3 col-xs-6 col-offset-2 column visible-xs titol-mobil">
						
						<span class="white titol-mobil-destacat">canigo.ctti</span><span class="white">.gencat.cat</span>
					</div>

					<div class="col-md-3 col-xs-3 column visible-xs coloca1">
						<button onclick="amunt();" type="button" title="Cerca"
							class="ico_cerca " data-toggle="collapse" data-target=".dos">
						</button>
					</div>

				</div>

				<div class="collapse dos">
					<div class="shadowBox">
						<form class="navbar-form navbar-left primer" action="/cercador/" method="get"
 						onsubmit="location.href=this.action+'?q='+this.cerca_cap.value; return false;">
							<div class="form-group">
								<input type="search" class="form-control" name="q" id="cerca_cap"
									title="Cerca"
									placeholder="Cerca" />
								<button type="button" title="Neteja" class="btn btn-default"></button>
								<input type="submit" class="ocult" name="Cerca" value="Cerca" />
							</div>
						</form>
					</div>
				</div>	

				<nav class="collapse navbar-collapse navbar-ex1-collapse ">
				
					<div class="row">
						<div class="col-md-6 col-sm-4 column">
							<a class="img-responsive logo" title="Generalitat de Catalunya"
								href="https://ctti.gencat.cat/">gencat.cat</a>
							<button class="menu_tancar visible-xs collapsed"
								data-target=".navbar-collapse" data-toggle="collapse"
								title="Tancar"></button>
						</div>

						<div class="col-md-6 col-sm-8 column hidden-xs hidden-mg">
							<form class="navbar-form cercador_vermell hidden-xs pull-right" action="/cercador/"  method="get" onsubmit="location.href=this.action+'?q='+this.cerca2.value; return false;">
								<div class="form-group">
									<label class="hidden" for="cerca2">Cerca</label>
									<input id="cerca2" class="form-control" type="search" 
									placeholder="Cerca" name="q" title="Cerca">
									<input class="btn btn-default" type="submit" title="Cerca" value="">
								</div>
							</form>

							

						</div>

					</div>
					<div class="col-xs-12 hidden-xs" id="nomPortal">
                    	<span class="titol-cap-nou">Centre de Telecomunicacions i Tecnologies de la Informació</span>
                    </div>					
					<ul class="nav navbar-nav">

			        	

						<li>
							<a class="dropdown-toggle" href='/' data-toggle='_dropdown'>Inici</a>
						</li>

						

						<li>
							<a class="dropdown-toggle" href='/arqctti' data-toggle='_dropdown'>Arquitectura CTTI</a>
						</li>

						

						<li>
							<a class="dropdown-toggle" href='/blog' data-toggle='_dropdown'>Blog</a>
						</li>

						

						<li>
							<a class="dropdown-toggle" href='/cloud' data-toggle='_dropdown'>Cloud</a>
						</li>

						

						<li>
							<a class="dropdown-toggle" href='/canigo' data-toggle='_dropdown'>Canigó</a>
						</li>

						

						<li>
							<a class="dropdown-toggle" href='/sic' data-toggle='_dropdown'>SIC</a>
						</li>

						

						<li>
							<a class="dropdown-toggle" href='/sgde' data-toggle='_dropdown'>SGDE</a>
						</li>

						

						<li>
							<a class="dropdown-toggle" href='/gicar' data-toggle='_dropdown'>GICAR</a>
						</li>

						

						<li>
							<a class="dropdown-toggle" href='/cs' data-toggle='_dropdown'>Centres de Suport</a>
						</li>

						

						<li>
							<a class="dropdown-toggle" href='/dadesref' data-toggle='_dropdown'>Gestió Tècnica de Dades</a>
						</li>

						

						<li>
							<a class="dropdown-toggle" href='/eventhub' data-toggle='_dropdown'>EventHub</a>
						</li>

						

					</ul>

				</nav>
			</div>
		</header>



	</div>

	<section class="border-start">

						
			

			<article class="bgGrey">
				<div class="container">
					<div class="row">
						<div class="capcelera_basica col-sm-12">
							<div class="capcelera_basica_cont">
								<ol class="breadcrumb filariana hidden-xs">
									<li>
										<a href="/">Inici</a>
									</li>
									<li class="breadcrumbs2">
									
										<a href="/gicar-novesintegracions-tecniques-autenticacio">
											




























										</a>
										
























































































	<a href="/gicar/">GICAR</a> </li>

	<li>
		<a href="/gicar-novesintegracions/">Modalitats d'integració possibles</a>
	</li>

	<li>
	
		<a href="/gicar-novesintegracions-tecniques-autenticacio/">
	

	Possibilitats tècniques d'integració

	
		</a>
	






									
									</li>

								</ol>

								<h1 class="capcelera_flotant pull-left" data-txt=".title">
									

										
											




	1.- Integració a través d&#39;Agent de Shibboleth


										

									
								</h1>

								

								
								

								

								

							</div>
						</div>

					</div>
				</div>
			</article>

			


		   <div class="padding-xs container">
	    	
	    	   <i><b>Darrera actualització:</b></i> 17-08-2021
	        
           </div>
           
			<article class="padding-xs padding-sm padding-md contingut">				
				<div class="container">
 		
					
				

	

	<div class="row" id="TOC">
		<div class="col-md-12 col-xs-12"> 
			<nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#funcionament-de-l-agent-de-shibboleth">Funcionament de l&rsquo;agent de Shibboleth</a></li>
<li><a href="#informació-proporcionada-per-l-agent-de-shibboleth-a-l-aplicació">Informació proporcionada per l&rsquo;agent de Shibboleth a l&rsquo;aplicació</a></li>
<li><a href="#finalització-de-la-sessió-activa">Finalització de la sessió activa</a></li>
<li><a href="#ús-de-l-agent-de-shibboleth-sobre-plataformes-cloud">Ús de l&rsquo;agent de Shibboleth sobre plataformes Cloud</a>
<ul>
<li><a href="#si-es-fa-ús-de-la-imatge-apache-gicar-shibboleth">Si es fa ús de la imatge Apache-GICAR-Shibboleth:</a></li>
<li><a href="#si-es-fa-ús-de-la-imatge-nginx-gicar-shibboleth">Si es fa ús de la imatge NGINX-GICAR-Shibboleth:</a></li>
</ul></li>
<li><a href="#ús-de-l-agent-de-shibboleth-sobre-plataformes-on-premise">Ús de l&rsquo;agent de Shibboleth sobre plataformes On Premise</a>
<ul>
<li><a href="#instal-lar-l-agent-de-shibboleth-sobre-l-apache">Instal·lar l&rsquo;agent de Shibboleth sobre l&rsquo;apache:</a></li>
<li><a href="#reinici-del-servei-de-shibboleth-sp">Reinici del servei de shibboleth SP</a></li>
<li><a href="#definició-de-variables-d-entorn">Definició de variables d&rsquo;entorn</a></li>
<li><a href="#configuració-del-shibboleth-sp">Configuració del shibboleth SP</a></li>
</ul></li>
<li><a href="#estratègies-per-a-emular-l-entorn-en-un-entorn-de-desenvolupament">Estratègies per a emular l&rsquo;entorn en un entorn de desenvolupament</a>
<ul>
<li><a href="#simulació-de-les-capçaleres-http-generades-per-l-agent-de-shibboleth">Simulació de les capçaleres HTTP generades per l&rsquo;agent de Shibboleth:</a></li>
</ul></li>
</ul></li>
</ul>
</nav>
    	</div>
	</div>

	


					

						

<p>Es disposa d&rsquo;una modalitat d&rsquo;integració on un frontal apache es pot integrar amb GICAR a través de Shibboleth-SAML2. En aquesta modalitat es desplega en l&rsquo;apache el mòdul de &ldquo;service provider&rdquo; de Shibboleth i aquest possibilita les redireccions d&rsquo;autenticació de l&rsquo;aplicació contra GICAR.</p>

<p>A banda d&rsquo;això aquesta modalitat d&rsquo;integració abstreu completament el desenvolupador de la complexitat d&rsquo;entendre el detall de funcionament del protocol SAMLv2 donat que el mòdul transforma la resposta de SAMLv2 en les headers de GICAR estàndard.</p>

<p>Aquesta modalitat d&rsquo;integració està indicada per aplicacions fetes a mida, o per aplicacions que siguin capaces de delegar l&rsquo;autenticació a través de Headers.</p>

<p>Aquesta modalitat d&rsquo;integració permet que una aplicació que no tingui el frontal a dins de XCAT pugui fer login contra GICAR.</p>

<h2 id="funcionament-de-l-agent-de-shibboleth">Funcionament de l&rsquo;agent de Shibboleth</h2>

<p>A continuació es descriuen els passos que se segueixen per portar a terme l’autenticació d’un usuari amb aquest agent:</p>

<ol>
<li><p>L’usuari intenta accedir al recurs protegit. Si l’usuari no ha iniciat cap sessió o aquesta ha caducat, l’agent de Shibboleth instal·lat interceptarà la petició per tal de que es produeixi un desafiament d’autenticació (Punt 2). Altrament, si l’usuari té una sessió activa, aquest accedirà directament a l’aplicació.</p></li>

<li><p>L’Agent de Shibboleth instal·lat en el Servidor Web on resideix el frontal de l’aplicació en qüestió intercepta la petició (primer filtre de virtual hosts) podent:</p>

<ul>
<li>Ignorar-la: en el cas que sigui un domini que s’hagi decidit ignorar de la protecció de gicar.</li>
<li>Enviar la petició a GICAR que analitzarà el tipus de protecció, si hi ha una sessió activa, etc.</li>
</ul></li>

<li><p>GICAR avalua si es tracta d’un recurs protegit</p>

<ul>
<li>Si està protegit, GICAR avalua si l’usuari té una sessió activa.</li>
<li>Si no té sessió activa, se li  demanen a l’usuari les seves credencials o el Certificat Digital. SiteMinder farà una validació de les credencials al Directori Corporatiu i s’assegurarà de la validesa del certificat. Si tot és correcte, s’obrirà una nova sessió per a l’usuari validat.</li>
</ul></li>

<li><p>Feta la validació, GICAR (via l’agent) envia a l’aplicació les capçaleres HTTP (indicades en el punt anterior) per a que l’aplicació conegui la identitat de l’usuari validat.</p>

<p>Esmentar que és el browser (client web) de l’usuari el que genera en local la cookie de sessió, mitjançant el qual SiteMinder determina si una sessió està activa o no, així com el temps d’expiració de la mateixa.</p>

<p><img src="/related/gicar/esquema-acces-2021.png" alt="Integració Aplicacions GICAR" /></p></li>

<li><p>A partir d’aquest moment, és la pròpia aplicació (amb les capçaleres rebudes que identifiquen a la persona autenticada) qui determina si l’usuari està autoritzat, amb quins permisos, etc..</p></li>
</ol>

<p><img src="/related/gicar/esquema-acces2-2021.png" alt="Integració Aplicacions GICAR" /></p>

<h2 id="informació-proporcionada-per-l-agent-de-shibboleth-a-l-aplicació">Informació proporcionada per l&rsquo;agent de Shibboleth a l&rsquo;aplicació</h2>

<p>Un cop l&rsquo;usuari s&rsquo;ha autenticat correctament, l&rsquo;agent de Shibboleth generarà un seguit de capçaleres HTTP que proporcionarà a l&rsquo;aplicació. Per regla general són les següents:</p>

<p><strong>Si l’usuari s’ha autenticat amb usuari i contrasenya contra el  obtindrà les següents capçaleres:</strong></p>

<ul>
<li><p><strong>HTTP_GICAR (conté les dades de l’usuari al DC)</strong> = “CODIINTERN=NRDRJN0001;NIF=11112222W;EMAIL=mail.admin@gencat.net;UNITAT_MAJOR=CTTI;UNITAT_MENOR=CTTI Qualitat”</p></li>

<li><p><strong>HTTP_GICAR_ID (conté el NIF de l’usuari al DC)</strong> &ndash;&gt; 11112222W</p></li>
</ul>

<p>Els detalls d’aquests camps es poden veure en la següent taula:</p>

<p><img src="/related/gicar/taula-capçalera-gicar.png" alt="Integració Aplicacions GICAR" /></p>

<p>Si l’usuari s’ha autenticat amb certificat:</p>

<ul>
<li><p><strong>HTTP_GICAR (conté dades si l’usuari està al DC, sino ve buida)</strong> = “CODIINTERN=NRDRJN0001;NIF=11112222W;EMAIL=mail.admin@gencat.net;UNITAT_MAJOR=CTTI;UNITAT_MENOR=CTTI Qualitat”</p></li>

<li><p><strong>HTTP_GICAR_ID (conté el NIF de l’usuari)</strong> &ndash;&gt; 11112222W</p></li>
</ul>

<p>Sota petició podran obtenir-se també les següents capçaleres:</p>

<ul>
<li><strong>HTTP_GICAR_PSIS</strong>: que contindrà la resposta de PSIS completa, i estarà enzipada i codificada en base64. Un cop descodificada i desenzipada s’obtindran les dades en la forma que s’especifica en l’annex D.</li>
</ul>

<p>A partir d’aquest moment, l’aplicació determinarà els privilegis que té l’usuari que hi accedeix.</p>

<h2 id="finalització-de-la-sessió-activa">Finalització de la sessió activa</h2>

<p>Hi ha dues maneres de terminar una sessió amb GICAR: o bé a través del formulari de logoff específic de GICAR, o bé a partir d’un timeout.</p>

<p>El timeout es un paràmetre definit a GICAR que provoca la terminació de la sessió en el cas que s’hagi superat un cert temps sense activitat. Aquest temps màxim d’inactivitat pot ser diferent per cada aplicació. En el cas d’accedir a una aplicació amb GICAR i fer ús del Single Sign On per a accedir a una altra, cal tenir en compte que el temps de timeout no es veurà modificat i seguirà mantenint el valor que estigués indicat per a la primera aplicació.</p>

<p>Una altra manera per a terminar la sessió, es que l’aplicació invoqui el formulari de logoff que posa a disposició GICAR. Aquest formulari realitza l’esborrat de les cookies associades a la sessió, cosa que provoca la seva finalització. Així doncs, només cal que l’aplicació invoqui una de les URL següents segons l’entorn en que es trobi:</p>

<p>Si l’aplicació té domini xxx.gencat.cat:</p>

<ul>
<li><p>A PRE: en funció del que indiquin els administradors de GICAR es farà servir un link o un altre:</p>

<ul>
<li><a href="https://preproduccio.autenticaciogicar4.extranet.gencat.cat/idp/logoutgicar.jsp">https://preproduccio.autenticaciogicar4.extranet.gencat.cat/idp/logoutgicar.jsp</a></li>
<li><a href="https://preproduccio.autenticaciogicar2.extranet.gencat.cat/idp2/logoutgicar.jsp">https://preproduccio.autenticaciogicar2.extranet.gencat.cat/idp2/logoutgicar.jsp</a></li>
<li><a href="https://preproduccio.autenticaciogicar1.extranet.gencat.cat/idp1/logoutgicar.jsp">https://preproduccio.autenticaciogicar1.extranet.gencat.cat/idp1/logoutgicar.jsp</a></li>
</ul></li>

<li><p>A PRO: en funció del que indiquin els administradors de GICAR es farà servir un link o un altre:</p>

<ul>
<li><a href="https://autenticaciogicar4.extranet.gencat.cat/idp/logoutgicar.jsp">https://autenticaciogicar4.extranet.gencat.cat/idp/logoutgicar.jsp</a></li>
<li><a href="https://autenticaciogicar2.extranet.gencat.cat/idp2/logoutgicar.jsp">https://autenticaciogicar2.extranet.gencat.cat/idp2/logoutgicar.jsp</a></li>
<li><a href="https://autenticaciogicar1.extranet.gencat.cat/idp1/logoutgicar.jsp">https://autenticaciogicar1.extranet.gencat.cat/idp1/logoutgicar.jsp</a>
<br /></li>
</ul></li>
</ul>

<p>Si l’aplicació té un domini aliè a xxx.gencat.cat, caldrà consultar el tema als responsables de GICAR.</p>

<h2 id="ús-de-l-agent-de-shibboleth-sobre-plataformes-cloud">Ús de l&rsquo;agent de Shibboleth sobre plataformes Cloud</h2>

<p>Per a poder possibilitar això es disposa d&rsquo;una imatge de <strong>contenidor Apache-GICAR-Shibboleth</strong> i <strong>contenidor NGINX-GICAR-Shibboleth</strong> que permet fer de forma senzilla aquesta integració. El desenvolupador per a poder utilitzar aquesta integració només ha d&rsquo;indicar quina és la URL que se securitzarà amb aquesta modalitat d&rsquo;integració, i a partir d&rsquo;aquí es proporcionarà al desenvolupador tota la informació per a poder aixecar fàcilment el contenidor. Veure el següent <a href="https://canigo.ctti.gencat.cat/cloud/cataleg/">enllaç</a> on es pot obtenir informació sobre com obtenir aquesta plantilla de contenidor.</p>

<h3 id="si-es-fa-ús-de-la-imatge-apache-gicar-shibboleth">Si es fa ús de la imatge Apache-GICAR-Shibboleth:</h3>

<p>Per a poder arrencar aquesta imatge de contenidor cal tenir present la següent informació:</p>

<ul>
<li><p>Existeixen dues carpetes amb fitxers de configuració dins d&rsquo;aquesta imatge docker:</p>

<ul>
<li>La carpeta &ldquo;sp_gicar_default&rdquo; conté els fitxers de configuració i binaris que no s&rsquo;han de modificar per a arrencar l&rsquo;aplicació.</li>

<li><p>La carpeta &ldquo;sp_gicar_conf_aplicacio&rdquo; conté l&rsquo;aplicació particular per a l&rsquo;aplicació que es vol arrencar amb aquest contenidor. Per defecte conté una configuració per arrencar el contenidor en mode proves contra l&rsquo;entorn de PRE de GICAR, i conté un fitxer &ldquo;cgi&rdquo; per a poder veure les capçaleres generades per GICAR. Dins d&rsquo;aquesta carpeta caldrà doncs posar els següents fitxers de cara a que el contenidor pugui arrencar correctament:</p>

<ul>
<li>certificats (fitxers .key i .crt) els quals serveixen per a establir el canal d&rsquo;encriptació entre el proveïdor d&rsquo;identitats GICAR i l&rsquo;apache.</li>
<li>El fitxer &ldquo;idp-metadata.xml&rdquo; el qual defineix les propietats del proveïdor d&rsquo;identitats GICAR. Aquest fitxer és diferent entre PRE i PRO.</li>
<li>El fitxer &ldquo;shib.conf&rdquo; el qual defineix que es protegirà amb aquesta modalitat de protecció.</li>
</ul></li>
</ul></li>

<li><p>Un cop incorporats aquests fitxers per a construïr la imatge (build) cal fer el següent:</p>

<pre><code>docker build -t gencatcloud/gicar-shibboleth:1.0.3 .
</code></pre></li>

<li><p>Un cop fet el build per a aixecar una instància de la imatge cal fer el següent:</p>

<pre><code>docker run -ti --rm  --name gicar-shibboleth -p 80:80 -p 443:443 -e &quot;url_entityid_gicar=[nom entityID aplicacio]&quot; -e &quot;url_idp_gicar=[nom entityID IDP]&quot;  -e &quot;certificate_name=[nom fitxer certificat sense .cer o .key]&quot; -e &quot;server_name=[schema i host de l'aplicació]&quot; gencatcloud/gicar-shibboleth:1.0.3
</code></pre></li>
</ul>

<p>Cal tenir en compte que l&rsquo;ordre d&rsquo;arrencada del contenidor conté els següents paràmetres els quals seran proporcionats per l&rsquo;OTGICAR/Suport Cloud/Integració de Solucions en el moment d&rsquo;abordar el projecte:</p>

<pre><code>- url_entityid_gicar -&gt; application id in gicar

- url_idp_gicar -&gt; gicar URL enpoint

- certificate_name -&gt; certificate file name

- server_name -&gt; public application serverName (with http schema) 
</code></pre>

<p>Per exemple:</p>

<pre><code>docker run -ti --rm  --name gicar-shibboleth -p 80:80 -p 443:443 -e &quot;url_entityid_gicar=https://preproduccio.dockersaml.gencat.cat&quot; -e &quot;url_idp_gicar=https://preproduccio.idp1-gicar.gencat.cat/idp/shibboleth&quot; -e &quot;certificate_name=AplicacioProva&quot; -e &quot;server_name=https://preproduccio.dockersaml.gencat.cat&quot; gencatcloud/gicar-shibboleth:1.0.3
</code></pre>

<p>Per a provar la solució amb la configuració de proves que ve per defecte, cal fer el següent:</p>

<ul>
<li>Afegir el domini preproduccio.dockersaml.gencat.cat associat a la teva IP al teu fitxer hosts de la teva màquina.</li>
<li>En un navegador accedir a <a href="https://preproduccio.dockersaml.gencat.cat/cgi-bin/headers.cgi">https://preproduccio.dockersaml.gencat.cat/cgi-bin/headers.cgi</a>.</li>
<li>Després de l&rsquo;autenticació es redireccionarà al CGI on es podran veure les headers generades.</li>
</ul>

<h3 id="si-es-fa-ús-de-la-imatge-nginx-gicar-shibboleth">Si es fa ús de la imatge NGINX-GICAR-Shibboleth:</h3>

<p>Per a poder arrencar aquesta imatge de contenidor cal tenir present la següent informació:</p>

<ul>
<li><p>Existeixen dues carpetes amb fitxers de configuració dins d&rsquo;aquesta imatge docker:</p>

<ul>
<li>La carpeta &ldquo;sp_gicar_default&rdquo; conté els fitxers de configuració i binaris que no s&rsquo;han de modificar per a arrencar l&rsquo;aplicació.</li>

<li><p>La carpeta &ldquo;sp_gicar_conf_aplicacio&rdquo; conté l&rsquo;aplicació particular per a l&rsquo;aplicació que es vol arrencar amb aquest contenidor. Per defecte conté una configuració per arrencar el contenidor en mode proves contra l&rsquo;entorn de PRE de GICAR, i conté un fitxer &ldquo;cgi&rdquo; per a poder veure les capçaleres generades per GICAR. Dins d&rsquo;aquesta carpeta caldrà doncs posar els següents fitxers de cara a que el contenidor pugui arrencar correctament:</p>

<ul>
<li>certificats (fitxers .key i .crt) els quals serveixen per a establir el canal d&rsquo;encriptació entre el proveïdor d&rsquo;identitats GICAR i l&rsquo;apache.</li>
<li>El fitxer &ldquo;idp-metadata.xml&rdquo; el qual defineix les propietats del proveïdor d&rsquo;identitats GICAR. Aquest fitxer és diferent entre PRE i PRO.
<br /></li>
</ul></li>
</ul></li>

<li><p>Un cop informades aquestes dades, cal informar els següents paràmetres per arrancar el contenidor:</p>

<ul>
<li>CLIENT_APP_SCHEME: https</li>
<li>CLIENT_APP_HOSTNAME: &ldquo;nom de domini de l&rsquo;aplicació&rdquo;: per exemple: preproduccio.aplicacions.agricultura.intranet.gencat.cat</li>
<li>SHIBBOLETH_RESPONDER_PATH: /Shibboleth.sso</li>
<li>ENTITY_ID_SP: &ldquo;identificador de l&rsquo;aplicació dins de GICAR&rdquo;. Per exemple: <a href="https://preproduccio.aplicacions.agricultura.intranet.gencat.cat/eRVC">https://preproduccio.aplicacions.agricultura.intranet.gencat.cat/eRVC</a></li>
<li>ENTITY_ID_IDP: &ldquo;identificador del node de GICAR que ha procedit a fer l&rsquo;autenticació&rdquo;. per exemple: <a href="https://preproduccio.autenticaciogicar2.extranet.gencat.cat/idp2/shibboleth">https://preproduccio.autenticaciogicar2.extranet.gencat.cat/idp2/shibboleth</a></li>
<li>CERTIFICATE_NAME: &ldquo;nom del fitxer del certificat incorporat al punt anterior&rdquo;</li>
<li>CLIENT_APP_SECURE_PATH_01: &ldquo;url a securitzar&rdquo;. exemple: /eRVC/portal/auth/entradaGICAR</li>
<li>NGINX_PROXY_DESTINATION_01: &ldquo;backend on es munta el proxy definit&rdquo;. exemple: <a href="http://backendapp.gencat.cat/api/login">http://backendapp.gencat.cat/api/login</a></li>
</ul></li>
</ul>

<p>Es poden definir fins a 10 proxys diferents protegits amb GICAR inidicant els paràmetres CLIENT_APP_SECURE_PATH_xx i NGINX_PROXY_DESTINATION_xx on xx pot variar del 01 al 10.</p>

<p>Tal pel cas del contenidor apache-GICAR com pel contenidor NGINX-GICAR, Les url&rsquo;s de logoff d&rsquo;aquesta modalitat d&rsquo;integració varien envers les URL&rsquo;s de logoff que es fan servir si es fa integració directa amb SiteMinder. En aquest cas, caldrà que les aplicacions cridin la següent URL de logoff per a destruir les sessions generades:</p>

<pre><code>    A PREPRODUCCIÓ: https://&lt;domini_aplicació&gt;/Shibboleth.sso/Logout?return=https://preproduccio.autenticaciogicar**XXX**.extranet.gencat.cat/idp**XXX**/logoutgicar.jsp

    A PRODUCCIÓ: https://&lt;domini_aplicació&gt;/Shibboleth.sso/Logout?return=https://autenticaciogicar**XXX**.extranet.gencat.cat/idp**XXX**/logoutgicar.jsp
</code></pre>

<p>on <strong>XXX</strong> varia en funció del CPD on ha fet login l&rsquo;aplicació.</p>

<h2 id="ús-de-l-agent-de-shibboleth-sobre-plataformes-on-premise">Ús de l&rsquo;agent de Shibboleth sobre plataformes On Premise</h2>

<p>Aquest muntatge també és possible dur-lo a terme en entorns on premise. Per a dur-lo a terme es pot seguir el següent tutorial (basat en entorn RedHat7 amb un OHS instal·lat):</p>

<h3 id="instal-lar-l-agent-de-shibboleth-sobre-l-apache">Instal·lar l&rsquo;agent de Shibboleth sobre l&rsquo;apache:</h3>

<p><strong>Instal·lant via &ldquo;Yum&rdquo;:</strong></p>

<p>Creem el fitxer següent amb permissos 644(root)</p>

<pre><code>/etc/yum.repos.d/sib.repo
</code></pre>

<p>amb el següent contingut:</p>

<pre><code>[security_shibboleth]
name=Shibboleth (CentOS_CentOS-6)
type=rpm-md
baseurl=http://download.opensuse.org/repositories/security:/shibboleth/CentOS_CentOS-6/
gpgcheck=1
gpgkey=http://download.opensuse.org/repositories/security:/shibboleth/CentOS_CentOS-6/repodata/repomd.xml.key
enabled=1
</code></pre>

<p>Un cop definit el repositori ja podem executar el yum d&rsquo;instal·lació</p>

<pre><code>$sudo yum install shibboleth.x86_64
</code></pre>

<p><strong>Després de la instal·lació:</strong></p>

<p>Un cop feta la instal·lació el Shibboleth restarà com a servei de sistema i podrem trobar els fitxers necessaris als següents paths:</p>

<p>•   Configuració: /etc/shibboleth/shibboleth2.xml
•   shibd: /usr/bin
•   mod_shib: els moduls estan disponibles a /usr/lib/shibboleth/
•   Els fitxers de logs estan a /var/log/shibboleth I a /var/log/shibboleth-www/native.log</p>

<p><strong>Configuració de l&rsquo;apache:</strong></p>

<p>Cal afegir els següents paràmetres a la configuració de la instància de l&rsquo;OHS, en el nostre cas el trobem al fitxer</p>

<p>/home/oracle/Oracle/Middleware/Oracle_Home/user_projects/domains/base_domain/config/fmwconfig/components/OHS/instances/gicar/httpd.conf</p>

<pre><code>LoadModule mod_shib &quot;/usr/lib64/shibboleth/mod_shib_22.so&quot;

#
# Ensures handler will be accessible.
#

&lt;Location /Shibboleth.sso&gt;
  AuthType None
  Require all granted
&lt;/Location&gt;

#
# Used for example style sheet in error templates.
#
&lt;IfModule mod_alias.c&gt;
  &lt;Location /shibboleth-sp&gt;
    AuthType None
    Require all granted
  &lt;/Location&gt;
  Alias /shibboleth-sp/main.css /usr/share/shibboleth/main.css
&lt;/IfModule&gt;

#
# Configure the module for content.
#
# You MUST enable AuthType shibboleth for the module to process
# any requests, and there MUST be a require command as well. To
# enable Shibboleth but not specify any session/access requirements
# use &quot;require shibboleth&quot;.
#
&lt;Location /secure&gt;
  AuthType shibboleth
  ShibRequestSetting requireSession 1
  require shib-session
  ShibUseHeaders On
&lt;/Location&gt;
</code></pre>

<p>A través de les directives &ldquo;Location&rdquo; es com es securitzen els directoris securitzats amb aquest mecanisme. </p>

<h3 id="reinici-del-servei-de-shibboleth-sp">Reinici del servei de shibboleth SP</h3>

<p>Shibboleth s&rsquo;instala com a servei I el gestionarem com a tal</p>

<p>•   Inici:</p>

<pre><code>$sudo service shibd start
</code></pre>

<p>•   Aturada</p>

<pre><code>$sudo service shibd stop
</code></pre>

<p>•   Reinici</p>

<pre><code>$sudo service shibd restart
</code></pre>

<p>•   Estat</p>

<pre><code>$sudo service shibd status
</code></pre>

<p>També podem executar directament el fitxer binari</p>

<h3 id="definició-de-variables-d-entorn">Definició de variables d&rsquo;entorn</h3>

<p>El propi RHEL6 proporciona unes llibreries libcurl basades en Netscape Security Services stack (NSS) en comptes de openSSL per tal de fer la negociació de SSL per a escenaris que incloguin IDPs SAML 1.1 y consulta d&rsquo;atributs mitjançant intercanvis SOAP.</p>

<p>Per evitar això, hem d&rsquo;indicar que agafin la variable d&rsquo;entorn LD_LIBRARY_PATH amb la llibreria que ens interesi.</p>

<p>Ens haurem d&rsquo;assegurar que el fitxer /etc/sysconfig/shibd conté la següent informació:</p>

<pre><code># User account for shibd
SHIBD_USER=shibd

# Umask for shibd
# SHIBD_UMASK=022

# Wait period (secs) for configuration (and metadata) to load
SHIBD_WAIT=30

# Override OS-supplied libcurl
export LD_LIBRARY_PATH=/opt/shibboleth/lib64
</code></pre>

<h3 id="configuració-del-shibboleth-sp">Configuració del shibboleth SP</h3>

<p>En aquest punt, demanar suport a la OTGICAR donat que es facilitarà tota la informació necessària per a poder configurar el mòdul de Shibboleth d&rsquo;acord al tipus d&rsquo;instal·lació que s&rsquo;està duent a terme.</p>

<h2 id="estratègies-per-a-emular-l-entorn-en-un-entorn-de-desenvolupament">Estratègies per a emular l&rsquo;entorn en un entorn de desenvolupament</h2>

<p>A continuació s&rsquo;exposa com simular GICAR en entorns de desenvolupament, amb l&rsquo;objectiu de que els proveïdors de desenvolupament tinguin una forma senzilla de simular GICAR i testejar-lo sense necessitat de disposar, per exemple, de connexió a la Xarxa de la Generalitat, ni de demanar configuracions a l&rsquo;Oficina Tècnica de GICAR.</p>

<p>Es presenten dues estratègies per a fer-ho:</p>

<h3 id="simulació-de-les-capçaleres-http-generades-per-l-agent-de-shibboleth">Simulació de les capçaleres HTTP generades per l&rsquo;agent de Shibboleth:</h3>

<p><strong>En cas de disposar de frontal web apache:</strong></p>

<p>Configurant el frontal web apache de cara a que generi de forma automàtica les capçaleres de GICAR. S’ha d’afegir a l’arxiu httpd.conf, el següent:</p>

<ul>
<li><p>Habilitar el mod_header en el apache.</p></li>

<li><p>Generar les següents capçaleres a nivell d&rsquo;apache utilitzant les següents directives:</p>

<ul>
<li>RequestHeader set GICAR_ID “00000000T”</li>
<li>RequestHeader set GICAR “CODIINTERN=NRDRJN0001;NIF=00000000T;EMAIL=mail.admin@gencat.net;UNITAT_MAJOR=CTTI;UNITAT_MENOR=CTTI Qualitat”</li>
</ul></li>
</ul>

<p>Aquesta configuració fa que l’Apache afegeixi la capçalera GICAR i GICAR_ID, amb valor fix, dins de totes les peticions HTTP rebudes.</p>

<p><strong>En cas de disposar de frontal web NGINX:</strong></p>

<p>Al fitxer de configuració del Nginx de forma molt semblant a com es fa en el cas d&rsquo;apache es pot definir la capçalera GICAR_ID de la següent forma:</p>

<pre><code>    proxy_set_header        GICAR_ID   &quot;00000000T&quot;;
</code></pre>

<p>La capçalera GICAR es pot emular de la següent manera:</p>

<pre><code>    more_set_input_headers 'GICAR1: CODIINTERN=NRDRJN0001';
    more_set_input_headers 'GICAR2: ;NIF=00000000T';
    more_set_input_headers 'GICAR3: ;EMAIL=mail.admin@gencat.net';
    more_set_input_headers 'GICAR4: ;UNITAT_MAJOR=UNITAT_MAJOR=CTTI'; 
    more_set_input_headers 'GICAR5: ;UNITAT_MENOR=UNITAT_MENOR=CTTI Qualitat';  

    proxy_set_header        GICAR $http_GICAR1$http_GICARCI$http_GICAR2$http_GICAR_ID$http_GICAR3$http_GICARMAIL$http_GICAR4$http_GICARUMJ$http_GICAR5$http_GICARUMN;
</code></pre>


					

					
				</div>	

			</article>	


	</section>	

		<div class="fons_footer ">
		<footer class="container center-block shadowBox2">
			<div class="shadow2"></div>
			<div class="row footer_tab_ord">

				<div class="footer_tab_bot col-sm-12">
					<div class="avis_legal">

						<div id="fAvisLegal">
							<div>
								<div class="hidden-xs">
									<a href="https://www.gencat.cat"> <img
										src="/img/logo_generalitat_gris.png_679097835.png"
										width="101" height="27" alt="www.gencat.cat"
										/></a>
									<p>
										<a title="Avis legal" href="https://web.gencat.cat/ca/menu-ajuda/ajuda/avis_legal/" target="_self">Avís legal</a>: La &copy; Generalitat de Catalunya permet la reutilització dels continguts i de les dades sempre que se citi la font i la data d'actualització, que no es desnaturalitzi la informació i que no es contradigui amb una llicència específica.
									</p>
								</div>
								<div class="visible-xs avis_legal">
									<p>
										<a title="Avis legal" href="https://web.gencat.cat/ca/menu-ajuda/ajuda/avis_legal/" target="_self">Avís legal</a>: La &copy; Generalitat de Catalunya permet la reutilització dels continguts i de les dades sempre que se citi la font i la data d'actualització, que no es desnaturalitzi la informació i que no es contradigui amb una llicència específica.
									</p>
								</div>
								
								<div class="fi_peu visible-xs">
									<a title="www.gencat.cat" href="https://www.gencat.cat"> <img
										src="/img/logo_generalitat_gris.png_679097835.png"
										width="101" height="27" 
										alt="www.gencat.cat" /></a> <a class="torna_amunt pull-right"
										href=" javascript:tornarAmunt();" title="Torna amunt">
										<p>Torna amunt</p>
									</a>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</footer>
	</div>

<script src="/js/master.min.js" type="text/javascript"></script>
<script src="https://cdn.jsdelivr.net/algoliasearch/3/algoliasearch.min.js"></script>
<script src="https://cdn.jsdelivr.net/autocomplete.js/0/autocomplete.min.js"></script>
<script src="/js/custom.js" type="text/javascript"></script>



<script type="text/javascript">

if(location.hostname!=="localhost"){

	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

	ga('create', "UA-59408075-1", 'auto');
	ga('send', 'pageview', {
	  	'page': location.pathname + location.search  + location.hash
	  }
	);

}

</script>




</body>
</html>
