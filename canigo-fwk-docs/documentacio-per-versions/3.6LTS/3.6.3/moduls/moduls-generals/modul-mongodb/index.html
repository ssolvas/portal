<!DOCTYPE html>
<html xml:lang="ca-ES" lang="ca-ES" xmlns="http://www.w3.org/1999/xhtml">
<head>

	<title>Mòdul MongoDB</title>
		<meta charset="UTF-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<link rel="shortcut icon" type="image/x-icon" href="/img/favicon.ico" />
	<link href="/css/master.min.css" rel="stylesheet" type="text/css" />
	<link href="/css/canigo.css" rel="stylesheet" type="text/css" />
	<script src="/js/jquery.min.js" type="text/javascript"></script>

	<script>
		document.write("<meta name=\"titol\" content=\"Mòdul MongoDB\" />");
		document.write("<meta name=\"description\" content=\"Mòdul de persistència de Base de Dades per MongoDB.\" />");
	</script>

	

</head>
<body class="single">
	<div class="contenidor unfixed">

				

		<header class="fons_header navbar navbar-default z-index-menu">
			<div class="container" role="menu">
				<div class="row clearfix menuNav">
					<div class="col-md-3 col-xs-3 column visible-xs coloca ">
						<button type="button" onclick="amunt();" title="Menu"
							class="navbar-toggle pull-left" data-toggle="collapse"
							data-target=".navbar-collapse">
							<span class="sr-only">Toggle navigation</span> <span
								class="icon-bar"></span> <span class="icon-bar"></span> <span
								class="icon-bar"></span>
						</button>
					</div>

					<div class="col-md-3 col-xs-6 col-offset-2 column visible-xs titol-mobil">
						
						<span class="white titol-mobil-destacat">canigo.ctti</span><span class="white">.gencat.cat</span>
					</div>

					<div class="col-md-3 col-xs-3 column visible-xs coloca1">
						<button onclick="amunt();" type="button" title="Cerca"
							class="ico_cerca " data-toggle="collapse" data-target=".dos">
						</button>
					</div>

				</div>

				<div class="collapse dos">
					<div class="shadowBox">
						<form class="navbar-form navbar-left primer" action="/cercador/" method="get"
 						onsubmit="location.href=this.action+'?q='+this.cerca_cap.value; return false;">
							<div class="form-group">
								<input type="search" class="form-control" name="q" id="cerca_cap"
									title="Cerca"
									placeholder="Cerca" />
								<button type="button" title="Neteja" class="btn btn-default"></button>
								<input type="submit" class="ocult" name="Cerca" value="Cerca" />
							</div>
						</form>
					</div>
				</div>	

				<nav class="collapse navbar-collapse navbar-ex1-collapse ">
				
					<div class="row">
						<div class="col-md-6 col-sm-4 column">
							<a class="img-responsive logo" title="Generalitat de Catalunya"
								href="https://ctti.gencat.cat/">gencat.cat</a>
							<button class="menu_tancar visible-xs collapsed"
								data-target=".navbar-collapse" data-toggle="collapse"
								title="Tancar"></button>
						</div>

						<div class="col-md-6 col-sm-8 column hidden-xs hidden-mg">
							<form class="navbar-form cercador_vermell hidden-xs pull-right" action="/cercador/"  method="get" onsubmit="location.href=this.action+'?q='+this.cerca2.value; return false;">
								<div class="form-group">
									<label class="hidden" for="cerca2">Cerca</label>
									<input id="cerca2" class="form-control" type="search" 
									placeholder="Cerca" name="q" title="Cerca">
									<input class="btn btn-default" type="submit" title="Cerca" value="">
								</div>
							</form>

							

						</div>

					</div>
					<div class="col-xs-12 hidden-xs" id="nomPortal">
                    	<span class="titol-cap-nou">Centre de Telecomunicacions i Tecnologies de la Informació</span>
                    </div>					
					<ul class="nav navbar-nav">

			        	

						<li>
							<a class="dropdown-toggle" href='/' data-toggle='_dropdown'>Inici</a>
						</li>

						

						<li>
							<a class="dropdown-toggle" href='/arqctti' data-toggle='_dropdown'>Arquitectura CTTI</a>
						</li>

						

						<li>
							<a class="dropdown-toggle" href='/blog' data-toggle='_dropdown'>Blog</a>
						</li>

						

						<li>
							<a class="dropdown-toggle" href='/cloud' data-toggle='_dropdown'>Cloud</a>
						</li>

						

						<li>
							<a class="dropdown-toggle" href='/canigo' data-toggle='_dropdown'>Canigó</a>
						</li>

						

						<li>
							<a class="dropdown-toggle" href='/sic' data-toggle='_dropdown'>SIC</a>
						</li>

						

						<li>
							<a class="dropdown-toggle" href='/sgde' data-toggle='_dropdown'>SGDE</a>
						</li>

						

						<li>
							<a class="dropdown-toggle" href='/gicar' data-toggle='_dropdown'>GICAR</a>
						</li>

						

						<li>
							<a class="dropdown-toggle" href='/cs' data-toggle='_dropdown'>Centres de Suport</a>
						</li>

						

						<li>
							<a class="dropdown-toggle" href='/dadesref' data-toggle='_dropdown'>Gestió Tècnica de Dades</a>
						</li>

						

						<li>
							<a class="dropdown-toggle" href='/eventhub' data-toggle='_dropdown'>EventHub</a>
						</li>

						

					</ul>

				</nav>
			</div>
		</header>



	</div>

	<section class="border-start">

						
			

			<article class="bgGrey">
				<div class="container">
					<div class="row">
						<div class="capcelera_basica col-sm-12">
							<div class="capcelera_basica_cont">
								<ol class="breadcrumb filariana hidden-xs">
									<li>
										<a href="/">Inici</a>
									</li>
									<li class="breadcrumbs2">
									
										<a href="/canigo-fwk-docs">
											




























	
	
	
	
	
	  
	  
	
	  
	  
	  	
	  	
	  	<a href='https://canigo.ctti.gencat.cat/canigo-fwk-docs/'>canigo fwk docs</a>
	  	
	  
	
	  
	  
	  	
	  	
	  		<li>
	  	
	  	<a href='https://canigo.ctti.gencat.cat/canigo-fwk-docs/documentacio-per-versions/'>documentacio per versions</a>
	  	
	  		</li>
	  	
	  
	
	  
	  
	  	
	  	
	  		<li>
	  	
	  	<a href='https://canigo.ctti.gencat.cat/canigo-fwk-docs/documentacio-per-versions/3.6LTS/'>3.6LTS</a>
	  	
	  		</li>
	  	
	  
	
	  
	  
	  	
	  	
	  		<li>
	  	
	  	<a href='https://canigo.ctti.gencat.cat/canigo-fwk-docs/documentacio-per-versions/3.6LTS/3.6.3/'>3.6.3</a>
	  	
	  		</li>
	  	
	  
	
	  
	  
	  	
	  	
	  		<li>
	  	
	  	<a href='https://canigo.ctti.gencat.cat/canigo-fwk-docs/documentacio-per-versions/3.6LTS/3.6.3/moduls/'>moduls</a>
	  	
	  		</li>
	  	
	  
	
	  
	  
	  	
	  	
	  		<li>
	  	
	  	<a href='https://canigo.ctti.gencat.cat/canigo-fwk-docs/documentacio-per-versions/3.6LTS/3.6.3/moduls/moduls-generals/'>moduls generals</a>
	  	
	  		</li>
	  	
	  
	
	  
	  
	  	
	  	
	  		<li>
	  	
	  	<a href='https://canigo.ctti.gencat.cat/canigo-fwk-docs/documentacio-per-versions/3.6LTS/3.6.3/moduls/moduls-generals/modul-mongodb/'>modul mongodb</a>
	  	
	  		</li>
	  	
	  
	
	  
	  
	


										</a>
										




























































































									
									</li>

								</ol>

								<h1 class="capcelera_flotant pull-left" data-txt=".title">
									

										
											




	Mòdul MongoDB


										

									
								</h1>

								

								
								

								

								

							</div>
						</div>

					</div>
				</div>
			</article>

			


		   <div class="padding-xs container">
	    	
	    	   <i><b>Darrera actualització:</b></i> 27-12-2021
	        
           </div>
           
			<article class="padding-xs padding-sm padding-md contingut">				
				<div class="container">
 		
					
				

	


					

						

<h2 id="propòsit">Propòsit</h2>

<p>El mòdul de MongoDB té com a propòsit general gestionar l’accés i l’execució d&rsquo;operacions a una base de dades MongoDB.
Aquest mòdul utilitza <a href="https://docs.spring.io/spring-data/mongodb/docs/3.2.4/reference/html/#reference">Spring Data MongoDB</a>
i <a href="http://www.querydsl.com/static/querydsl/latest/reference/html/">QueryDSL</a>.</p>

<p>A la versió 3.6 de Canigó, es proporcionen les funcionalitats de reactiu per MongoDB.</p>

<h2 id="instal-lació">Instal·lació</h2>

<p>Per tal d&rsquo;instal·lar el mòdul de MongoDB es pot optar per incloure’l automàticament a través de l&rsquo;eina de suport al desenvolupament o bé afegir
manualment la següent dependència en el fitxer <code>pom.xml</code> de l’aplicació:</p>

<pre><code class="language-xml">    &lt;dependency&gt;
      &lt;groupId&gt;cat.gencat.ctti&lt;/groupId&gt;
      &lt;artifactId&gt;canigo.persistence.mongodb&lt;/artifactId&gt;
      &lt;version&gt;${canigo.persistence.mongodb.version}&lt;/version&gt;
      &lt;exclusions&gt;
        &lt;exclusion&gt;
          &lt;artifactId&gt;bson&lt;/artifactId&gt;
          &lt;groupId&gt;org.mongodb&lt;/groupId&gt;
        &lt;/exclusion&gt;
        &lt;exclusion&gt;
          &lt;artifactId&gt;mongodb-driver-core&lt;/artifactId&gt;
          &lt;groupId&gt;org.mongodb&lt;/groupId&gt;
        &lt;/exclusion&gt;
        &lt;exclusion&gt;
          &lt;artifactId&gt;mongodb-driver-async&lt;/artifactId&gt;
          &lt;groupId&gt;org.mongodb&lt;/groupId&gt;
        &lt;/exclusion&gt;
      &lt;/exclusions&gt;
    &lt;/dependency&gt;
</code></pre>

<p>A la <a href="/canigo-fwk-docs/documentacio-per-versions/3.6LTS/3.6.3/moduls/compatibilitat-per-modul/">Matriu de Compatibilitats 3.6</a> es pot comprovar la versió del mòdul compatible amb la versió de Canigó utilitzada.</p>

<p><br/>
Caldrà també afegir el <em>plugin</em> que genera les classes per als filtres de <a href="http://www.querydsl.com/">QueryDSL</a> i
el que executa el test unitari del mòdul de persistència:</p>

<pre><code class="language-xml">&lt;build&gt;
   ...
   &lt;plugins&gt;
      ...
      &lt;plugin&gt;
         &lt;groupId&gt;com.mysema.maven&lt;/groupId&gt;
         &lt;artifactId&gt;apt-maven-plugin&lt;/artifactId&gt;
         &lt;version&gt;1.1.3&lt;/version&gt;
         &lt;executions&gt;
         ...
                    &lt;execution&gt;
                        &lt;id&gt;org.springframework.data.mongodb.repository.support.MongoAnnotationProcessor&lt;/id&gt;
                        &lt;goals&gt;
                          &lt;goal&gt;process&lt;/goal&gt;
                        &lt;/goals&gt;
                        &lt;configuration&gt;
                          &lt;outputDirectory&gt;target/generated-sources/java&lt;/outputDirectory&gt;
                          &lt;processor&gt;org.springframework.data.mongodb.repository.support.MongoAnnotationProcessor&lt;/processor&gt;
                        &lt;/configuration&gt;
                    &lt;/execution&gt;
         ...
         &lt;/executions&gt;
      &lt;/plugin&gt;
      ...
   &lt;/plugins&gt;
   ...
&lt;/build&gt;
</code></pre>

<p><br/>
Si l&rsquo;aplicació està configurada amb <strong>Spring Boot</strong>, caldrà afegir la següent dependència:</p>

<pre><code class="language-xml">    &lt;dependency&gt;
      &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
      &lt;artifactId&gt;spring-boot-starter-data-mongodb&lt;/artifactId&gt;
      &lt;exclusions&gt;
        &lt;exclusion&gt;
          &lt;artifactId&gt;org.springframework.boot&lt;/artifactId&gt;
          &lt;groupId&gt;spring-boot-starter-logging&lt;/groupId&gt;
        &lt;/exclusion&gt;
      &lt;/exclusions&gt;
    &lt;/dependency&gt;
</code></pre>

<p><br/>
Si es vol utilitzar <em>Embeded Mongo</em> per a executar els tests, caldrà afegir la següent dependència:</p>

<pre><code class="language-xml">    &lt;embedmongo-spring.version&gt;1.3.1&lt;/embedmongo-spring.version&gt;
    &lt;dependency&gt;
      &lt;groupId&gt;de.flapdoodle.embed&lt;/groupId&gt;
      &lt;artifactId&gt;de.flapdoodle.embed.mongo&lt;/artifactId&gt;
      &lt;scope&gt;test&lt;/scope&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
      &lt;groupId&gt;cz.jirutka.spring&lt;/groupId&gt;
      &lt;artifactId&gt;embedmongo-spring&lt;/artifactId&gt;
      &lt;version&gt;${embedmongo-spring.version}&lt;/version&gt;
      &lt;scope&gt;test&lt;/scope&gt;
      &lt;exclusions&gt;
        &lt;exclusion&gt;
          &lt;artifactId&gt;mongo-java-driver&lt;/artifactId&gt;
          &lt;groupId&gt;org.mongodb&lt;/groupId&gt;
        &lt;/exclusion&gt;
      &lt;/exclusions&gt;
    &lt;/dependency&gt;
</code></pre>

<p><br/>
Per a utilitzar les funcionalitats de Mongodb 4.2, serà necessari utilitzar la versió 3.12.3 o superior de <em>mongodb-driver-core</em>
(<a href="https://docs.mongodb.com/drivers/driver-compatibility-reference#java-driver-compatibility">https://docs.mongodb.com/drivers/driver-compatibility-reference#java-driver-compatibility</a>) i caldrà afegir la següent dependència:</p>

<pre><code class="language-xml">    &lt;mongo-java-driver.version&gt;3.12.10&lt;/mongo-java-driver.version&gt;
    &lt;dependency&gt;
      &lt;groupId&gt;org.mongodb&lt;/groupId&gt;
      &lt;artifactId&gt;bson&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
      &lt;groupId&gt;org.mongodb&lt;/groupId&gt;
      &lt;artifactId&gt;mongodb-driver-sync&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
      &lt;groupId&gt;org.mongodb&lt;/groupId&gt;
      &lt;artifactId&gt;mongo-java-driver&lt;/artifactId&gt;
      &lt;version&gt;${mongo-java-driver.version}&lt;/version&gt;
    &lt;/dependency&gt;
</code></pre>

<p><br/>
Finalment, si es vol utilitzar les funcionalitats reactives, caldrà afegir la següent dependència:</p>

<pre><code class="language-xml">     &lt;dependency&gt;
      &lt;groupId&gt;org.mongodb&lt;/groupId&gt;
      &lt;artifactId&gt;mongodb-driver-reactivestreams&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
      &lt;groupId&gt;io.projectreactor&lt;/groupId&gt;
      &lt;artifactId&gt;reactor-core&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
      &lt;groupId&gt;io.projectreactor&lt;/groupId&gt;
      &lt;artifactId&gt;reactor-test&lt;/artifactId&gt;
    &lt;/dependency&gt;
</code></pre>

<h2 id="configuració">Configuració</h2>

<p>La configuració es realitza automàticament a l&rsquo;aplicació a partir de l&rsquo;eina de suport al desenvolupament.
Només en cas de no utilitzar-la, caldrà realitzar manualment configuració que es descriu a continuació.</p>

<h3 id="no-reactiu">No reactiu</h3>

<p>Fitxer: <strong>mongodb.properties</strong>
<br/>
Ubicació proposada: <code>&lt;PROJECT_ROOT&gt;/src/main/resources/config/props/mongodb.properties</code>.</p>

<table>
<thead>
<tr>
<th>Propietat</th>
<th>Requerit</th>
<th>Descripció</th>
</tr>
</thead>

<tbody>
<tr>
<td>*.mongodb.uri</td>
<td>Si</td>
<td>URL de connexió amb la BD MongoDB. Per més informació <a href="https://mongodb.github.io/mongo-java-driver/3.12/javadoc/com/mongodb/MongoClientURI.html">https://mongodb.github.io/mongo-java-driver/3.12/javadoc/com/mongodb/MongoClientURI.html</a></td>
</tr>

<tr>
<td>*.mongodb.host</td>
<td>No</td>
<td>Requerit si no està definida la propietat mongodb.uri. Host de la connexió amb la BD MongoDB</td>
</tr>

<tr>
<td>*.mongodb.port</td>
<td>No</td>
<td>Requerit si no està definida la propietat mongodb.uri. Port de la connexió amb la BD MongoDB</td>
</tr>

<tr>
<td>*.mongodb.database</td>
<td>No</td>
<td>Requerit si no està definida la propietat mongodb.uri. Nom de la BD de la connexió amb la BD MongoDB</td>
</tr>

<tr>
<td>*.mongodb.authenticationDatabase</td>
<td>No</td>
<td>Requerit si no està definida la propietat mongodb.uri. Nom de la BD MongoDB si esta autenticada</td>
</tr>

<tr>
<td>*.mongodb.username</td>
<td>No</td>
<td>Requerit si no està definida la propietat mongodb.uri. Usuari de la connexió amb la BD MongoDB</td>
</tr>

<tr>
<td>*.mongodb.password</td>
<td>No</td>
<td>Requerit si no està definida la propietat mongodb.uri. Secret de la connexió amb la BD MongoDB</td>
</tr>
</tbody>
</table>

<p><br/>
Fitxer: <strong>MongoConfig.java</strong>
<br/>
Ubicació recomanada: <code>&lt;PROJECT_ROOT&gt;/src/main/java/ *package de l’aplicació* /mongodb/config</code>.</p>

<p>Cal extendre de la configuració de <strong>cat.gencat.ctti.canigo.arch.persistence.mongodb.config.MongoCoreConfig</strong> i
es pot sobreescriure la configuració de la connexió per defecte mitjançant el constructor. En aquest fitxer,
podeu afegir també els <em>listeners</em> de les diferents entitats de MongoDB.</p>

<p>Un exemple de configuració seria el següent:</p>

<pre><code class="language-java">import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

import com.mongodb.MongoClientSettings;

import cat.gencat.demo.mongodb.model.repository.MongoEquipamentListener;
import cat.gencat.ctti.canigo.arch.persistence.mongodb.config.MongoCoreConfig;

/**
 * Class EquipamentMongoConfig.
 *
 * @author cscanigo
 */
@Configuration
public class EquipamentMongoConfig extends MongoCoreConfig {

  /**
   * Inicialitza equipament mongo config.
   */
  public EquipamentMongoConfig() {
    super(MongoClientSettings.builder().build());
  }

  /**
   * Mongo equipament listener.
   *
   * @return mongo equipament listener
   */
  @Bean
  public MongoEquipamentListener mongoEquipamentListener() {
    return new MongoEquipamentListener();
  }

}
</code></pre>

<p>On s&rsquo;està redefinint el socket timeout de la connexió a 2000 ms i s&rsquo;està registrant el listener <em>cat.gencat.demo.mongodb.model.repository.MongoEquipamentListener</em>.</p>

<p>Per a més informació sobre les configuracions podeu consultar: <a href="https://mongodb.github.io/mongo-java-driver/3.12/javadoc/com/mongodb/MongoClientSettings.html">https://mongodb.github.io/mongo-java-driver/3.12/javadoc/com/mongodb/MongoClientSettings.html</a>.</p>

<h3 id="reactiu">Reactiu</h3>

<p>Fitxer: <strong>mongodb.properties</strong>
<br/>
Ubicació proposada: <code>&lt;PROJECT_ROOT&gt;/src/main/resources/config/props/mongodb.properties</code>.</p>

<table>
<thead>
<tr>
<th>Propietat</th>
<th>Requerit</th>
<th>Descripció</th>
</tr>
</thead>

<tbody>
<tr>
<td>*.mongodb.uri</td>
<td>Si</td>
<td>URL de connexió amb la BD MongoDB. Per més informació <a href="https://docs.mongodb.com/manual/reference/connection-string/#connection-string-options">https://docs.mongodb.com/manual/reference/connection-string/#connection-string-options</a></td>
</tr>
</tbody>
</table>

<p><br/>
Fitxer: <strong>ReactiveMongoConfig.java</strong>
<br/>
Ubicació recomanada: <code>&lt;PROJECT_ROOT&gt;/src/main/java/ *package de l’aplicació* /mongodb/config</code>.</p>

<p>Cal estendre de la configuració de <strong>cat.gencat.ctti.canigo.arch.persistence.mongodb.config.ReactiveMongoCoreConfig</strong> i
es pot sobreescriure la configuració de la connexió per defecte mitjançant el constructor. En aquest fitxer,
podeu afegir també els <em>listeners</em> de les diferents entitats de MongoDB.</p>

<p>Un exemple de configuració seria el següent:</p>

<pre><code class="language-java">import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

import cat.gencat.demo.mongodb.model.repository.MongoEquipamentListener;
import cat.gencat.ctti.canigo.arch.persistence.mongodb.config.ReactiveMongoCoreConfig;

/**
 * Class EquipamentReactiveMongoConfig.
 *
 * @author cscanigo
 */
@Configuration
public class EquipamentReactiveMongoConfig extends ReactiveMongoCoreConfig {

  /**
   * Mongo equipament listener.
   *
   * @return mongo equipament listener
   */
  @Bean
  public MongoEquipamentListener mongoEquipamentListener() {
    return new MongoEquipamentListener();
  }

}
</code></pre>

<p>On s&rsquo;està redefinint el socket timeout de la connexió a 2000 ms i s&rsquo;està registrant el listener <em>cat.gencat.demo.mongodb.model.repository.MongoEquipamentListener</em>.</p>

<h2 id="entitats">Entitats</h2>

<p>Per tal de definir les entitats de MongoDB serà necessari utilitzar les <em>annotations</em> de <em>JSR 380</em>, <em>Spring Data</em> i <em>Spring Data MongoDB</em>. Per a més informació, podeu consultar:</p>

<ul>
<li>Package javax.validation: <a href="https://docs.oracle.com/javaee/7/api/javax/validation/package-summary.html">https://docs.oracle.com/javaee/7/api/javax/validation/package-summary.html</a></li>
<li>Package org.springframework.data.annotation: <a href="https://docs.spring.io/spring-data/commons/docs/current/api/org/springframework/data/annotation/package-summary.html">https://docs.spring.io/spring-data/commons/docs/current/api/org/springframework/data/annotation/package-summary.html</a></li>
<li>Spring Data MongoDB: <a href="https://docs.spring.io/spring-data/mongodb/docs/3.2.4/reference/html/#reference">https://docs.spring.io/spring-data/mongodb/docs/3.2.4/reference/html/#reference</a></li>
</ul>

<p>Un exemple d&rsquo;entitat seria la següent:</p>

<pre><code class="language-java">import javax.validation.constraints.NotNull;
import org.springframework.data.annotation.Id;
import org.springframework.data.mongodb.core.index.Indexed;
import org.springframework.data.mongodb.core.mapping.Document;

@Document(collection = &quot;Equipament&quot;)
public class MongoEquipament {
   public static final String ID = &quot;id&quot;;
   public static final String NOM = &quot;nom&quot;;
   public static final String MUNICIPI = &quot;municipi&quot;;

   @Id
   private Long id;

   @Indexed(unique = true)
   @NotNull(message = &quot;MongoEquipament's nom must not be null&quot;)
   private String nom;

   private String municipi;

   public Long getId() {
      return id;
   }
   public void setId(Long id) {
      this.id = id;
   }
   public String getNom() {
      return nom;
   }
   public void setNom(String nom) {
      this.nom = nom;
   }
   public String getMunicipi() {
      return municipi;
   }
   public void setMunicipi(String municipi) {
      this.municipi = municipi;
   }
}
</code></pre>

<h2 id="listeners">Listeners</h2>

<p>Si es considera necessari, es pot crear un <em>listener</em> a una entitat de Mongo. Un exemple de <em>listener</em> seria el següent:</p>

<pre><code class="language-java">package cat.gencat.demo.mongodb.model.repository;

import java.util.Random;
import org.springframework.data.mongodb.core.mapping.event.AbstractMongoEventListener;
import org.springframework.data.mongodb.core.mapping.event.BeforeConvertEvent;
import cat.gencat.ctti.canigo.arch.persistence.mongodb.model.MongoEquipament;

/**
 * Equivalent of a domain method annotated by &lt;code&gt;PrePersist&lt;/code&gt;.
 * @see MongoEquipamentEvent
 */
public class MongoEquipamentListener extends AbstractMongoEventListener&lt;MongoEquipament&gt; {
   /**
    * On before convert.
    * @param event
    */
   @Override
   public void onBeforeConvert(BeforeConvertEvent&lt;MongoEquipament&gt; event) {
      MongoEquipament mongoEquipament = event.getSource();
      if (mongoEquipament.getId() == null) {
         mongoEquipament.setId(new Random().nextLong());
      }
   }
}
</code></pre>

<p>On s&rsquo;està aplicant una assignació d&rsquo;identificadors únics a l’entitat <em>MongoEquipament</em>.</p>

<h2 id="repositoris">Repositoris</h2>

<h3 id="no-reactiu-1">No reactiu</h3>

<p>Per a utilitzar els repositoris s&rsquo;ha de generar un objecte <em>MongoRepository</em> per a l&rsquo;entitat desitjada(T), que ha d&rsquo;estendre de
<strong>cat.gencat.ctti.canigo.arch.persistence.mongodb.repository.MongoGenericRepository<T, ID extends Serializable></strong>.</p>

<p>Un exemple de repositori seria el següent:</p>

<pre><code class="language-java">/**
 * Interface EquipamentMongoRepository.
 * @author cscanigo
 */
public interface EquipamentMongoRepository extends MongoGenericRepository&lt;MongoEquipament, Long&gt; {
   
   /**
      * Find by nom query.
      *
      * @param nom nom
      * @return list
      */
   @Query(&quot;{ nom: ?0 }&quot;)
   List&lt;MongoEquipament&gt; queryFindByNom(String nom);

    /**
     * Find by nom like.
     * @param nom  nom
     * @param sort sort
     * @return list
     */
    List&lt;MongoEquipament&gt; findByNomLike(String nom, Sort sort);
}
</code></pre>

<p>A un repositori es poden crear mètodes per a cada query que es vulgui definir. La construcció utilitza els prefixos
<em>find&hellip;By, read&hellip;By, query&hellip;By, count&hellip;By</em> i <em>get&hellip;By</em> i els mètodes poden incorporar la paraula <em>Distinct</em>, concatenar propietats
amb <em>And</em> i <em>Or</em> o descriptors com <em>OrderBy</em> o <em>IgnoreCase</em>.</p>

<p>Per a més informació, podeu consultar la documentació oficial de <a href="https://docs.spring.io/spring-data/mongodb/docs/3.2.4/reference/html/#reference">Spring Data MongoDB</a>.</p>

<p><br/></p>

<h3 id="reactiu-1">Reactiu</h3>

<p>Per a utilitzar els repositoris s&rsquo;ha de generar un objecte <em>ReactiveMongoRepository</em> per a l&rsquo;entitat desitjada(T), que ha d&rsquo;estendre de
<strong>org.springframework.data.mongodb.repository.ReactiveMongoRepository<T, ID></strong>.</p>

<p>Un exemple de repositori seria el següent:</p>

<pre><code class="language-java">import java.util.List;
import org.springframework.data.domain.Sort;
import org.springframework.data.mongodb.repository.Query;
import org.springframework.data.mongodb.repository.ReactiveMongoRepository;
import org.springframework.stereotype.Repository;
import cat.gencat.ctti.canigo.arch.persistence.mongodb.model.MongoEquipament;

/**
 * Interface EquipamentReactiveMongoRepository.
 * @author cscanigo
 */
@Repository
public interface EquipamentReactiveMongoRepository extends ReactiveMongoRepository&lt;MongoEquipament, Long&gt; {
    /**
     * Find by nom query.
     * @param nom nom
     * @return list
     */
    @Query(&quot;{ nom: ?0 }&quot;)
    List&lt;MongoEquipament&gt; findByNomQuery(String nom);
    /**
     * Find by nom like.
     * @param nom  nom
     * @param sort sort
     * @return list
     */
    List&lt;MongoEquipament&gt; findByNomLike(String nom, Sort sort);
}
</code></pre>

<p>A un repositori es poden crear mètodes per a cada query que es vulgui definir. La construcció utilitza els prefixos
<em>find&hellip;By, read&hellip;By, query&hellip;By, count&hellip;By</em> i <em>get&hellip;By</em> i els mètodes poden incorporar la paraula <em>Distinct</em>, concatenar propietats
amb <em>And</em> i <em>Or</em> o descriptors com <em>OrderBy</em> o <em>IgnoreCase</em>.</p>

<p>Per a més informació, podeu consultar la documentació oficial de <a href="https://docs.spring.io/spring-data/mongodb/docs/current/reference/html/">Spring Data MongoDB</a>.</p>

<h2 id="test">Test</h2>

<h3 id="no-reactiu-2">No reactiu</h3>

<p>Definirem els següents tests:</p>

<pre><code class="language-java">import static org.hamcrest.CoreMatchers.notNullValue;
import static org.hamcrest.collection.IsCollectionWithSize.hasSize;
import static org.junit.Assert.assertEquals;
import static org.junit.Assert.assertNotNull;
import static org.junit.Assert.assertThat;
import static org.junit.Assert.assertTrue;
import java.util.ArrayList;
import java.util.List;
import java.util.Optional;
import java.util.Set;
import javax.inject.Inject;
import javax.validation.ConstraintViolation;
import javax.validation.ConstraintViolationException;
import org.junit.Before;
import org.junit.FixMethodOrder;
import org.junit.Test;
import org.junit.runners.MethodSorters;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.PageRequest;
import org.springframework.data.domain.Pageable;
import org.springframework.data.domain.Sort;
import org.springframework.data.domain.Sort.Direction;
import org.springframework.data.domain.Sort.Order;
import org.springframework.data.querydsl.QSort;
import com.querydsl.core.types.Expression;
import com.querydsl.core.types.OrderSpecifier;
import com.querydsl.core.types.Path;
import com.querydsl.core.types.Predicate;
import com.querydsl.core.types.Projections;
import com.querydsl.core.types.dsl.BooleanExpression;
import cat.gencat.ctti.canigo.arch.persistence.core.querydsl.GenericPredicateBuilder;
import cat.gencat.ctti.canigo.arch.persistence.mongodb.model.MongoEquipament;
import cat.gencat.ctti.canigo.arch.persistence.mongodb.model.QMongoEquipament;
import cat.gencat.ctti.canigo.arch.persistence.mongodb.repository.EquipamentMongoRepository;

/**
 * Test cases for the {@link EquipamentMongoRepository}.
 *
 * @author cscanigo
 */
@FixMethodOrder(MethodSorters.NAME_ASCENDING)
public abstract class EquipamentMongoRepositoryCoreTest {

  /** Constant MUNICIPI_DESC_SORT. */
  protected static final String MUNICIPI_DESC_SORT = Direction.DESC + MongoEquipament.MUNICIPI;

  /** repository. */
  @Inject
  private EquipamentMongoRepository repository;

  /**
   * Estableix up.
   */
  @Before
  public void setUp() {
    assertNotNull(repository);
    repository.deleteAll();
  }

  /**
   * Test 01 CRUD operations.
   */
  @Test
  public void test01CRUDOperations() {

    // Test if table is empty
    assertTrue(repository.findAll().isEmpty());

    // Test save
    MongoEquipament mongoEquipament = new MongoEquipament();
    mongoEquipament.setNom(&quot;CAP La Pau&quot;);
    mongoEquipament.setMunicipi(&quot;Barcelona&quot;);
    repository.save(mongoEquipament);

    // Test insert and recover
    MongoEquipament mongoEquipament2 = new MongoEquipament();
    mongoEquipament2.setNom(&quot;CAP Santa Coloma&quot;);
    repository.save(mongoEquipament2);

    Optional&lt;MongoEquipament&gt; equipament3Optional = repository.findById(mongoEquipament2.getId());
    assertTrue(equipament3Optional.isPresent());

    MongoEquipament equipament3 = equipament3Optional.get();
    assertEquals(mongoEquipament2.getId(), equipament3.getId());
    assertEquals(&quot;CAP Santa Coloma&quot;, equipament3.getNom());

    BooleanExpression predicate = QMongoEquipament.mongoEquipament.municipi.eq(mongoEquipament.getMunicipi());

    Optional&lt;MongoEquipament&gt; equipament4Optional = repository.findOne(predicate);
    assertTrue(equipament4Optional.isPresent());

    Iterable&lt;MongoEquipament&gt; equipament5Iterable = repository.findAll(predicate);
    assertTrue(equipament5Iterable.iterator().hasNext());

    OrderSpecifier&lt;String&gt; orderSpecifier = new OrderSpecifier&lt;&gt;(com.querydsl.core.types.Order.ASC,
        QMongoEquipament.mongoEquipament.nom);

    Iterable&lt;MongoEquipament&gt; equipament6Iterable = repository.findAll(predicate, orderSpecifier);
    assertTrue(equipament6Iterable.iterator().hasNext());

    // Test delete all
    repository.deleteAll();
    assertTrue(repository.findAll().isEmpty());

  }

  /**
   * Test 02 multiple CRUD.
   */
  @Test
  public void test02MultipleCRUD() {
    List&lt;MongoEquipament&gt; list = new ArrayList&lt;&gt;();

    MongoEquipament mongoEquipament1 = new MongoEquipament();
    MongoEquipament mongoEquipament2 = new MongoEquipament();
    MongoEquipament mongoEquipament3 = new MongoEquipament();

    list.add(mongoEquipament1);
    list.add(mongoEquipament2);
    list.add(mongoEquipament3);

    // Test save
    mongoEquipament1.setNom(&quot;equipament1&quot;);
    mongoEquipament2.setNom(&quot;equipament2&quot;);
    mongoEquipament3.setNom(&quot;equipament3&quot;);
    repository.saveAll(list);
    assertEquals(list.size(), repository.findAll().size());

    // Test update
    mongoEquipament1.setNom(&quot;equipament1 updated!&quot;);
    mongoEquipament2.setNom(&quot;equipament2 updated!&quot;);
    mongoEquipament3.setNom(&quot;equipament3 updated!&quot;);
    repository.saveAll(list);
    assertEquals(list.size(), repository.findAll().size());

    List&lt;MongoEquipament&gt; elsMeusEquipaments = repository.findAll();
    assertEquals(mongoEquipament1.getId(), elsMeusEquipaments.get(0).getId());
    assertEquals(mongoEquipament1.getNom(), elsMeusEquipaments.get(0).getNom());
    assertEquals(mongoEquipament2.getId(), elsMeusEquipaments.get(1).getId());
    assertEquals(mongoEquipament2.getNom(), elsMeusEquipaments.get(1).getNom());
    assertEquals(mongoEquipament3.getId(), elsMeusEquipaments.get(2).getId());
    assertEquals(mongoEquipament3.getNom(), elsMeusEquipaments.get(2).getNom());

    // Test no exception launched
    repository.saveAll(new ArrayList&lt;MongoEquipament&gt;());
  }

  /**
   * Test 03 nom not null.
   */
  @Test
  public void test03NomNotNull() {
    MongoEquipament mongoEquipament = new MongoEquipament();
    mongoEquipament.setNom(null);
    try {
      repository.save(mongoEquipament);
    } catch (ConstraintViolationException e) {
      Set&lt;ConstraintViolation&lt;?&gt;&gt; violations = e.getConstraintViolations();
      assertEquals(1, violations.size());
      @SuppressWarnings(&quot;rawtypes&quot;)
      ConstraintViolation violation = violations.iterator().next();
      assertEquals(&quot;MongoEquipament's nom must not be null&quot;, violation.getMessageTemplate());
    }
  }

  /**
   * Test 04 find by nom query.
   */
  @Test
  public void test04FindByNomQuery() {
    String text = &quot;findByNomQuery&quot;;
    MongoEquipament mongoEquipament = new MongoEquipament();
    mongoEquipament.setNom(text);
    mongoEquipament.setMunicipi(text);
    repository.save(mongoEquipament);

    List&lt;MongoEquipament&gt; mongoEquipamentList = repository.queryFindByNom(text);

    assertNotNull(mongoEquipamentList);
    assertTrue(mongoEquipamentList.size() == 1);
  }

  /**
   * Test 05 find by nom like.
   */
  @Test
  public void test05FindByNomLike() {
    String like = &quot;Like&quot;;
    String text = &quot;findByNom&quot; + like;
    MongoEquipament mongoEquipament = new MongoEquipament();
    mongoEquipament.setNom(text);
    mongoEquipament.setMunicipi(text);
    repository.save(mongoEquipament);

    List&lt;MongoEquipament&gt; mongoEquipamentList = repository.findByNomLike(like, null);

    assertNotNull(mongoEquipamentList);
    assertTrue(mongoEquipamentList.size() == 1);
  }

  /**
   * Test 08 find null paginated.
   */
  @Test(expected = IllegalArgumentException.class)
  public void test06FindNullPaginated() {
    PageRequest nullPage = null;
    repository.findAll(nullPage);
  }

  /**
   * Test 09 find paginated factory expression.
   */
  @Test
  public void test07FindPaginatedFactoryExpression() {
    String text = &quot;findPaginatedProjeccio&quot;;
    for (int i = 0; i &lt; 20; i++) {
      MongoEquipament mongoEquipament = new MongoEquipament();
      mongoEquipament.setNom(text + i);
      mongoEquipament.setMunicipi(text + i);
      repository.save(mongoEquipament);
    }

    Integer page = 1;
    Integer rpp = 10;
    String sort = MUNICIPI_DESC_SORT;
    String filter = null;

    List&lt;MongoEquipament&gt; mongoEquipamentList = findPaginatedFactoryExpression(page, rpp, sort, filter).getContent();

    assertNotNull(mongoEquipamentList);
    assertTrue(mongoEquipamentList.size() == rpp);
  }

  /**
   * Obté predicate.
   *
   * @param filter filter
   * @return predicate
   */
  private Predicate getPredicate(String filter) {
    GenericPredicateBuilder&lt;MongoEquipament&gt; builder = new GenericPredicateBuilder&lt;&gt;(MongoEquipament.class,
        &quot;equipament&quot;);
    builder.populateSearchCriteria(filter);
    return builder.build();
  }

  /**
   * Find paginated factory expression.
   *
   * @param page   page
   * @param rpp    rpp
   * @param sort   sort
   * @param filter filter
   * @return page
   */
  protected Page&lt;MongoEquipament&gt; findPaginatedFactoryExpression(final Integer page, final Integer rpp,
      final String sort, final String filter) {
    Predicate predicate = getPredicate(filter);

    Pageable pageable = PageRequest.of(page - 1, rpp, getOrdenacio(sort));

    if (predicate != null &amp;&amp; pageable != null) {
      return repository.findAll(predicate, pageable);
    } else if (pageable != null) {
      return repository.findAll(pageable);
    } else {
      return null;
    }

  }

  /**
   * Obté ordenacio.
   *
   * @param sort sort
   * @return ordenacio
   */
  private Sort getOrdenacio(String sort) {
    List&lt;Order&gt; orders = new ArrayList&lt;&gt;();

    if (sort != null &amp;&amp; !sort.equals(&quot;&quot;)) {
      String[] fields = sort.split(&quot;,&quot;);

      for (int i = 0; i &lt; fields.length; i++) {
        char direction = fields[i].charAt(0);
        if (Character.toString(direction).equals(&quot;-&quot;)) {
          // Order descendente
          String value = fields[i].substring(1);
          orders.add(new Order(Direction.DESC, value));
        } else {
          // Orden ascendente
          orders.add(new Order(Direction.ASC, fields[i]));
        }
      }
    }
    return Sort.by(orders);
  }
}
</code></pre>

<p><br/></p>

<h4 id="test-a-mongodb-de-l-aplicació">Test a Mongodb de l&rsquo;aplicació</h4>

<p>Per a poder verificar el codi a la base de dades MongoDB de l&rsquo;aplicació només serà necessari importar el fitxer de
configuració de MongoDB en el nostre test:</p>

<pre><code class="language-java">import org.junit.runner.RunWith;
import org.springframework.test.context.ContextConfiguration;
import org.springframework.test.context.junit4.SpringJUnit4ClassRunner;
import cat.gencat.ctti.config.AppConfig;
import cat.gencat.ctti.mongodb.config.EquipamentMongoConfig;
import cat.gencat.ctti.mongodb.model.repository.EquipamentMongoRepository;

/**
 * Test cases for the {@link EquipamentMongoRepository}.
 */
@RunWith(SpringJUnit4ClassRunner.class)
@ContextConfiguration(classes = { AppConfig.class, EquipamentMongoConfig.class })
public class EquipamentMongoRepositoryTest extends EquipamentMongoRepositoryCoreTest{
}
</code></pre>

<h4 id="test-a-embeded-mongodb">Test a Embeded Mongodb</h4>

<p>Per a poder verificar el codi en els tests es pot utilitzar la utilitat <em>Embeded Mongo</em>. Serà necessari estendre
del fitxer de configuració de Mongo de l&rsquo;aplicació i sobreescriure el mètode:</p>

<pre><code class="language-java">public MongoClient mongoClient()
</code></pre>

<p>Un exemple de configuració per a <em>Embeded MongoDB</em> seria el següent:</p>

<pre><code class="language-java">import java.io.IOException;

import com.mongodb.MongoException;
import com.mongodb.client.MongoClient;

/**
 * Class EquipamentEmbeddedMongoConfig.
 *
 * @author cscanigo
 */
public class EquipamentEmbeddedMongoConfig extends EquipamentMongoConfig {

  /**
   * Mongo client.
   *
   * @return mongo client
   */
  @Override
  public MongoClient mongoClient() {

    EmbeddedMongoFactoryBean embeddedMongoFactoryBean = new EmbeddedMongoFactoryBean();
    if (mongo == null) {
      try {
        mongo = embeddedMongoFactoryBean.getObject();
      } catch (IOException e) {
        throw MongoException.fromThrowable(e);
      }
    }
    return mongo;
  }

}
</code></pre>

<pre><code class="language-java">import java.io.IOException;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import com.mongodb.client.MongoClient;
import com.mongodb.client.MongoClients;

/**
 * Class EmbeddedReactorMongoFactoryBean.
 *
 * @author cscanigo
 */
public class EmbeddedMongoFactoryBean extends EmbeddedBaseMongoFactoryBean&lt;MongoClient&gt; {

  /** Constant LOG. */
  private static final Logger LOG = LoggerFactory.getLogger(EmbeddedMongoFactoryBean.class);

  /**
   * Obté object.
   *
   * @return object
   * @throws IOException senyala que una excepció I/O s'ha produït.
   */
  @Override
  public synchronized MongoClient getObject() throws IOException {
    if (mongodExecutable == null) {
      LOG.info(&quot;Starting embedded MongoDB instance&quot;);
      initMongoServer();
    }
    return MongoClients.create(EMBEDDED_TEST_URI);
  }

  /**
   * Obté object type.
   *
   * @return object type
   */
  @Override
  public Class&lt;?&gt; getObjectType() {
    return MongoClient.class;
  }

}
</code></pre>

<pre><code class="language-java">import java.io.IOException;
import java.net.InetAddress;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.DisposableBean;
import org.springframework.beans.factory.FactoryBean;

import de.flapdoodle.embed.mongo.MongodExecutable;
import de.flapdoodle.embed.mongo.MongodProcess;
import de.flapdoodle.embed.mongo.MongodStarter;
import de.flapdoodle.embed.mongo.config.MongodConfig;
import de.flapdoodle.embed.mongo.config.Net;
import de.flapdoodle.embed.mongo.distribution.IFeatureAwareVersion;
import de.flapdoodle.embed.mongo.distribution.Version;
import de.flapdoodle.embed.process.runtime.Network;

/**
 * Class EmbeddedBaseMongoFactoryBean.
 *
 * @author cscanigo
 * @param &lt;E&gt; the element type
 */
public abstract class EmbeddedBaseMongoFactoryBean&lt;E&gt; implements FactoryBean&lt;E&gt;, DisposableBean {

  /** Constant LOG. */
  private static final Logger LOG = LoggerFactory.getLogger(EmbeddedBaseMongoFactoryBean.class);

  /** version. */
  private static final IFeatureAwareVersion version = Version.Main.V4_0;

  /** Constant EMBEDDED_HOST. */
  protected static final String EMBEDDED_HOST = InetAddress.getLoopbackAddress().getHostAddress();

  /** Constant EMBEDDED_PORT. */
  protected static final int EMBEDDED_PORT = getPort();

  /** Constant EMBEDDED_TEST_URI. */
  protected static final String EMBEDDED_TEST_URI = &quot;mongodb://&quot; + EMBEDDED_HOST + &quot;:&quot; + EMBEDDED_PORT + &quot;/canigo&quot;;

  /** mongod executable. */
  protected static MongodExecutable mongodExecutable;

  /** mongo process. */
  protected static MongodProcess mongoProcess;

  /**
   * Destroy.
   *
   * @throws Exception exception
   */
  @Override
  public void destroy() throws Exception {
    if (mongodExecutable != null) {
      LOG.info(&quot;Stopping embedded MongoDB instance&quot;);
      mongodExecutable.stop();
      mongoProcess.stop();
    }
  }

  /**
   * Inicialitza mongo server.
   *
   * @throws IOException senyala que una excepció I/O s'ha produït.
   */
  protected synchronized void initMongoServer() throws IOException {
    MongodConfig mongodConfig = MongodConfig.builder().version(version)
        .net(new Net(EMBEDDED_HOST, EMBEDDED_PORT, Network.localhostIsIPv6())).build();

    mongodExecutable = MongodStarter.getDefaultInstance().prepare(mongodConfig);
    mongoProcess = mongodExecutable.start();
  }

  /**
   * Obté port.
   *
   * @return port
   */
  protected static int getPort() {
    try {
      return Network.getFreeServerPort();
    } catch (IOException ex) {
      LOG.error(&quot;Needed free port&quot;);
      return 27017;
    }
  }
}
</code></pre>

<p>Per a utilitzar la configuració amb <em>Embeded MongoBD</em> en un test si no hem importat el <em>EquipamentMongoConfig</em> en el <em>AppConfig</em>:</p>

<pre><code class="language-java">import org.junit.FixMethodOrder;
import org.junit.runner.RunWith;
import org.junit.runners.MethodSorters;
import org.springframework.test.context.ContextConfiguration;
import org.springframework.test.context.junit4.SpringRunner;
import cat.gencat.provamongo.config.AppConfig;
import cat.gencat.provamongo.mongodb.config.EquipamentEmbeddedMongoConfig;

/**
 * Test cases for the {@link EquipamentMongoRepository}.
 *
 * @author cscanigo
 */
@RunWith(SpringRunner.class)
@ContextConfiguration(classes = { AppConfig.class, EquipamentEmbeddedMongoConfig.class })
@FixMethodOrder(MethodSorters.NAME_ASCENDING)
public class EquipamentEmbeddedMongoRepositoryTest extends EquipamentMongoRepositoryCoreTest {
}
</code></pre>

<p>O bé es pot optar per crear un nou <em>AppConfig</em> important el <em>EquipamentEmbeddedMongoConfig</em> i carregar-lo al test:</p>

<pre><code class="language-java">import org.springframework.context.annotation.Configuration;
import org.springframework.context.annotation.Import;
import org.springframework.context.annotation.ImportResource;
import org.springframework.context.annotation.PropertySource;
import org.springframework.transaction.annotation.EnableTransactionManagement;

import cat.gencat.ctti.mongodb.config.EquipamentEmbeddedMongoConfig;

@Configuration
@PropertySource(&quot;classpath:/config/props/boot.properties&quot;)
@ImportResource({ &quot;classpath:cat/gencat/ctti/canigo/arch/core/config/canigo-core.xml&quot; })
@EnableTransactionManagement
@Import(EquipamentEmbeddedMongoConfig.class)
public class EmbeddedMongoAppConfig {
}
</code></pre>

<pre><code class="language-java">import org.junit.runner.RunWith;
import org.springframework.test.context.ContextConfiguration;
import org.springframework.test.context.junit4.SpringJUnit4ClassRunner;
import cat.gencat.ctti.config.EmbeddedMongoAppConfig;
import cat.gencat.ctti.mongodb.model.repository.EquipamentMongoRepository;

/**
 * Test cases for the {@link EquipamentMongoRepository}.
 */
@RunWith(SpringJUnit4ClassRunner.class)
@ContextConfiguration(classes = { EmbeddedMongoAppConfig.class})
public class EquipamentEmbeddedMongoRepositoryTest extends EquipamentMongoRepositoryCoreTest{
}
</code></pre>

<p>Per a més informació, podeu consultar la documentació oficial de <a href="https://flapdoodle-oss.github.io/de.flapdoodle.embed.mongo/">Embeded MongoDB</a></p>

<h3 id="reactiu-2">Reactiu</h3>

<p>Definirem els següents tests:</p>

<pre><code class="language-java">import static org.junit.Assert.assertEquals;
import static org.junit.Assert.assertNotNull;
import static org.junit.Assert.assertTrue;

import java.time.Duration;
import java.util.ArrayList;
import java.util.List;

import javax.inject.Inject;

import org.junit.Before;
import org.junit.FixMethodOrder;
import org.junit.Test;
import org.junit.runners.MethodSorters;

import cat.gencat.demo.mongodb.model.MongoEquipament;
import reactor.core.publisher.Flux;
import reactor.core.publisher.Mono;
import reactor.test.StepVerifier;

/**
 * Class EquipamentReactiveMongoRepositoryCoreTest.
 *
 * @author cscanigo
 */
@FixMethodOrder(MethodSorters.NAME_ASCENDING)
public abstract class EquipamentReactiveMongoRepositoryCoreTest {
  /** repository. */
  @Inject
  EquipamentReactiveMongoRepository repository;
  
  /**
   * Estableix up.
   */
  @Before
  public void setUp() {
    assertNotNull(repository);
    repository.deleteAll();
  }

  /**
   * Test 1 CRUD operations.
   */
  @Test
  public void test1CRUDOperations() {
    
    // Test if table is empty
    Flux&lt;MongoEquipament&gt; mongoEquipamentInitialContent = repository.deleteAll().thenMany(repository.findAll());
    List&lt;MongoEquipament&gt; mongoEquipamentList = new ArrayList&lt;&gt;();
    mongoEquipamentInitialContent.subscribe(mongoEquipamentList::add);
    assertTrue(mongoEquipamentList.isEmpty());

    StepVerifier.create(mongoEquipamentInitialContent).expectNextCount(0).expectComplete().verify();

    // Test save
    MongoEquipament mongoEquipament = new MongoEquipament();
    mongoEquipament.setNom(&quot;CAP La Pau&quot;);
    mongoEquipament.setMunicipi(&quot;Barcelona&quot;);
    Mono&lt;MongoEquipament&gt; mongoEquipamentMono = repository.save(mongoEquipament);
    mongoEquipament = mongoEquipamentMono.block(Duration.ofMinutes(1L));
    assertNotNull(mongoEquipament.getId());

    // Test insert and recover
    MongoEquipament mongoEquipament2 = new MongoEquipament();
    mongoEquipament2.setNom(&quot;CAP Santa Coloma&quot;);
    Mono&lt;MongoEquipament&gt; mongoEquipament2Mono = repository.save(mongoEquipament2);
    mongoEquipament2 = mongoEquipament2Mono.block(Duration.ofMinutes(1L));
    assertNotNull(mongoEquipament2.getId());

    Flux&lt;MongoEquipament&gt; mongoEquipamentFinalContent = repository.findAll();

    StepVerifier.create(mongoEquipamentFinalContent).expectNextCount(2).expectComplete().verify();

    Mono&lt;MongoEquipament&gt; mongoEquipament3Mono = repository.findById(mongoEquipament2.getId());
    assertEquals(mongoEquipament2.getMunicipi(), mongoEquipament3Mono.block().getMunicipi());

    // Test delete all
    repository.deleteAll();
    Mono&lt;Boolean&gt; existsById = repository.existsById(mongoEquipament2.getId());
    StepVerifier.create(existsById).expectNext(true).expectComplete().verify();

  }
}
</code></pre>

<p><br/></p>

<h4 id="test-a-mongodb-de-l-aplicació-1">Test a Mongodb de l&rsquo;aplicació</h4>

<p>Per a poder verificar el codi a la base de dades MongoDB de l&rsquo;aplicació només serà necessari importar el fitxer de
configuració de MongoDB en el nostre test:</p>

<pre><code class="language-java">import org.junit.runner.RunWith;
import org.springframework.test.context.ContextConfiguration;
import org.springframework.test.context.junit4.SpringRunner;
import cat.gencat.ctti.canigo.arch.persistence.mongodb.config.AppConfig;
import cat.gencat.ctti.canigo.arch.persistence.mongodb.config.EquipamentReactiveMongoConfig;

/**
 * Class EquipamentReactiveMongoRepositoryTest.
 * @author cscanigo
 */
@RunWith(SpringRunner.class)
@ContextConfiguration(classes = { AppConfig.class, EquipamentReactiveMongoConfig.class })
public class EquipamentReactiveMongoRepositoryTest extends EquipamentReactiveMongoRepositoryCoreTest {
}
</code></pre>

<h4 id="test-a-embeded-mongodb-1">Test a Embeded Mongodb</h4>

<p>Per a poder verificar el codi en els tests es pot utilitzar la utilitat <em>Embeded Mongo</em>. Serà necessari estendre del
fitxer de configuració de Mongo de l&rsquo;aplicació i sobreescriure el mètode:</p>

<pre><code class="language-java">public MongoClient reactiveMongoClient()
</code></pre>

<p>Un exemple de configuració per a <em>Embeded MongoDB</em> seria el següent:</p>

<pre><code class="language-java">import java.io.IOException;
import com.mongodb.MongoException;
import com.mongodb.reactivestreams.client.MongoClient;

/**
 * Class EquipamentEmbeddedReactiveMongoConfig.
 * @author cscanigo
 */
public class EquipamentEmbeddedReactiveMongoConfig extends EquipamentReactiveMongoConfig {
    /**
     * Reactive mongo client.
     * @return mongo client
     */
    @Override
    public MongoClient reactiveMongoClient() {
        EmbeddedReactiveMongoFactoryBean embeddedReactiveMongoFactoryBean = new EmbeddedReactiveMongoFactoryBean();
        if (mongo == null) {
            try {
                mongo = embeddedReactiveMongoFactoryBean.getObject();
            } catch (IOException e) {
                throw MongoException.fromThrowable(e);
            }
        }
        return mongo;
    }
}
</code></pre>

<pre><code class="language-java">import java.io.IOException;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import com.mongodb.reactivestreams.client.MongoClient;
import com.mongodb.reactivestreams.client.MongoClients;

/**
 * Class EmbeddedReactorMongoFactoryBean.
 *
 * @author cscanigo
 */
public class EmbeddedReactiveMongoFactoryBean extends EmbeddedBaseMongoFactoryBean&lt;MongoClient&gt; {

  /** Constant LOG. */
  private static final Logger LOG = LoggerFactory.getLogger(EmbeddedReactiveMongoFactoryBean.class);

  /**
   * Obté object.
   *
   * @return object
   * @throws IOException senyala que una excepció I/O s'ha produït.
   */
  @Override
  public synchronized MongoClient getObject() throws IOException {
    if (mongodExecutable == null) {
      LOG.info(&quot;Starting embedded MongoDB instance&quot;);
      initMongoServer();
    }
    return MongoClients.create(EMBEDDED_TEST_URI);
  }

  /**
   * Obté object type.
   *
   * @return object type
   */
  @Override
  public Class&lt;?&gt; getObjectType() {
    return MongoClient.class;
  }

}
</code></pre>

<pre><code class="language-java">import java.io.IOException;
import java.net.InetAddress;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.DisposableBean;
import org.springframework.beans.factory.FactoryBean;

import de.flapdoodle.embed.mongo.MongodExecutable;
import de.flapdoodle.embed.mongo.MongodProcess;
import de.flapdoodle.embed.mongo.MongodStarter;
import de.flapdoodle.embed.mongo.config.MongodConfig;
import de.flapdoodle.embed.mongo.config.Net;
import de.flapdoodle.embed.mongo.distribution.IFeatureAwareVersion;
import de.flapdoodle.embed.mongo.distribution.Version;
import de.flapdoodle.embed.process.runtime.Network;

/**
 * Class EmbeddedBaseMongoFactoryBean.
 *
 * @author cscanigo
 * @param &lt;E&gt; the element type
 */
public abstract class EmbeddedBaseMongoFactoryBean&lt;E&gt; implements FactoryBean&lt;E&gt;, DisposableBean {

  /** Constant LOG. */
  private static final Logger LOG = LoggerFactory.getLogger(EmbeddedBaseMongoFactoryBean.class);

  /** version. */
  private static final IFeatureAwareVersion version = Version.Main.V4_0;

  /** Constant EMBEDDED_HOST. */
  protected static final String EMBEDDED_HOST = InetAddress.getLoopbackAddress().getHostAddress();

  /** Constant EMBEDDED_PORT. */
  protected static final int EMBEDDED_PORT = getPort();

  /** Constant EMBEDDED_TEST_URI. */
  protected static final String EMBEDDED_TEST_URI = &quot;mongodb://&quot; + EMBEDDED_HOST + &quot;:&quot; + EMBEDDED_PORT + &quot;/canigo&quot;;

  /** mongod executable. */
  protected static MongodExecutable mongodExecutable;

  /** mongo process. */
  protected static MongodProcess mongoProcess;

  /**
   * Destroy.
   *
   * @throws Exception exception
   */
  @Override
  public void destroy() throws Exception {
    if (mongodExecutable != null) {
      LOG.info(&quot;Stopping embedded MongoDB instance&quot;);
      mongodExecutable.stop();
      mongoProcess.stop();
    }
  }

  /**
   * Inicialitza mongo server.
   *
   * @throws IOException senyala que una excepció I/O s'ha produït.
   */
  protected synchronized void initMongoServer() throws IOException {
    MongodConfig mongodConfig = MongodConfig.builder().version(version)
        .net(new Net(EMBEDDED_HOST, EMBEDDED_PORT, Network.localhostIsIPv6())).build();

    mongodExecutable = MongodStarter.getDefaultInstance().prepare(mongodConfig);
    mongoProcess = mongodExecutable.start();
  }

  /**
   * Obté port.
   *
   * @return port
   */
  protected static int getPort() {
    try {
      return Network.getFreeServerPort();
    } catch (IOException ex) {
      LOG.error(&quot;Needed free port&quot;);
      return 27017;
    }
  }
}
</code></pre>

<p>Per a utilitzar la configuració amb <em>Embeded MongoBD</em> en un test si no hem importat el <em>EquipamentReactiveMongoConfig</em> en el <em>AppConfig</em>:</p>

<pre><code class="language-java">import org.junit.runner.RunWith;
import org.springframework.test.context.ContextConfiguration;
import org.springframework.test.context.junit4.SpringRunner;
import cat.gencat.ctti.canigo.arch.persistence.mongodb.config.AppConfig;
import cat.gencat.ctti.canigo.arch.persistence.mongodb.config.EquipamentEmbeddedReactiveMongoConfig;

/**
 * Class EquipamentEmbeddedReactiveMongoRepositoryTest.
 *
 * @author cscanigo
 */
@RunWith(SpringRunner.class)
@ContextConfiguration(classes = { AppConfig.class, EquipamentEmbeddedReactiveMongoConfig.class })
public class EquipamentEmbeddedReactiveMongoRepositoryTest extends EquipamentReactiveMongoRepositoryCoreTest {
}
</code></pre>

<p>O optar per crear un nou <em>AppConfig</em> important el <em>EquipamentEmbeddedReactiveMongoConfig</em> i carregar-lo al test:</p>

<pre><code class="language-java">import org.springframework.context.annotation.Configuration;
import org.springframework.context.annotation.Import;
import org.springframework.context.annotation.ImportResource;
import org.springframework.context.annotation.PropertySource;
import org.springframework.transaction.annotation.EnableTransactionManagement;
import cat.gencat.ctti.mongodb.config.EquipamentEmbeddedReactiveMongoConfig;

@Configuration
@PropertySource(&quot;classpath:/config/props/boot.properties&quot;)
@ImportResource({ &quot;classpath:cat/gencat/ctti/canigo/arch/core/config/canigo-core.xml&quot; })
@EnableTransactionManagement
@Import(EquipamentEmbeddedReactiveMongoConfig.class)
public class EmbeddedReactiveMongoAppConfig {
}
</code></pre>

<pre><code class="language-java">import java.io.IOException;
import org.junit.AfterClass;
import org.junit.BeforeClass;
import org.junit.runner.RunWith;
import org.springframework.test.context.ContextConfiguration;
import org.springframework.test.context.junit4.SpringRunner;
import de.flapdoodle.embed.mongo.Command;
import de.flapdoodle.embed.mongo.MongodExecutable;
import de.flapdoodle.embed.mongo.MongodProcess;
import de.flapdoodle.embed.mongo.MongodStarter;
import de.flapdoodle.embed.mongo.config.IMongodConfig;
import de.flapdoodle.embed.mongo.config.MongodConfigBuilder;
import de.flapdoodle.embed.mongo.config.Net;
import de.flapdoodle.embed.mongo.config.RuntimeConfigBuilder;
import de.flapdoodle.embed.mongo.distribution.Version;
import de.flapdoodle.embed.process.config.IRuntimeConfig;
import de.flapdoodle.embed.process.runtime.Network;
import cat.gencat.ctti.mongodb.model.repository.EquipamentMongoRepository;

/**
 * Test cases for the {@link EquipamentMongoRepository}.
 */
@RunWith(SpringJUnit4ClassRunner.class)
@ContextConfiguration(classes = { EmbeddedReactiveMongoAppConfig.class})
public class EquipamentEmbeddedReactiveMongoRepositoryTest extends EquipamentReactiveMongoRepositoryCoreTest {
}
</code></pre>

<h2 id="logs">Logs</h2>

<p>Si es requereix el pintat de les consultes realitzades pel mòdul a la base de dades MongoDB, es pot afegir
un &ldquo;logger&rdquo; per a la categoria <strong>org.springframework.data.mongodb.core.MongoTemplate</strong> al fitxer &ldquo;log4j&rdquo; de l&rsquo;aplicació.</p>

<p>Per exemple:</p>

<pre><code class="language-xml">      &lt;Logger name=&quot;org.springframework.data.mongodb.core.MongoTemplate&quot; level=&quot;debug&quot; additivity=&quot;false&quot;&gt;
         &lt;AppenderRef ref=&quot;DAILY_LOG&quot; /&gt;
      &lt;/Logger&gt;
</code></pre>


					

					
				</div>	

			</article>	


	</section>	

		<div class="fons_footer ">
		<footer class="container center-block shadowBox2">
			<div class="shadow2"></div>
			<div class="row footer_tab_ord">

				<div class="footer_tab_bot col-sm-12">
					<div class="avis_legal">

						<div id="fAvisLegal">
							<div>
								<div class="hidden-xs">
									<a href="https://www.gencat.cat"> <img
										src="/img/logo_generalitat_gris.png_679097835.png"
										width="101" height="27" alt="www.gencat.cat"
										/></a>
									<p>
										<a title="Avis legal" href="https://web.gencat.cat/ca/menu-ajuda/ajuda/avis_legal/" target="_self">Avís legal</a>: La &copy; Generalitat de Catalunya permet la reutilització dels continguts i de les dades sempre que se citi la font i la data d'actualització, que no es desnaturalitzi la informació i que no es contradigui amb una llicència específica.
									</p>
								</div>
								<div class="visible-xs avis_legal">
									<p>
										<a title="Avis legal" href="https://web.gencat.cat/ca/menu-ajuda/ajuda/avis_legal/" target="_self">Avís legal</a>: La &copy; Generalitat de Catalunya permet la reutilització dels continguts i de les dades sempre que se citi la font i la data d'actualització, que no es desnaturalitzi la informació i que no es contradigui amb una llicència específica.
									</p>
								</div>
								
								<div class="fi_peu visible-xs">
									<a title="www.gencat.cat" href="https://www.gencat.cat"> <img
										src="/img/logo_generalitat_gris.png_679097835.png"
										width="101" height="27" 
										alt="www.gencat.cat" /></a> <a class="torna_amunt pull-right"
										href=" javascript:tornarAmunt();" title="Torna amunt">
										<p>Torna amunt</p>
									</a>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</footer>
	</div>

<script src="/js/master.min.js" type="text/javascript"></script>
<script src="https://cdn.jsdelivr.net/algoliasearch/3/algoliasearch.min.js"></script>
<script src="https://cdn.jsdelivr.net/autocomplete.js/0/autocomplete.min.js"></script>
<script src="/js/custom.js" type="text/javascript"></script>



<script type="text/javascript">

if(location.hostname!=="localhost"){

	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

	ga('create', "UA-59408075-1", 'auto');
	ga('send', 'pageview', {
	  	'page': location.pathname + location.search  + location.hash
	  }
	);

}

</script>




</body>
</html>
