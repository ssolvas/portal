<!DOCTYPE html>
<html xml:lang="ca-ES" lang="ca-ES" xmlns="http://www.w3.org/1999/xhtml">
<head>

	<title>Planificador de tasques</title>
		<meta charset="UTF-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<link rel="shortcut icon" type="image/x-icon" href="/img/favicon.ico" />
	<link href="/css/master.min.css" rel="stylesheet" type="text/css" />
	<link href="/css/canigo.css" rel="stylesheet" type="text/css" />
	<script src="/js/jquery.min.js" type="text/javascript"></script>

	<script>
		document.write("<meta name=\"titol\" content=\"Planificador de tasques\" />");
		document.write("<meta name=\"description\" content=\"Planificador de tasques\" />");
	</script>

	

</head>
<body class="single">
	<div class="contenidor unfixed">

				

		<header class="fons_header navbar navbar-default z-index-menu">
			<div class="container" role="menu">
				<div class="row clearfix menuNav">
					<div class="col-md-3 col-xs-3 column visible-xs coloca ">
						<button type="button" onclick="amunt();" title="Menu"
							class="navbar-toggle pull-left" data-toggle="collapse"
							data-target=".navbar-collapse">
							<span class="sr-only">Toggle navigation</span> <span
								class="icon-bar"></span> <span class="icon-bar"></span> <span
								class="icon-bar"></span>
						</button>
					</div>

					<div class="col-md-3 col-xs-6 col-offset-2 column visible-xs titol-mobil">
						
						<span class="white titol-mobil-destacat">canigo.ctti</span><span class="white">.gencat.cat</span>
					</div>

					<div class="col-md-3 col-xs-3 column visible-xs coloca1">
						<button onclick="amunt();" type="button" title="Cerca"
							class="ico_cerca " data-toggle="collapse" data-target=".dos">
						</button>
					</div>

				</div>

				<div class="collapse dos">
					<div class="shadowBox">
						<form class="navbar-form navbar-left primer" action="/cercador/" method="get"
 						onsubmit="location.href=this.action+'?q='+this.cerca_cap.value; return false;">
							<div class="form-group">
								<input type="search" class="form-control" name="q" id="cerca_cap"
									title="Cerca"
									placeholder="Cerca" />
								<button type="button" title="Neteja" class="btn btn-default"></button>
								<input type="submit" class="ocult" name="Cerca" value="Cerca" />
							</div>
						</form>
					</div>
				</div>	

				<nav class="collapse navbar-collapse navbar-ex1-collapse ">
				
					<div class="row">
						<div class="col-md-6 col-sm-4 column">
							<a class="img-responsive logo" title="Generalitat de Catalunya"
								href="https://ctti.gencat.cat/">gencat.cat</a>
							<button class="menu_tancar visible-xs collapsed"
								data-target=".navbar-collapse" data-toggle="collapse"
								title="Tancar"></button>
						</div>

						<div class="col-md-6 col-sm-8 column hidden-xs hidden-mg">
							<form class="navbar-form cercador_vermell hidden-xs pull-right" action="/cercador/"  method="get" onsubmit="location.href=this.action+'?q='+this.cerca2.value; return false;">
								<div class="form-group">
									<label class="hidden" for="cerca2">Cerca</label>
									<input id="cerca2" class="form-control" type="search" 
									placeholder="Cerca" name="q" title="Cerca">
									<input class="btn btn-default" type="submit" title="Cerca" value="">
								</div>
							</form>

							

						</div>

					</div>
					<div class="col-xs-12 hidden-xs" id="nomPortal">
                    	<span class="titol-cap-nou">Centre de Telecomunicacions i Tecnologies de la Informació</span>
                    </div>					
					<ul class="nav navbar-nav">

			        	

						<li>
							<a class="dropdown-toggle" href='/' data-toggle='_dropdown'>Inici</a>
						</li>

						

						<li>
							<a class="dropdown-toggle" href='/arqctti' data-toggle='_dropdown'>Arquitectura CTTI</a>
						</li>

						

						<li>
							<a class="dropdown-toggle" href='/blog' data-toggle='_dropdown'>Blog</a>
						</li>

						

						<li>
							<a class="dropdown-toggle" href='/cloud' data-toggle='_dropdown'>Cloud</a>
						</li>

						

						<li>
							<a class="dropdown-toggle" href='/canigo' data-toggle='_dropdown'>Canigó</a>
						</li>

						

						<li>
							<a class="dropdown-toggle" href='/sic' data-toggle='_dropdown'>SIC</a>
						</li>

						

						<li>
							<a class="dropdown-toggle" href='/sgde' data-toggle='_dropdown'>SGDE</a>
						</li>

						

						<li>
							<a class="dropdown-toggle" href='/gicar' data-toggle='_dropdown'>GICAR</a>
						</li>

						

						<li>
							<a class="dropdown-toggle" href='/cs' data-toggle='_dropdown'>Centres de Suport</a>
						</li>

						

						<li>
							<a class="dropdown-toggle" href='/dadesref' data-toggle='_dropdown'>Gestió Tècnica de Dades</a>
						</li>

						

						<li>
							<a class="dropdown-toggle" href='/eventhub' data-toggle='_dropdown'>EventHub</a>
						</li>

						

					</ul>

				</nav>
			</div>
		</header>



	</div>

	<section class="border-start">

						
			

			<article class="bgGrey">
				<div class="container">
					<div class="row">
						<div class="capcelera_basica col-sm-12">
							<div class="capcelera_basica_cont">
								<ol class="breadcrumb filariana hidden-xs">
									<li>
										<a href="/">Inici</a>
									</li>
									<li class="breadcrumbs2">
									
										<a href="/canigo-fwk-docs">
											




























	
	
	
	
	
	  
	  
	
	  
	  
	  	
	  	
	  	<a href='https://canigo.ctti.gencat.cat/canigo-fwk-docs/'>canigo fwk docs</a>
	  	
	  
	
	  
	  
	  	
	  	
	  		<li>
	  	
	  	<a href='https://canigo.ctti.gencat.cat/canigo-fwk-docs/documentacio-per-versions/'>documentacio per versions</a>
	  	
	  		</li>
	  	
	  
	
	  
	  
	  	
	  	
	  		<li>
	  	
	  	<a href='https://canigo.ctti.gencat.cat/canigo-fwk-docs/documentacio-per-versions/3.4LTS/'>3.4LTS</a>
	  	
	  		</li>
	  	
	  
	
	  
	  
	  	
	  	
	  		<li>
	  	
	  	<a href='https://canigo.ctti.gencat.cat/canigo-fwk-docs/documentacio-per-versions/3.4LTS/3.4.4/'>3.4.4</a>
	  	
	  		</li>
	  	
	  
	
	  
	  
	  	
	  	
	  		<li>
	  	
	  	<a href='https://canigo.ctti.gencat.cat/canigo-fwk-docs/documentacio-per-versions/3.4LTS/3.4.4/moduls/'>moduls</a>
	  	
	  		</li>
	  	
	  
	
	  
	  
	  	
	  	
	  		<li>
	  	
	  	<a href='https://canigo.ctti.gencat.cat/canigo-fwk-docs/documentacio-per-versions/3.4LTS/3.4.4/moduls/moduls-altres/'>moduls altres</a>
	  	
	  		</li>
	  	
	  
	
	  
	  
	  	
	  	
	  		<li>
	  	
	  	<a href='https://canigo.ctti.gencat.cat/canigo-fwk-docs/documentacio-per-versions/3.4LTS/3.4.4/moduls/moduls-altres/modul-planificador/'>modul planificador</a>
	  	
	  		</li>
	  	
	  
	
	  
	  
	


										</a>
										




























































































									
									</li>

								</ol>

								<h1 class="capcelera_flotant pull-left" data-txt=".title">
									

										
											




	Planificador de tasques


										

									
								</h1>

								

								
								

								

								

							</div>
						</div>

					</div>
				</div>
			</article>

			


		   <div class="padding-xs container">
	    	
	    	   <i><b>Darrera actualització:</b></i> 16-06-2020
	        
           </div>
           
			<article class="padding-xs padding-sm padding-md contingut">				
				<div class="container">
 		
					
				

	


					

						

<h2 id="propòsit">Propòsit</h2>

<p>El propòsit d&rsquo;aquest apartat es introduir al desenvolupador a la planificació de tasques mitjançant Quartz.</p>

<p>Quartz permet l&rsquo;execució de tasques de forma diferida:</p>

<ul>
<li>en qualsevol moment del dia (precisió de milisegons)</li>
<li>en alguns dies de la setmana</li>
<li>en alguns dies del mes</li>
<li>en alguns dies de l&rsquo;any</li>
<li>un número específic de repeticions</li>
<li>repetidament fins a una data/instant determinat</li>
<li>repetida e indefinidament</li>
<li>repetidament en un determinat interval de temps</li>
</ul>

<p>Documents i Fonts de Referència</p>

<table>
<thead>
<tr>
<th>Referència</th>
<th>URL</th>
</tr>
</thead>

<tbody>
<tr>
<td>Quartz</td>
<td><a href="http://www.quartz-scheduler.org/">http://www.quartz-scheduler.org/</a></td>
</tr>

<tr>
<td>Spring 4 + Quartz</td>
<td><a href="http://static.springsource.org/spring/docs/4.1.0.RELEASE/spring-framework-reference/html/scheduling.html#scheduling-quartz">http://static.springsource.org/spring/docs/4.1.0.RELEASE/spring-framework-reference/html/scheduling.html#scheduling-quartz</a></td>
</tr>

<tr>
<td>Guia migració Quartz 1.8.x a 2.0</td>
<td><a href="http://www.quartz-scheduler.org/documentation/quartz-2.x/migration-guide">http://www.quartz-scheduler.org/documentation/quartz-2.x/migration-guide</a></td>
</tr>
</tbody>
</table>

<h2 id="glossari">Glossari</h2>

<p><strong>Job</strong></p>

<p>Un Job o tasca és simplement la referència a la classe que conté el mètode que volem executar de forma diferida.</p>

<p><strong>Trigger</strong></p>

<p>Un objecte de tipus Trigger s&rsquo;utilitza per llençar l&rsquo;execució dels Jobs o tasques. Quan es vol programar una tasca, s&rsquo;intancia un Trigger i configures les seves propietats per tal de proporcionar la programació d&rsquo;execució (interval d&rsquo;execució, número de repeticions, timeout, etc..).</p>

<p><strong>SchedulerFactory</strong></p>

<p>Objecte que s&rsquo;encarrega d&rsquo;instanciar el programador o scheduler que s&rsquo;encarregarà de gestionar l&rsquo;execució de les tasques.</p>

<h2 id="instal-lació-i-configuració">Instal.lació i Configuració</h2>

<h3 id="instal-lació">Instal.lació</h3>

<p>Per tal d&rsquo;instal-lar Quartz es necessari afegir manualment en el pom.xml de l&rsquo;aplicació la següent dependència:</p>

<pre><code>&lt;org.opensymphony.quartz.version&gt;2.2.1&lt;/org.opensymphony.quartz.version&gt;
&lt;commons.collections.version&gt;4.0&lt;/commons.collections.version&gt;
&lt;org.springframework.versionn&gt;4.1.0.RELEASE&lt;/org.springframework.version&gt;

&lt;dependency&gt;
    &lt;groupId&gt;org.quartz-scheduler&lt;/groupId&gt;
    &lt;artifactId&gt;quartz&lt;/artifactId&gt;
    &lt;version&gt;${org.opensymphony.quartz.version}&lt;/version&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.springframework&lt;/groupId&gt;
    &lt;artifactId&gt;spring-context-support&lt;/artifactId&gt;
    &lt;version&gt;${org.springframework.version}&lt;/version&gt;
&lt;/dependency&gt;&lt;!-- Només per clustering Oracle --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.quartz-scheduler&lt;/groupId&gt;
    &lt;artifactId&gt;quartz-oracle&lt;/artifactId&gt;
    &lt;version&gt;${org.opensymphony.quartz.version}&lt;/version&gt;
&lt;/dependency&gt;
&lt;!-- Només per a Weblogic --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.quartz-scheduler&lt;/groupId&gt;
    &lt;artifactId&gt;quartz-weblogic&lt;/artifactId&gt;
    &lt;version&gt;${org.opensymphony.quartz.version}&lt;/version&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.apache.commons&lt;/groupId&gt;
    &lt;artifactId&gt;commons-collections4&lt;/artifactId&gt;
    &lt;version&gt;${commons.collections.version}&lt;/version&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
      &lt;groupId&gt;org.springframework&lt;/groupId&gt;
      &lt;artifactId&gt;spring-tx&lt;/artifactId&gt;
      &lt;version&gt;${org.springframework.version}&lt;/version&gt;
&lt;/dependency&gt;
</code></pre>

<h3 id="configuració">Configuració</h3>

<p>La configuració del servei de planificació de tasques es pot dividir en dos punts:</p>

<ul>
<li>Definició dels xmls (o anotacions) de Spring que s&rsquo;encarregen de la inicialització dels beans de Quartz.</li>
<li>Externalització de les propietats d&rsquo;aquest beans.
<br /></li>
</ul>

<div class="message information">
IMPORTANT: <br>
Per a entorns clusteritzats revisar l'apartat de Preguntes freqüents.
</div>

<h4 id="definició-dels-xmls-de-spring">Definició dels xmls de Spring</h4>

<p>Ubicació: <PROJECT_ROOT>/src/main/resources/spring/quartz-config.xml</p>

<p>La configuració del planificador de tasques Quartz implica 3 pasos:</p>

<ul>
<li>Definir les tasques que volem executar de forma diferida</li>
<li>Definir els triggers que defineixen en quin moment s&rsquo;executaran les tasques</li>
<li>Definir la factoria per executar les tasques amb els triggers</li>
</ul>

<h4 id="configuració-dels-arxius-de-propietats">Configuració dels arxius de propietats</h4>

<p>Ubicació: <PROJECT_ROOT>/src/main/resources/config/props/planificador.properties</p>

<p>Dins d&rsquo;aquest arxiu romandrien les propietats dels Jobs, Triggers, Scheduler, etc.</p>

<p>Exemple d&rsquo;arxiu de propietats:</p>

<pre><code>*.quartz.repeatInterval=2000
*.quartz.autoStartup=false
*.quartz.concurrent=true
</code></pre>

<h2 id="utilització-del-mòdul">Utilització del Mòdul</h2>

<p>En aquest exemple es configura una tasca que es repeteix cada dos segons amb el work manager per defecte de Quartz.</p>

<p><strong>quartz-config.xml</strong></p>

<pre><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;
    xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
    xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-4.1.xsd&quot;&gt;

    &lt;bean id=&quot;salutacio&quot; class=&quot;springapp.web.vo.Salutacio&quot;/&gt;

        &lt;bean id=&quot;unaTasca&quot;
             class=&quot;org.springframework.scheduling.quartz.MethodInvokingJobDetailFactoryBean&quot;&gt;
        &lt;property name=&quot;targetObject&quot;   ref=&quot;salutacio&quot; /&gt;
        &lt;property name=&quot;targetMethod&quot;   value=&quot;saludar&quot; /&gt;
        &lt;property name=&quot;concurrent&quot;     value=&quot;${quartz.concurrent}&quot; /&gt;
    &lt;/bean&gt;

    &lt;bean id=&quot;simpleTrigger&quot; class=&quot;org.springframework.scheduling.quartz.SimpleTriggerBean&quot;&gt;
        &lt;property name=&quot;jobDetail&quot; ref=&quot;unaTasca&quot; /&gt;
        &lt;property name=&quot;repeatInterval&quot; value=&quot;${quartz.repeatInterval}&quot; /&gt;
    &lt;/bean&gt;

    &lt;bean id=&quot;schedulerFactoryBean&quot;
             class=&quot;org.springframework.scheduling.quartz.SchedulerFactoryBean&quot;&gt;
        &lt;property name=&quot;autoStartup&quot; value=&quot;${quartz.autoStartup}&quot; /&gt;
        &lt;property name=&quot;triggers&quot;&gt;
            &lt;list&gt;
                &lt;ref bean=&quot;simpleTrigger&quot; /&gt;
            &lt;/list&gt;
        &lt;/property&gt;
    &lt;/bean&gt;

&lt;/beans&gt;
</code></pre>

<div class="message warning">
Workmanager per defecte

Per defecte de Quartz gestiona l'execució de les tasques amb el seu pròpi workmanager. Aquest motor per defecte s'encarrega de gestionar els diferents "threads" o fils d'execució de les tasques planificades de manera autònoma sense que el servidor d'aplicacions tingui constància d'aquests "threads" oberts.
En entorns productius s'ha pogut observar com en algunes situacions el motor no allibera correctament aquests "threads" de la VM, lo que pot provocar la degradació del sistema o en el pitjor dels casos, la seva indisponibilitat.

Per evitar aquest tipus de situacions es recomenable que llegiu l'apartat de Recomanacions.
</div>

<h2 id="recomanacions">Recomanacions</h2>

<p>Com a alternativa al workmanager per defecte de &ldquo;Quartz&rdquo;, i amb la idea de que sigui el servidor d&rsquo;aplicacions qui gestioni els threads de Quartz, a continuació es descriu un exemple de configuració per a utilitzar la implementació de &ldquo;Commonj&rdquo;.</p>

<h3 id="configuració-per-a-servidors-d-aplicacions-weblogic">Configuració per a servidors d&rsquo;aplicacions Weblogic</h3>

<p>Per canviar el WorkManager per defecte per el de &ldquo;Commonj&rdquo; a servidors d&rsquo;aplicacions Weblogic, es necessari realitzar les següents accions:</p>

<ul>
<li>Modificar el taskexecutor del SchedulerFactoryBean.</li>
<li>Modificar web.xml per afegir una referència local al &ldquo;WorkManager&rdquo;.</li>
<li>Modificar weblogic.xml per crear un &ldquo;WorkManager&rdquo;.</li>
</ul>

<h3 id="modificar-el-taskexecutor-del-schedulerfactorybean">Modificar el taskexecutor del SchedulerFactoryBean</h3>

<p>Per sobrescriure el &ldquo;taskexecutor&rdquo; per defecte de &ldquo;Quartz&rdquo;, s&rsquo;ha de modificar el SchedulerFactoryBean per instanciar el nou &ldquo;TaskExecutor&rdquo;, aquest informarà les següents propietats:</p>

<ul>
<li>workManagerName: Nom JNDI del WorkManager JCA.</li>
<li>resourceRef: Indica si la cerca del nom JNDI es realitza en un contenidor J2EE.</li>
</ul>

<pre><code>&lt;!-- Planificador amb l'engine de commonj --&gt;
&lt;bean id=&quot;schedulerFactoryBeanCommonj&quot;
      class=&quot;org.springframework.scheduling.quartz.SchedulerFactoryBean&quot;&gt;
    &lt;property name=&quot;autoStartup&quot; value=&quot;false&quot; /&gt;
    &lt;property name=&quot;triggers&quot;&gt;
        &lt;list&gt;
            &lt;ref bean=&quot;simpleTrigger&quot; /&gt;
        &lt;/list&gt;
    &lt;/property&gt;
    &lt;property name=&quot;taskExecutor&quot; ref=&quot;taskExecutor&quot;/&gt;
&lt;/bean&gt;
&lt;bean id=&quot;taskExecutor&quot;
      class=&quot;org.springframework.scheduling.commonj.WorkManagerTaskExecutor&quot;&gt;
    &lt;property name=&quot;workManagerName&quot; value=&quot;appWorkManager&quot; /&gt;
    &lt;property name=&quot;resourceRef&quot; value=&quot;true&quot; /&gt;
&lt;/bean&gt;
</code></pre>

<h3 id="modificar-web-xml-per-afegir-una-referència-local-al-workmanager">Modificar web.xml per afegir una referència local al &ldquo;WorkManager&rdquo;</h3>

<p>Modificar l&rsquo;arxiu &ldquo;web.xml&rdquo; per afegir una referència local al &ldquo;WorkManager&rdquo; que posteriorment es definirà al &ldquo;weblogic.xml&rdquo;:</p>

<pre><code>...
&lt;resource-ref&gt;
    &lt;res-ref-name&gt;appWorkManager&lt;/res-ref-name&gt;
    &lt;res-type&gt;commonj.work.WorkManager&lt;/res-type&gt;
    &lt;res-auth&gt;Container&lt;/res-auth&gt;
    &lt;res-sharing-scope&gt;Shareable&lt;/res-sharing-scope&gt;
&lt;/resource-ref&gt;
...
</code></pre>

<h3 id="modificar-weblogic-xml-per-crear-un-workmanager">Modificar weblogic.xml per crear un &ldquo;WorkManager&rdquo;</h3>

<p>Finalment cal registrar un &ldquo;WorkManager&rdquo; aplicatiu al servidor d&rsquo;aplicacions mitjançant l&rsquo;arxiu &ldquo;weblogic.xml&rdquo;. En l&rsquo;exemple es registra un &ldquo;WorkManager&rdquo; que com a màxim pot executar 3 &ldquo;threads&rdquo; concurrents.</p>

<pre><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;weblogic-web-app xmlns=&quot;http://www.bea.com/ns/weblogic/90&quot;
    xmlns:j2ee=&quot;http://java.sun.com/xml/ns/j2ee&quot;
    xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
    xsi:schemaLocation=&quot;http://www.bea.com/ns/weblogic/90
                           http://www.bea.com/ns/weblogic/90/weblogic-web-app.xsd&quot;&gt;

    &lt;work-manager&gt;
        &lt;name&gt;appWorkManager&lt;/name&gt;
        &lt;max-threads-constraint&gt;
            &lt;name&gt;appWorkManager&lt;/name&gt;
            &lt;count&gt;3&lt;/count&gt;
        &lt;/max-threads-constraint&gt;
    &lt;/work-manager&gt;
&lt;/weblogic-web-app&gt;
</code></pre>

<h3 id="configuració-per-a-servidors-d-aplicacions-tomcat">Configuració per a servidors d&rsquo;aplicacions Tomcat</h3>

<p>Per canviar el WorkManager per defecte per el de &ldquo;Commonj&rdquo; per a servidors d&rsquo;aplicacions Tomcat es necessari realitzar les següents accions:</p>

<ul>
<li>Afegir les llibreries de Commonj.</li>
<li>Modificar el taskexecutor del SchedulerFactoryBean.</li>
<li>Modificar web.xml per afegir una referència local al &ldquo;WorkManager&rdquo;.</li>
<li>Crear el &ldquo;WorkManager&rdquo; al context.xml de Tomcat.</li>
</ul>

<h3 id="afegir-les-llibreries-de-commonj">Afegir les llibreries de Commonj</h3>

<p>Cal verificar que les llibreries de Commonj estiguin incloses dins la carpeta de llibreries compartides de Tomcat o bé dins l&rsquo;aplicació que les farà servir:</p>

<ul>
<li>Si es volen afegir directament com a llibreries compartides de Tomcat, cal afegir a $TOMCAT_HOME/lib les llibreries commonj-twm.jar i foo-commonj-1.1.0.jar . Aquestes es poden trobar dins la carpeta \foo-commonj-1.1.0\lib del zip que es pot descarregar de la web oficial</li>
<li>Si es volen afegir al projecte Canigó3, cal afegir les següents dependències Maven al pom.xml:</li>
</ul>

<pre><code>&lt;dependency&gt;
    &lt;groupId&gt;com.bea.wlplatform&lt;/groupId&gt;
    &lt;artifactId&gt;commonj-twm&lt;/artifactId&gt;
    &lt;version&gt;1.1&lt;/version&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;com.bea.wlplatform&lt;/groupId&gt;
    &lt;artifactId&gt;foo-commonj&lt;/artifactId&gt;
    &lt;version&gt;1.1.0&lt;/version&gt;
&lt;/dependency&gt;
</code></pre>

<h3 id="modificar-el-taskexecutor-del-schedulerfactorybean-1">Modificar el taskexecutor del SchedulerFactoryBean</h3>

<p>Per sobrescriure el &ldquo;taskexecutor&rdquo; per defecte de &ldquo;Quartz&rdquo;, s&rsquo;ha de modificar el SchedulerFactoryBean per instanciar el nou &ldquo;TaskExecutor&rdquo;, aquest informarà les següents propietats:</p>

<ul>
<li>workManagerName: Nom JNDI del WorkManager JCA.</li>
<li>resourceRef: Indica si la cerca del nom JNDI es realitza en un contenidor J2EE.</li>
</ul>

<pre><code>&lt;!-- Planificador amb l'engine de commonj --&gt;
&lt;bean id=&quot;schedulerFactoryBeanCommonj&quot;
      class=&quot;org.springframework.scheduling.quartz.SchedulerFactoryBean&quot;&gt;
    &lt;property name=&quot;autoStartup&quot; value=&quot;false&quot; /&gt;
    &lt;property name=&quot;triggers&quot;&gt;
        &lt;list&gt;
            &lt;ref bean=&quot;simpleTrigger&quot; /&gt;
        &lt;/list&gt;
    &lt;/property&gt;
    &lt;property name=&quot;taskExecutor&quot; ref=&quot;taskExecutor&quot;/&gt;
&lt;/bean&gt;
&lt;bean id=&quot;taskExecutor&quot;
      class=&quot;org.springframework.scheduling.commonj.WorkManagerTaskExecutor&quot;&gt;
    &lt;property name=&quot;workManagerName&quot; value=&quot;wm/appWorkManager&quot; /&gt;
    &lt;property name=&quot;resourceRef&quot; value=&quot;true&quot; /&gt;
&lt;/bean&gt;
</code></pre>

<h3 id="modificar-web-xml-per-afegir-una-referència-local-al-workmanager-1">Modificar web.xml per afegir una referència local al &ldquo;WorkManager&rdquo;</h3>

<p>Modificar l&rsquo;arxiu &ldquo;web.xml&rdquo; per afegir una referència local al &ldquo;WorkManager&rdquo; que posteriorment es definirà al &ldquo;weblogic.xml&rdquo;:</p>

<pre><code>...
&lt;resource-ref&gt;
    &lt;res-ref-name&gt;wm/appWorkManager&lt;/res-ref-name&gt;
    &lt;res-type&gt;commonj.work.WorkManager&lt;/res-type&gt;
    &lt;res-auth&gt;Container&lt;/res-auth&gt;
    &lt;res-sharing-scope&gt;Shareable&lt;/res-sharing-scope&gt;
&lt;/resource-ref&gt;
...
</code></pre>

<h3 id="crear-el-workmanager-al-context-xml-de-tomcat">Crear el &ldquo;WorkManager&rdquo; al context.xml de Tomcat</h3>

<p>Finalment cal registrar un &ldquo;WorkManager&rdquo; aplicatiu al servidor d&rsquo;aplicacions. En aquest cas caldría afegir-ho al fitxer $TOMCAT_HOME/conf/context.xml. En l&rsquo;exemple es registra un &ldquo;WorkManager&rdquo; que com a màxim pot executar 3 &ldquo;threads&rdquo; concurrents.</p>

<pre><code>...
&lt;Resource name=&quot;wm/appWorkManager&quot;
    auth=&quot;Container&quot;
    factory=&quot;de.myfoo.commonj.work.FooWorkManagerFactory&quot; 
    type=&quot;commonj.work.WorkManager&quot;
    maxThreads=&quot;3&quot;/&gt;
...
</code></pre>

<p>Alguns dels paràmetres de configuració i tunning del &ldquo;WorkManager&rdquo; es poden trobar a la següent adreça:
<a href="http://download.oracle.com/docs/cd/E11035_01/wls100/config_wls/self_tuned.html">http://download.oracle.com/docs/cd/E11035_01/wls100/config_wls/self_tuned.html</a></p>

<h2 id="preguntes-freqüents">Preguntes freqüents</h2>

<h3 id="utilització-de-quartz-en-un-cluster">Utilització de Quartz en un cluster</h3>

<p>La principal problemàtica del planificador de tasques en un cluster és l&rsquo;execució del planificador en cadascuna de les màquines de forma independent. Si l&rsquo;aplicació es troba en un cluster i no es gestiona aquesta problemàtica, la tasca s&rsquo;executarà tants cops com nodes al cluster tinguessim.</p>

<p>Per solventar aquest problema, Quartz proporciona una solució basada en una base de dades centralitzada que funciona com a semàfor d&rsquo;execució dels diferents Jobs.</p>

<h3 id="configuració-1">Configuració</h3>

<p>La configuració consta de dos passos:</p>

<ol>
<li>Crear les taules a partir dels scripts proporcionats per Quartz. Els pots trobar al directori: quartz\docs\dbTables directory.</li>
<li>Crear el arxiu de propietats quartz.properties a l&rsquo;arrel de l&rsquo;aplicació. src/main/resources/quartz.properties</li>
</ol>

<pre><code>#============================================================================
# Configure Main Scheduler Properties
#============================================================================
org.quartz.scheduler.instanceName = MyClusteredScheduler
org.quartz.scheduler.instanceId = AUTO
#============================================================================
# Configure ThreadPool
#============================================================================
org.quartz.threadPool.class = org.quartz.simpl.SimpleThreadPool
org.quartz.threadPool.threadCount = 25
org.quartz.threadPool.threadPriority = 5
#============================================================================
# Configure JobStore
#============================================================================
org.quartz.jobStore.misfireThreshold = 60000
org.quartz.jobStore.class = org.quartz.impl.jdbcjobstore.JobStoreTX
org.quartz.jobStore.driverDelegateClass = org.quartz.impl.jdbcjobstore.oracle.OracleDelegate
org.quartz.jobStore.useProperties = false
org.quartz.jobStore.dataSource = myDS
org.quartz.jobStore.tablePrefix = QRTZ_

org.quartz.jobStore.isClustered = true
org.quartz.jobStore.clusterCheckinInterval = 20000
#============================================================================
# Configure Datasources
#============================================================================
#org.quartz.dataSource.myDS.driver = oracle.jdbc.driver.OracleDriver
#org.quartz.dataSource.myDS.URL = jdbc:oracle:thin:@localhost:1521:orcl
#org.quartz.dataSource.myDS.user = scott
#org.quartz.dataSource.myDS.password = tiger
#org.quartz.dataSource.myDS.maxConnections = 5
#org.quartz.dataSource.myDS.validationQuery=select 0 from dual
#============================================================================
# Configure Datasources JNDI
#============================================================================
org.quartz.dataSource.myDS.jndiURL=jdbc/myDataSource
org.quartz.dataSource.myDS.java.naming.factory.initial=com.evermind.server.rmi.RMIInitialContextFactory
org.quartz.dataSource.myDS.java.naming.provider.url=ormi://localhost
org.quartz.dataSource.myDS.java.naming.security.principal=admin
org.quartz.dataSource.myDS.java.naming.security.credentials=123
</code></pre>

<p>Més informació a:</p>

<p><a href="http://www.quartz-scheduler.org/documentation/quartz-2.x/configuration/ConfigJDBCJobStoreClustering">http://www.quartz-scheduler.org/documentation/quartz-2.x/configuration/ConfigJDBCJobStoreClustering</a></p>


					

					
				</div>	

			</article>	


	</section>	

		<div class="fons_footer ">
		<footer class="container center-block shadowBox2">
			<div class="shadow2"></div>
			<div class="row footer_tab_ord">

				<div class="footer_tab_bot col-sm-12">
					<div class="avis_legal">

						<div id="fAvisLegal">
							<div>
								<div class="hidden-xs">
									<a href="https://www.gencat.cat"> <img
										src="/img/logo_generalitat_gris.png_679097835.png"
										width="101" height="27" alt="www.gencat.cat"
										/></a>
									<p>
										<a title="Avis legal" href="https://web.gencat.cat/ca/menu-ajuda/ajuda/avis_legal/" target="_self">Avís legal</a>: La &copy; Generalitat de Catalunya permet la reutilització dels continguts i de les dades sempre que se citi la font i la data d'actualització, que no es desnaturalitzi la informació i que no es contradigui amb una llicència específica.
									</p>
								</div>
								<div class="visible-xs avis_legal">
									<p>
										<a title="Avis legal" href="https://web.gencat.cat/ca/menu-ajuda/ajuda/avis_legal/" target="_self">Avís legal</a>: La &copy; Generalitat de Catalunya permet la reutilització dels continguts i de les dades sempre que se citi la font i la data d'actualització, que no es desnaturalitzi la informació i que no es contradigui amb una llicència específica.
									</p>
								</div>
								
								<div class="fi_peu visible-xs">
									<a title="www.gencat.cat" href="https://www.gencat.cat"> <img
										src="/img/logo_generalitat_gris.png_679097835.png"
										width="101" height="27" 
										alt="www.gencat.cat" /></a> <a class="torna_amunt pull-right"
										href=" javascript:tornarAmunt();" title="Torna amunt">
										<p>Torna amunt</p>
									</a>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</footer>
	</div>

<script src="/js/master.min.js" type="text/javascript"></script>
<script src="https://cdn.jsdelivr.net/algoliasearch/3/algoliasearch.min.js"></script>
<script src="https://cdn.jsdelivr.net/autocomplete.js/0/autocomplete.min.js"></script>
<script src="/js/custom.js" type="text/javascript"></script>



<script type="text/javascript">

if(location.hostname!=="localhost"){

	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

	ga('create', "UA-59408075-1", 'auto');
	ga('send', 'pageview', {
	  	'page': location.pathname + location.search  + location.hash
	  }
	);

}

</script>




</body>
</html>
